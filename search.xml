<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[FragmentManager is already executing transactions å¼‚å¸¸åˆ†æ]]></title>
    <url>%2Fposts%2F7b4d3187.html</url>
    <content type="text"><![CDATA[ä»Šå¤©æ˜¯ 2019å¹´09æœˆ13æ—¥ï¼Œå†œå†å…«æœˆåäº”ã€‚æ²¡é”™ä»Šå¤©æ˜¯ä¸­ç§‹èŠ‚ï¼Œè€Œä¸”å¯¹æˆ‘æ¥è¯´ï¼Œä»Šå¹´çš„ä¸­ç§‹ä¸ä¸€æ ·ğŸ–•ã€‚ æ•…äº‹æ˜¯è¿™æ ·çš„ â€”â€” ä¸­ç§‹å‰ä¸€å¤©çš„æ™šä¸Šçº¿ä¸Šå‘ç°äº†é—®é¢˜ï¼Œåœ¨å®¶æ”¹bugåˆ°ååŠå¤œã€‚ä¸­ç§‹å½“å¤©ä¸Šåˆæ—©ä¸Šåˆæ¥åˆ°çº¿ä¸Šçš„é—®é¢˜åé¦ˆï¼Œäºæ˜¯åœ¨å®¶ä¸å…¶ä»–å‡ ä¸ªå°ä¼™ä¼´ä¸€èµ·è¿çº¿æ’æŸ¥è§£å†³ã€‚ç»è¿‡ä¸€ä¸Šåˆçš„åŠªåŠ›ï¼Œä¿®æ”¹äº†å‡ ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜æ²¡æœ‰æŸ¥åˆ°åŸå› å’Œè§£å†³åŠæ³•ï¼Œäºæ˜¯å†³å®šä¸‹åˆå»å…¬å¸è§£å†³ï¼Œè¿˜å¥½ä¸‹åˆç‹ é¡ºåˆ©çš„å°†é—®é¢˜å¤ç°äº†ï¼Œå¹¶æ‰¾åˆ°äº†åŸå› å’Œè§£å†³åŠæ³•ã€‚å½“æŠŠé—®é¢˜éƒ½å›å½’éªŒè¯åï¼Œå·²ç»æ˜¯å¿«æ™šä¸Š7ç‚¹é’Ÿäº†ã€‚å›åˆ°å®¶ä¸åˆ° 8 ç‚¹ï¼Œåƒäº†ä¸€å¤§ç¢—å¤§å®¶ä¸‹åˆåŒ…çš„ç»™æˆ‘ä¸€ä¸ªäººç•™å¾—é¥ºå­â€¦â€¦ æ‰¯è›‹å®Œæ¯•ï¼Œç°åœ¨å›åˆ°æ­£é¢˜ã€‚ éœ€æ±‚ç”¨æˆ·æŒ‰è¿”å›é”®å³å°†é€€å‡ºå½“å‰é¡µé¢å‰ï¼Œéœ€è¦ç«‹å³è¯·æ±‚æ¥å£åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºä¸€ä¸ª Dialogï¼Œå¦‚æœå±•ç¤º Dialog åˆ™ä¸é€€å‡ºé¡µé¢ï¼Œå¦åˆ™å†é€€å‡ºé¡µé¢ã€‚ æ¨¡æ‹Ÿä»£ç 1234567891011121314151617181920212223class MainActivity : AppCompatActivity() &#123; override fun onBackPressed() &#123; sendRequest().observe(this@MainActivity, Observer &#123; if (it == true) &#123; Toast.makeText(this@MainActivity, "å¼¹å‡ºDialog", Toast.LENGTH_SHORT).show() &#125; else &#123; super.onBackPressed() &#125; &#125;) &#125; private fun sendRequest(): LiveData&lt;Boolean&gt; &#123; val result = MutableLiveData&lt;Boolean&gt;() // è¿™é‡Œå‡è®¾è¯·æ±‚ç”¨æ—¶ 500 msã€‚ Handler().postDelayed(&#123; result.postValue(false) &#125;, 500L) return result &#125;&#125; é—®é¢˜æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚å‡ ç™¾æ¯«ç§’å†…å°±å¯ä»¥å®Œæˆï¼Œä½†æ˜¯å¦‚æœåœ¨å¼±ç½‘ç¯å¢ƒä¸‹ï¼Œå½“ç”¨æˆ·ç‚¹å‡»è¿”å›é”®åï¼Œç”±äºé•¿æ—¶é—´æ²¡æœ‰ååº”ï¼Œæ­¤æ—¶å¯èƒ½ç”¨æˆ·ç€æ€¥äº†ï¼Œäºæ˜¯æŒ‰ä¸‹ Home é”®ï¼Œåº”ç”¨è¿›å…¥åå°ã€‚ä¸€æ®µæ—¶é—´åç½‘ç»œè¯·æ±‚æˆåŠŸï¼ˆè¿”å›ç»“æœä¸ºä¸æ˜¾ç¤º Dialogï¼‰æˆ–è¯·æ±‚è¶…æ—¶ï¼Œç”¨æˆ·å†æ¬¡è¿”å›åº”ç”¨æ—¶ï¼Œæ­¤æ—¶å‘ç”Ÿå¦‚ä¸‹å¼‚å¸¸ï¼š Android 8.0ï¼ˆä¸åŒ…å«8.0ï¼‰ ä»¥ä¸‹ ANRã€‚ Android 8.0+ æŠ¥ä»¥ä¸‹é”™è¯¯ï¼Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051522019-09-13 21:39:05.780 2106-2106/com.xiaomai E/AndroidRuntime: FATAL EXCEPTION: main Process: com.xiaomai, PID: 2106 java.lang.RuntimeException: Unable to resume activity &#123;com.xiaomai/com.xiaomai.MainActivity&#125;: java.lang.IllegalStateException: FragmentManager is already executing transactions at android.app.ActivityThread.performResumeActivity(ActivityThread.java:3645) at android.app.ActivityThread.handleResumeActivity(ActivityThread.java:3685) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1643) at android.os.Handler.dispatchMessage(Handler.java:105) at android.os.Looper.loop(Looper.java:164) at android.app.ActivityThread.main(ActivityThread.java:6541) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:240) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:767) Caused by: java.lang.IllegalStateException: FragmentManager is already executing transactions at android.app.FragmentManagerImpl.ensureExecReady(FragmentManager.java:1987) at android.app.FragmentManagerImpl.execPendingActions(FragmentManager.java:2043) at android.app.FragmentManagerImpl.popBackStackImmediate(FragmentManager.java:850) at android.app.FragmentManagerImpl.popBackStackImmediate(FragmentManager.java:811) at android.app.Activity.onBackPressed(Activity.java:2993) at androidx.fragment.app.FragmentActivity.onBackPressed(FragmentActivity.java:191) at com.xiaomai.MainActivity.access$onBackPressed$s1136912392(MainActivity.kt:14) at com.xiaomai.MainActivity$onBackPressed$1.onChanged(MainActivity.kt:28) at com.xiaomai.MainActivity$onBackPressed$1.onChanged(MainActivity.kt:14) at androidx.lifecycle.LiveData.considerNotify(LiveData.java:131) at androidx.lifecycle.LiveData.dispatchingValue(LiveData.java:144) at androidx.lifecycle.LiveData$ObserverWrapper.activeStateChanged(LiveData.java:442) at androidx.lifecycle.LiveData$LifecycleBoundObserver.onStateChanged(LiveData.java:394) at androidx.lifecycle.LifecycleRegistry$ObserverWithState.dispatchEvent(LifecycleRegistry.java:361) at androidx.lifecycle.LifecycleRegistry.forwardPass(LifecycleRegistry.java:300) at androidx.lifecycle.LifecycleRegistry.sync(LifecycleRegistry.java:339) at androidx.lifecycle.LifecycleRegistry.moveToState(LifecycleRegistry.java:145) at androidx.lifecycle.LifecycleRegistry.handleLifecycleEvent(LifecycleRegistry.java:131) at androidx.lifecycle.ReportFragment.dispatch(ReportFragment.java:123) at androidx.lifecycle.ReportFragment.onStart(ReportFragment.java:83) at android.app.Fragment.performStart(Fragment.java:2637) at android.app.FragmentManagerImpl.moveToState(FragmentManager.java:1312) at android.app.FragmentManagerImpl.moveFragmentToExpectedState(FragmentManager.java:1549) at android.app.FragmentManagerImpl.moveToState(FragmentManager.java:1611) at android.app.FragmentManagerImpl.dispatchMoveToState(FragmentManager.java:3039) at android.app.FragmentManagerImpl.dispatchStart(FragmentManager.java:2996) at android.app.FragmentController.dispatchStart(FragmentController.java:189) at android.app.Activity.performStart(Activity.java:6998) at android.app.Activity.performRestart(Activity.java:7066) at android.app.Activity.performResume(Activity.java:7071) at android.app.ActivityThread.performResumeActivity(ActivityThread.java:3620) at android.app.ActivityThread.handleResumeActivity(ActivityThread.java:3685) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1643) at android.os.Handler.dispatchMessage(Handler.java:105) at android.os.Looper.loop(Looper.java:164) at android.app.ActivityThread.main(ActivityThread.java:6541) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:240) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:767) é—®é¢˜é‡ç°ä¸ºäº†æ¨¡æ‹Ÿå¼±ç½‘ç¯å¢ƒï¼Œæ–¹ä¾¿é—®é¢˜é‡ç°ï¼Œè¿™é‡ŒæŠŠè¯·æ±‚æ—¶é—´æ”¹ä¸º 3sã€‚ 123Handler().postDelayed(&#123; result.postValue(false)&#125;, 3000L) å½“æŒ‰ä¸‹è¿”å›é”®åï¼Œç«‹å³æŒ‰ Home é”®ï¼Œç­‰å¾… 3 ç§’åå†æ¬¡å›åˆ°åº”ç”¨ï¼Œé—®é¢˜é‡ç°ã€‚ åŸå› æ’æŸ¥ä»å †æ ˆçš„å¼‚å¸¸æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼šå¼‚å¸¸å‘ç”Ÿçš„åŸå› ä¸ Fragment æœ‰å…³ï¼Œå¹¶ä¸”å¯¹ Fragment è¿›è¡Œäº†ä¸æ­£å½“çš„æ“ä½œã€‚ çœ‹ä¸€ä¸‹ä»£ç ä¸­å“ªä¸ªåœ°æ–¹ç”¨åˆ°äº† Fragment å‘¢ï¼Ÿä»”ç»†ä¸€è¡Œè¡Œçš„çœ‹è¿‡ä»£ç åï¼Œå‘ç°æ²¡æœ‰åœ°æ–¹ä½¿ç”¨ Fragmentï¼ï¼ï¼ WHAT????? è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä»£ç ä¸­æ²¡æœ‰ä»»ä½•åœ°æ–¹ä½¿ç”¨ Fragmentï¼Œé”™è¯¯å †æ ˆä¸­å´æŠ¥äº†ä¸ Fragment æœ‰å…³çš„ä¿¡æ¯ï¼Œå†ä»”ç»†çœ‹ä¸€ä¸‹å †æ ˆçš„å¼‚å¸¸æ—¥å¿—ï¼Œå‘ç°æœ‰ä¸€ä¸ªå« ReportFragment çš„ç±»ã€‚ åŸæ¥ï¼ŒReportFragment æ˜¯ Android ä¸ºäº†å®ç° Lifecycles ç›¸å…³åŠŸèƒ½è€Œè‡ªåŠ¨æ·»åŠ çš„ã€‚ æ¥ä¸‹æ¥ï¼Œè°ƒè¯•ä¸€ä¸‹å½“åº”ç”¨ä»åå°è¿”å›æ—¶éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ 1234567handleResumeActivity:3685, ActivityThread (android.app)performResumeActivity:3620, ActivityThread (android.app)performResume:7071, Activity (android.app)performRestart:7066, Activity (android.app)performStart:6991, Activity (android.app)execPendingActions:402, FragmentController (android.app)execPendingActions:2043, FragmentManagerImpl (android.app) =&gt; ä»£ç åˆ†æä¸€ ä»£ç åˆ†æä¸€ï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º Activity ä¸­çš„ FragmentManagerï¼‰ï¼š 12345678public boolean execPendingActions() &#123; ensureExecReady(true); boolean didSomething = false; ...çœç•¥éƒ¨åˆ†ä»£ç  return didSomething;&#125; ä»£ç åˆ†æäºŒï¼ˆæ­¤æ—¶ FragmentManager ä»ä¸º Activity ä¸­çš„ï¼‰ï¼š 123456789101112131415161718private void ensureExecReady(boolean allowStateLoss) &#123; if (mExecutingActions) &#123; // è¿™æ­£æ˜¯å †æ ˆæ—¥å¿—ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ throw new IllegalStateException("FragmentManager is already executing transactions"); &#125; if (Looper.myLooper() != mHost.getHandler().getLooper()) &#123; throw new IllegalStateException("Must be called from main thread of fragment host"); &#125; ... çœç•¥éƒ¨åˆ†ä»£ç  mExecutingActions = true; try &#123; executePostponedTransaction(null, null); &#125; finally &#123; mExecutingActions = false; &#125;&#125; è™½ç„¶è¿™é‡Œæ‰¾åˆ°äº†å¼‚å¸¸ä¿¡æ¯ï¼Œä½†æ˜¯è¿™æ—¶å¹¶æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚ æ¥ä¸‹æ¥çš„è¿è¡Œå¦‚ä¸‹ï¼š 123dispatchStart:189, FragmentController (android.app)dispatchStart:2996, FragmentManagerImpl (android.app)dispatchMoveToState:3039, FragmentManagerImpl (android.app) =&gt; ä»£ç åˆ†æä¸‰ ä»£ç åˆ†æä¸‰ï¼ˆæ­¤æ—¶ FragmentManager ä»ä¸º Activity ä¸­çš„ï¼‰ï¼š 1234567891011121314private void dispatchMoveToState(int state) &#123; if (mAllowOldReentrantBehavior) &#123; moveToState(state, false); &#125; else &#123; try &#123; mExecutingActions = true; // è§ä»£ç åˆ†æå›› moveToState(state, false); &#125; finally &#123; mExecutingActions = false; &#125; &#125; execPendingActions();&#125; è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ mExecutingActions = true;ç„¶åå°±è¿›å…¥äº† moveToState æ–¹æ³•ã€‚ ä»£ç åˆ†æå››ï¼ˆæ­¤æ—¶ FragmentManager ä»ä¸º Activity ä¸­çš„ï¼‰ï¼š 12345678910111213141516void moveToState(int newState, boolean always) &#123; ... çœç•¥éƒ¨åˆ†ä»£ç  // Now iterate through all active fragments. These will include those that are removed // and detached. final int numActive = mActive.size(); for (int i = 0; i &lt; numActive; i++) &#123; // æ­¤æ—¶ mActivie ä¸­åªæœ‰ä¸€ä¸ªä¸”ä¸º ReportFragment Fragment f = mActive.valueAt(i); if (f != null &amp;&amp; (f.mRemoving || f.mDetached) &amp;&amp; !f.mIsNewlyAdded) &#123; // è§ä»£ç åˆ†æäº” moveFragmentToExpectedState(f); ... &#125; &#125; ... çœç•¥éƒ¨åˆ†ä»£ç &#125; ä»£ç åˆ†æäº”ï¼ˆæ­¤æ—¶ FragmentManager ä¸º Activity ä¸­çš„ï¼‰ï¼š 1234567891011121314151617181920void moveFragmentToExpectedState(final Fragment f) &#123; ... moveToState(f, nextState, f.getNextTransition(), f.getNextTransitionStyle(), false); ...&#125;@SuppressWarnings("ReferenceEquality")void moveToState(Fragment f, int newState, int transit, int transitionStyle, boolean keepActive) &#123; ... switch (f.mState) &#123; case Fragment.STOPPED: if (newState &gt; Fragment.STOPPED) &#123; // è§ä»£ç åˆ†æå…­ f.performStart(); dispatchOnFragmentStarted(f, false); &#125; ... &#125; ...&#125; ä»£ç åˆ†æå…­ï¼ˆæ­¤æ—¶è¿›å…¥ Fragmentï¼‰ï¼š 1234567891011public class Fragment &#123; void performStart() &#123; if (mChildFragmentManager != null) &#123; mChildFragmentManager.noteStateNotSaved(); // å†æ¬¡å›åˆ°ä»£ç åˆ†æä¸€ mChildFragmentManager.execPendingActions(); &#125; ... &#125;&#125; è™½ç„¶è¿™é‡Œå†æ¬¡è¿›å…¥ä»£ç åˆ†æä¸€ï¼Œä½†è¿™æ—¶çš„ FragmentManager ä¸å‰é¢çš„ FragmentManager å·²ç»ä¸æ˜¯åŒä¸€ä¸ªäº†ï¼Œä¹‹å‰æ˜¯ Activity ä¸­çš„è€Œç°åœ¨æ˜¯ ReportFragment ä¸­çš„ childFragmentManagerï¼Œå¹¶ä¸” Activity çš„æ ˆå¸§ä»ç„¶å¤„åœ¨ä»£ç åˆ†æä¸‰çš„ mo veToState() æ–¹æ³•ä¸­ï¼ŒmExecutingActions ä»ç„¶ä¸º trueã€‚ ä»£ç åˆ†æä¸€ï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º ReportFragment ä¸­çš„ childFragmentManagerï¼‰ï¼š 12345678public boolean execPendingActions() &#123; ensureExecReady(true); boolean didSomething = false; ...çœç•¥éƒ¨åˆ†ä»£ç  return didSomething;&#125; ä»£ç åˆ†æäºŒï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º ReportFragment ä¸­çš„ childFragmentManagerï¼‰ï¼š 123456789101112131415161718private void ensureExecReady(boolean allowStateLoss) &#123; if (mExecutingActions) &#123; // è¿™æ­£æ˜¯å †æ ˆæ—¥å¿—ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ throw new IllegalStateException("FragmentManager is already executing transactions"); &#125; if (Looper.myLooper() != mHost.getHandler().getLooper()) &#123; throw new IllegalStateException("Must be called from main thread of fragment host"); &#125; ... çœç•¥éƒ¨åˆ†ä»£ç  mExecutingActions = true; try &#123; executePostponedTransaction(null, null); &#125; finally &#123; mExecutingActions = false; &#125;&#125; è¿™æ—¶ä»ç„¶æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚ æ¥ä¸‹æ¥çš„è¿è¡Œä»ç„¶å¦‚ä¸‹ï¼š 123dispatchStart:189, FragmentController (android.app)dispatchStart:2996, FragmentManagerImpl (android.app)dispatchMoveToState:3039, FragmentManagerImpl (android.app) =&gt; ä»£ç åˆ†æä¸‰ ä»£ç åˆ†æä¸‰ï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º ReportFragment ä¸­çš„ childFragmentManagerï¼‰ï¼š 1234567891011121314private void dispatchMoveToState(int state) &#123; if (mAllowOldReentrantBehavior) &#123; moveToState(state, false); &#125; else &#123; try &#123; mExecutingActions = true; // è§ä»£ç åˆ†æå›› moveToState(state, false); &#125; finally &#123; mExecutingActions = false; &#125; &#125; execPendingActions();&#125; è¿™é‡Œä»ç„¶è¦æ³¨æ„çš„æ˜¯ mExecutingActions = true;ç„¶åå°±è¿›å…¥äº† moveToState æ–¹æ³•ã€‚ ä»£ç åˆ†æå››ï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º ReportFragment ä¸­çš„ childFragmentManagerï¼‰ï¼š 12345678910111213141516void moveToState(int newState, boolean always) &#123; ... çœç•¥éƒ¨åˆ†ä»£ç  // Now iterate through all active fragments. These will include those that are removed // and detached. final int numActive = mActive.size(); // è¿™æ—¶ numActive = 0ï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ for å¾ªç¯ã€‚ for (int i = 0; i &lt; numActive; i++) &#123; Fragment f = mActive.valueAt(i); if (f != null &amp;&amp; (f.mRemoving || f.mDetached) &amp;&amp; !f.mIsNewlyAdded) &#123; moveFragmentToExpectedState(f); ... &#125; &#125; ... çœç•¥éƒ¨åˆ†ä»£ç &#125; å› ä¸ºè¿™é‡Œä¸ä¼šè¿›å…¥ for å¾ªç¯ï¼Œæ‰€ä»¥æ–¹æ³•è¿è¡Œç»“æŸåï¼Œä¼šè¿›å…¥ä»£ç åˆ†æä¸‰ä¸­ finally ä»£ç å—ä¸­ï¼Œå°† mExecutingActions èµ‹å€¼ä¸º false;è¿™æ—¶æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå›åˆ°ä»£ç åˆ†æå…­ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼š 12345678910111213public class Fragment &#123; void performStart() &#123; if (mChildFragmentManager != null) &#123; mChildFragmentManager.noteStateNotSaved(); mChildFragmentManager.execPendingActions(); // æ‰§è¡Œå®Œæ¯• &#125; mState = STARTED; mCalled = false; // è§ä»£ç åˆ†æä¸ƒ onStart(); &#125;&#125; ä»£ç åˆ†æä¸ƒï¼š 12345678public class ReportFragment extends Fragment &#123; @Override public void onStart() &#123; super.onStart(); dispatchStart(mProcessListener); dispatch(Lifecycle.Event.ON_START); &#125;&#125; åœ¨ ReportFragment çš„ onStart() æ–¹æ³•ï¼Œä¼šå¯¹ OnStart äº‹ä»¶è¿›è¡Œåˆ†å‘ï¼Œä¹‹å LiveData åœ¨ MainActivity ä¸­ç­‰åˆ°å“åº”ï¼š 12345678910override fun onBackPressed() &#123; sendRequest().observe(this@MainActivity, Observer &#123; if (it == true) &#123; // å› ä¸ºè¿”å›çš„ç»“æœæ˜¯ trueï¼Œæ‰€ä»¥æ‰§è¡Œæ­¤æ–¹æ³•ã€‚è§ä»£ç åˆ†æå…« super.onBackPressed() &#125; else &#123; Toast.makeText(this@MainActivity, "å¼¹å‡ºDialog", Toast.LENGTH_SHORT).show() &#125; &#125;)&#125; ä»£ç åˆ†æå…«ï¼š 123456789101112131415161718public class FragmentActivity &#123; public void onBackPressed() &#123; // è¿™æ—¶çš„ fragmentManger åˆæ˜¯ä¸€ä¸ªæ–°çš„ FragmentMangerï¼Œå®ƒå±äº FragmentActivityã€‚ FragmentManager fragmentManager = mFragments.getSupportFragmentManager(); final boolean isStateSaved = fragmentManager.isStateSaved(); if (isStateSaved &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.N_MR1) &#123; // Older versions will throw an exception from the framework // FragmentManager.popBackStackImmediate(), so we'll just // return here. The Activity is likely already on its way out // since the fragmentManager has already been saved. return; &#125; if (isStateSaved || !fragmentManager.popBackStackImmediate()) &#123; // ä»£ç åˆ†æä¹ super.onBackPressed(); &#125; &#125;&#125; ä»£ç åˆ†æä¹ï¼š 123456789101112131415public class Activity &#123; public void onBackPressed() &#123; if (mActionBar != null &amp;&amp; mActionBar.collapseActionView()) &#123; return; &#125; // è¿™ä¸ª fragmentManager åˆå˜æˆäº† Activity ä¸­çš„ FragmentManagerã€‚ FragmentManager fragmentManager = mFragments.getFragmentManager(); // è§ä»£ç åˆ†æå if (fragmentManager.isStateSaved() || !fragmentManager.popBackStackImmediate()) &#123; finishAfterTransition(); &#125; &#125;&#125; ä»£ç åˆ†æåï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º Activity ä¸­çš„ FragmentManagerï¼‰ï¼š 1234567891011121314@Overridepublic boolean popBackStackImmediate() &#123; checkStateLoss(); return popBackStackImmediate(null, -1, 0);&#125;private boolean popBackStackImmediate(String name, int id, int flags) &#123; // å†æ¬¡è¿›å…¥ä»£ç åˆ†æä¸€ï¼Œæ­¤æ—¶çš„ fragmentManager ä¸ç¬¬ä¸€æ¬¡åˆ†æä¸­çš„æ˜¯åŒä¸€ä¸ª execPendingActions(); ensureExecReady(true); ... çœç•¥éƒ¨åˆ†ä»£ç  return executePop;&#125; æˆ‘ä»¬å†æ¬¡è¿›å…¥åˆ°ä»£ç åˆ†æäºŒä¸­: 123456private void ensureExecReady(boolean allowStateLoss) &#123; if (mExecutingActions) &#123; // è¿™æ­£æ˜¯å †æ ˆæ—¥å¿—ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ throw new IllegalStateException("FragmentManager is already executing transactions"); &#125;&#125; å› ä¸ºå‰é¢åœ¨ä»£ç åˆ†æä¸‰ä¸­æˆ‘ä»¬å¼ºè°ƒè¿‡ï¼ŒActivity ä¸­çš„ mExecutingActions ä¸º true åï¼Œå°±å†ä¹Ÿæ²¡æœ‰è¢«ä¿®æ”¹ä¸º falseï¼Œæ‰€ä»¥è¿™é‡ŒæŠ›å‡ºäº†å¼‚å¸¸ã€‚ è‡³æ­¤ï¼Œé—®é¢˜çš„åŸå› å·²ç»æ‰¾åˆ°äº†ï¼Œæ˜¯ç”±äº Activity ä¸­çš„ FragmentManager çš„ç¬¬ä¸€æ¬¡ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œå…¶ä»–çš„æ“ä½œåˆå¯¼è‡´å®ƒéœ€è¦è¿›è¡Œç¬¬äºŒæ¬¡ä»»åŠ¡ï¼Œæ‰€ä»¥å‘ç”Ÿé”™è¯¯ã€‚ è§£å†³æ–¹æ¡ˆé—®é¢˜çš„åŸå› å·²ç»æ‰¾åˆ°äº†ï¼Œæ‰€ä»¥å½“ç¬¬ä¸€æ¬¡ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œç»“æŸæ—¶ï¼Œå¦‚æœæœ‰ç¬¬äºŒä¸ªä»»åŠ¡åˆ°æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢å»è§£å†³é—®é¢˜ï¼š ç›´æ¥ä¸¢å¼ƒç¬¬äºŒä¸ªä»»åŠ¡åœ¨é¡µé¢ä¸å¯è§æ—¶ï¼Œå–æ¶ˆå¯¹ LiveData çš„ç›‘å¬ï¼Œè¿™æ ·é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œå°±ä¸ä¼šæ¥æ”¶åˆ°å˜åŒ–çš„é€šçŸ¥äº†ï¼Œä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132class MainActivity : AppCompatActivity() &#123; private val observer = Observer&lt;Boolean&gt; &#123; if (it == true) &#123; super.onBackPressed() &#125; else &#123; Toast.makeText(this@MainActivity, "å¼¹å‡ºDialog", Toast.LENGTH_SHORT).show() &#125; &#125; private var result: LiveData&lt;Boolean&gt;? = null override fun onBackPressed() &#123; result = sendRequest() result?.observe(this@MainActivity, observer) &#125; override fun onStop() &#123; super.onStop() result?.removeObserver(observer) &#125; private fun sendRequest(): LiveData&lt;Boolean&gt; &#123; val result = MutableLiveData&lt;Boolean&gt;() Handler().postDelayed(&#123; result.postValue(true) &#125;, 3000L) return result &#125;&#125; ç­‰å¾…ç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åå†æ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡é€šè¿‡ Handler.post() æ–¹å¼ï¼Œå°†ä»»åŠ¡æ»åå®Œæˆã€‚ 123456789101112131415161718192021222324class MainActivity : AppCompatActivity() &#123; override fun onBackPressed() &#123; sendRequest().observe(this@MainActivity, Observer &#123; if (it == true) &#123; Handler().post &#123; super.onBackPressed() &#125; &#125; else &#123; Toast.makeText(this@MainActivity, "å¼¹å‡ºDialog", Toast.LENGTH_SHORT).show() &#125; &#125;) &#125; private fun sendRequest(): LiveData&lt;Boolean&gt; &#123; val result = MutableLiveData&lt;Boolean&gt;() Handler().postDelayed(&#123; result.postValue(true) &#125;, 3000L) return result &#125;&#125;]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Fragment</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ˜æµ·å±é€‚é…]]></title>
    <url>%2Fposts%2Fdf0aa059.html</url>
    <content type="text"><![CDATA[å…³äºåˆ˜æµ·å±çš„é€‚é…æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š å¯ä»¥åœ¨åˆ˜æµ·å±åŒºåŸŸå±•ç¤ºï¼Œå³ä½¿éƒ¨åˆ†å†…å®¹è¢«ã€åƒæ‰ã€ä¹Ÿæ²¡å…³ç³»ï¼› ä¸å¯ä»¥åœ¨åˆ˜æµ·å±åŒºåŸŸå±•ç¤ºï¼Œé¿å…é‡è¦çš„ä¿¡æ¯ä¸èƒ½è¢«ç”¨æˆ·çœ‹åˆ°ï¼Œå½±å“ä½¿ç”¨ã€‚ æœ¬æ–‡é’ˆå¯¹è¿™ä¸¤ç§æƒ…å†µè¿›è¡Œåˆ†æï¼š çŸ¥è¯†å‚¨å¤‡window.decorView.systemUiVisibility çš„å¯é€‰å€¼ï¼ˆéƒ¨åˆ†ï¼‰ View.SYSTEM_UI_FLAG_VISIBLE é»˜è®¤æ ‡è®°ã€‚æ˜¾ç¤ºçŠ¶æ€æ å’Œå¯¼èˆªæ ï¼ŒActivity æ­£å¸¸æ˜¾ç¤ºã€‚ View.INVISIBLE éšè—çŠ¶æ€æ ï¼ŒåŒæ—¶Activityä¼šä¼¸å±•å…¨å±æ˜¾ç¤ºã€‚ View.SYSTEM_UI_FLAG_LOW_PROFILE ä½è°ƒæ¨¡å¼, ä¼šéšè—ä¸é‡è¦çš„çŠ¶æ€æ å›¾æ ‡ View.SYSTEM_UI_FLAG_LAYOUT_STABLE ä¿æŒæ•´ä¸ªViewç¨³å®š, å¸¸å’Œæ§åˆ¶System UIæ‚¬æµ®, éšè—çš„Flagså…±ç”¨, ä½¿Viewä¸ä¼šå› ä¸ºSystem UIçš„å˜åŒ–è€Œé‡æ–°layout View.SYSTEM_UI_FLAG_FULLSCREEN çŠ¶æ€æ éšè—ï¼ŒActivityå…¨å±æ˜¾ç¤ºã€‚æ•ˆæœåŒè®¾ç½®WindowManager.LayoutParams.FLAG_FULLSCREEN View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN è§†å›¾å»¶ä¼¸è‡³çŠ¶æ€æ åŒºåŸŸï¼ŒçŠ¶æ€æ ä¸Šæµ®äºè§†å›¾ä¹‹ä¸Š View.SYSTEM_UI_FLAG_HIDE_NAVIGATION éšè—å¯¼èˆªæ  View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION è§†å›¾å»¶ä¼¸è‡³å¯¼èˆªæ åŒºåŸŸï¼Œå¯¼èˆªæ ä¸Šæµ®äºè§†å›¾ä¹‹ä¸Š View.SYSTEM_UI_FLAG_IMMERSIVE æ²‰æµ¸æ¨¡å¼, éšè—çŠ¶æ€æ å’Œå¯¼èˆªæ , å¹¶ä¸”åœ¨ç¬¬ä¸€æ¬¡ä¼šå¼¹æ³¡æé†’, å¹¶ä¸”åœ¨çŠ¶æ€æ åŒºåŸŸæ»‘åŠ¨å¯ä»¥å‘¼å‡ºçŠ¶æ€æ ï¼ˆè¿™æ ·ä¼šæ¸…é™¤ä¹‹å‰è®¾ç½®çš„View.SYSTEM_UI_FLAG_FULLSCREEN æˆ– View.SYSTEM_UI_FLAG_HIDE_NAVIGATIONæ ‡å¿—ï¼‰ã€‚ä½¿ä¹‹ç”Ÿæ•ˆï¼Œéœ€è¦å’Œ View.SYSTEM_UI_FLAG_FULLSCREENï¼ŒView.SYSTEM_UI_FLAG_HIDE_NAVIGATION ä¸­çš„ä¸€ä¸ªæˆ–ä¸¤ä¸ªåŒæ—¶è®¾ç½®ã€‚ View.SYSTEM_UI_FLAG_IMMERSIVE_STIKY ä¸ä¸Šé¢å”¯ä¸€çš„åŒºåˆ«æ˜¯, å‘¼å‡ºéšè—çš„çŠ¶æ€æ åä¸ä¼šæ¸…é™¤ä¹‹å‰è®¾ç½®çš„View.SYSTEM_UI_FLAG_FULLSCREENæˆ–View.SYSTEM_UI_FLAG_HIDE_NAVIGATIONæ ‡å¿—ï¼Œåœ¨ä¸€æ®µæ—¶é—´åå°†å†æ¬¡éšè—ç³»ç»Ÿæ ï¼‰ã€‚ layoutInDisplayCutoutModeï¼ˆAndroid P æä¾›ï¼‰ æ¨¡å¼ æ¨¡å¼è¯´æ˜ LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT åªæœ‰å½“DisplayCutoutå®Œå…¨åŒ…å«åœ¨ç³»ç»Ÿæ ä¸­æ—¶ï¼Œæ‰å…è®¸çª—å£å»¶ä¼¸åˆ°DisplayCutoutåŒºåŸŸã€‚ å¦åˆ™ï¼Œçª—å£å¸ƒå±€ä¸ä¸DisplayCutoutåŒºåŸŸé‡å ã€‚ LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER è¯¥çª—å£å†³ä¸å…è®¸ä¸DisplayCutoutåŒºåŸŸé‡å ã€‚ LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES è¯¥çª—å£å§‹ç»ˆå…è®¸å»¶ä¼¸åˆ°å±å¹•çŸ­è¾¹ä¸Šçš„DisplayCutoutåŒºåŸŸã€‚ åœ¨åˆ˜æµ·å±åŒºåŸŸå†…å±•ç¤ºå†…å®¹ï¼Œéƒ¨åˆ†å†…å®¹è¢«ã€åƒæ‰ã€ä¸å½±å“æ•ˆæœå¦‚ä¸‹ï¼š è¿™ç§æ–¹æ¡ˆæ¯”è¾ƒå¥½é€‚é…ï¼Œå¦‚æœæ˜¯ Android 9.0 åŠä»¥ä¸Šç³»ç»Ÿï¼Œä½¿ç”¨å®˜æ–¹æä¾›çš„æ–¹æ¡ˆï¼Œå¦åˆ™è®¾ç½®å¸ƒå±€å»¶ä¼¸åˆ°çŠ¶æ€æ å³å¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273package com.xiaomai.demoimport android.graphics.Colorimport android.os.Buildimport android.os.Bundleimport android.support.v7.app.AppCompatActivityimport android.view.Viewimport android.view.WindowManagerimport kotlinx.android.synthetic.main.full_screen.*class FullActivity : AppCompatActivity() &#123; override fun onCreate(savedInstanceState: Bundle?) &#123; super.onCreate(savedInstanceState) setContentView(R.layout.full_screen) showTitleBar() // å¦‚æœç³»ç»Ÿç‰ˆæœ¬å¤§äºç­‰äº Android 9.0ï¼Œç³»ç»Ÿæ”¯æŒåˆ˜æµ·å±, å¦åˆ™éƒ¨åˆ†å›½äº§æ‰‹æœºå¯èƒ½åœ¨ Android 8.0 å°±æ”¯æŒäº†åˆ˜æµ·å±ï¼Œéœ€è¦åœ¨ manifest ä¸­é…ç½®ã€‚ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123; window.attributes = window.attributes.apply &#123; layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES &#125; &#125; var isShow = true touchView.setOnClickListener &#123; isShow = !isShow if (isShow) &#123; showTitleBar() &#125; else &#123; hideTitleBar() &#125; &#125; &#125; private fun showTitleBar() &#123; // è®¾ç½®çŠ¶æ€æ é€æ˜ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123; window.statusBarColor = Color.TRANSPARENT &#125; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; window.decorView.systemUiVisibility = View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION or // è§†å›¾å»¶ä¼¸è‡³å¯¼èˆªæ åŒºåŸŸï¼Œå¯¼èˆªæ ä¸Šæµ®äºè§†å›¾ä¹‹ä¸Š View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN // è§†å›¾å»¶ä¼¸è‡³çŠ¶æ€æ åŒºåŸŸï¼ŒçŠ¶æ€æ ä¸Šæµ®äºè§†å›¾ä¹‹ä¸Š &#125; &#125; /** * å·²çŸ¥é—®é¢˜ï¼Œåœ¨ Vivo X21A å…¨å±é€‚é…æœ‰é—®é¢˜ */ private fun hideTitleBar() &#123; var options = View.SYSTEM_UI_FLAG_HIDE_NAVIGATION // éšè—å¯¼èˆªæ  if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; options = options or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION or // è§†å›¾å»¶ä¼¸è‡³å¯¼èˆªæ åŒºåŸŸï¼Œå¯¼èˆªæ ä¸Šæµ®äºè§†å›¾ä¹‹ä¸Š View.SYSTEM_UI_FLAG_FULLSCREEN or // éšè—çŠ¶æ€æ  View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN // è§†å›¾å»¶ä¼¸è‡³çŠ¶æ€æ åŒºåŸŸï¼ŒçŠ¶æ€æ ä¸Šæµ®äºè§†å›¾ä¹‹ä¸Š &#125; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123; options = options or View.SYSTEM_UI_FLAG_IMMERSIVE // æ²‰æµ¸æ¨¡å¼, éšè—çŠ¶æ€æ å’Œå¯¼èˆªæ , å¹¶ä¸”åœ¨ç¬¬ä¸€æ¬¡ä¼šå¼¹æ³¡æé†’, å¹¶ä¸”åœ¨çŠ¶æ€æ åŒºåŸŸæ»‘åŠ¨å¯ä»¥å‘¼å‡ºçŠ¶æ€æ  &#125; window.decorView.systemUiVisibility = options &#125;&#125; å†…å®¹é‡è¦ï¼Œä¸èƒ½åœ¨åˆ˜æµ·å±åŒºåŸŸå±•ç¤º æ€è·¯ï¼šé¦–å…ˆæ£€æŸ¥è®¾å¤‡æ˜¯å¦æ˜¯åˆ˜æµ·å±ï¼Œå¦‚æœæ˜¯çš„è¯åˆ™è®¾ç½®ä¸åœ¨çŠ¶æ€æ æ˜¾ç¤ºå†…å®¹ï¼Œå¦‚æœä¸æ˜¯è¯åˆ™å¯ä»¥åœ¨çŠ¶æ€æ æ˜¾ç¤ºã€‚ æ£€æµ‹è®¾å¤‡æ˜¯å¦æ˜¯åˆ˜æµ·å±çš„æ€è·¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113class FullActivity : AppCompatActivity() &#123; private val TAG = "FullActivity" private var hasDisplayCutout = false set(value) &#123; field = value if (value) &#123; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123; window.attributes = window.attributes.apply &#123; layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER &#125; &#125; // è®¾ç½®çŠ¶æ€æ ä¸ºé»‘è‰² if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123; window.statusBarColor = Color.BLACK &#125; &#125; else &#123; // è®¾ç½®çŠ¶æ€æ é€æ˜ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123; window.statusBarColor = Color.TRANSPARENT &#125; &#125; showTitleBar() &#125; /** * ç›‘æŸ¥æ˜¯å¦æ˜¯åˆ˜æµ·å± */ private fun checkDisplayCutout() &#123; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123; val decorView = window.decorView decorView.post &#123; val displayCutout = decorView.rootWindowInsets.displayCutout displayCutout?.apply &#123; Log.e(TAG, "å®‰å…¨åŒºåŸŸè·ç¦»å±å¹•å·¦è¾¹çš„è·ç¦» SafeInsetLeft:" + displayCutout.safeInsetLeft) Log.e(TAG, "å®‰å…¨åŒºåŸŸè·ç¦»å±å¹•å³éƒ¨çš„è·ç¦» SafeInsetRight:" + displayCutout.safeInsetRight) Log.e(TAG, "å®‰å…¨åŒºåŸŸè·ç¦»å±å¹•é¡¶éƒ¨çš„è·ç¦» SafeInsetTop:" + displayCutout.safeInsetTop) Log.e(TAG, "å®‰å…¨åŒºåŸŸè·ç¦»å±å¹•åº•éƒ¨çš„è·ç¦» SafeInsetBottom:" + displayCutout.safeInsetBottom) &#125; hasDisplayCutout = displayCutout?.safeInsetTop ?: 0 &gt; 0 &#125; &#125; else &#123; hasDisplayCutout = DisplayCutoutUtils.isSupportDisplayCutout(this@FullActivity) &#125; &#125; override fun onCreate(savedInstanceState: Bundle?) &#123; super.onCreate(savedInstanceState) setContentView(R.layout.full_screen) checkDisplayCutout() var isShow = true touchView.setOnClickListener &#123; isShow = !isShow if (isShow) &#123; showTitleBar() &#125; else &#123; hideTitleBar() &#125; &#125; &#125; private fun showTitleBar() &#123; var newOptions = window.decorView.systemUiVisibility if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; newOptions = View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION &#125; if (hasDisplayCutout) &#123; // do nothing &#125; else &#123; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; newOptions = newOptions or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN &#125; &#125; window.decorView.systemUiVisibility = newOptions &#125; private fun hideTitleBar() &#123; var newOptions = window.decorView.systemUiVisibility if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; newOptions = View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION &#125; if (hasDisplayCutout) &#123; // do nothing &#125; else &#123; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; newOptions = (newOptions or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN or View.SYSTEM_UI_FLAG_FULLSCREEN) &#125; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123; newOptions = newOptions or View.SYSTEM_UI_FLAG_IMMERSIVE &#125; &#125; window.decorView.systemUiVisibility = newOptions &#125;&#125; ä»¥ä¸‹æ˜¯é€šè¿‡åå°„è·å– Android P ç‰ˆæœ¬ä»¥ä¸‹çš„è®¾å¤‡æ˜¯å¦æ˜¯åˆ˜æµ·å±çš„ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146object DisplayCutoutUtils &#123; private const val TAG = "DisplayCutoutUtils" private fun Number.dp2Pixels() = TypedValue.applyDimension( TypedValue.COMPLEX_UNIT_DIP, this.toFloat(), Resources.getSystem().displayMetrics ) fun isSupportDisplayCutout(context: Context): Boolean &#123; return getDisplayCutoutHeight(context) &gt; 0 &#125; //è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¯ä»¥è·å–åˆ˜æµ·å±çš„pxå€¼ï¼Œæ²¡åˆ˜æµ·å±åˆ™è¿”å›0 private fun getDisplayCutoutHeight(context: Context): Float &#123; var displayCutoutHeight = 0.0f //åˆ¤æ–­æ‰‹æœºå‚å•†ï¼Œç›®å‰8.0åªæœ‰åä¸ºã€å°ç±³ã€oppoã€vivoé€‚é…äº†åˆ˜æµ·å± val phoneManufacturer = Build.BRAND.toLowerCase(Locale.CHINESE) if ("huawei" == phoneManufacturer) &#123; //huawei,é•¿åº¦ä¸ºlength,å•ä½px val haveDisplayCutoutEMUI = hasDisplayCutoutInEMUI(context) if (haveDisplayCutoutEMUI) &#123; val displayCutout: IntArray = getDisplayCutoutSizeInEMUI(context) displayCutoutHeight = displayCutout[1].toFloat() Log.e( TAG, "haveDisplayCutoutInEMUI: $haveDisplayCutoutEMUI, displayCutout: $displayCutout" ) &#125; &#125; else if ("xiaomi" == phoneManufacturer) &#123; //xiaomi,å•ä½px val haveDisplayCutoutInMIUI = getDisplayCutoutInMIUI("ro.miui.notch", 0) == 1 if (haveDisplayCutoutInMIUI) &#123; val resourceId = context.resources.getIdentifier("notch_height", "dimen", "android") var result = 0 if (resourceId &gt; 0) &#123; result = context.resources.getDimensionPixelSize(resourceId) &#125; displayCutoutHeight = result.toFloat() Log.e( TAG, "haveDisplayCutoutInMIUI: $haveDisplayCutoutInMIUI, displayCutoutHeight: $displayCutoutHeight" ) &#125; &#125; else if ("vivo" == phoneManufacturer) &#123; //vivo,å•ä½dpï¼Œé«˜åº¦27dp val haveDisplayCutoutInVIVO = hasDisplayCutoutInVivo(context) if (haveDisplayCutoutInVIVO) &#123; displayCutoutHeight = 27.dp2Pixels() Log.e( TAG, "haveDisplayCutoutInVIVO: $haveDisplayCutoutInVIVO, displayCutoutHeight: $displayCutoutHeight" ) &#125; &#125; else if ("oppo" == phoneManufacturer) &#123; //oppo val haveDisplayCutoutInOPPO = context.packageManager.hasSystemFeature("com.oppo.feature.screen.heteromorphism") if (haveDisplayCutoutInOPPO) &#123; displayCutoutHeight = 80f Log.e( TAG, "haveDisplayCutoutInOPPO: $haveDisplayCutoutInOPPO, displayCutoutHeight: $displayCutoutHeight" ) &#125; &#125; return displayCutoutHeight &#125; //huawei private fun hasDisplayCutoutInEMUI(context: Context): Boolean &#123; var ret = false try &#123; val cl = context.classLoader val hwNotchSizeUtilClass = cl.loadClass("com.huawei.android.util.HwNotchSizeUtil") val hasNotchInScreenMethod = hwNotchSizeUtilClass.getMethod("hasNotchInScreen") ret = hasNotchInScreenMethod.invoke(hwNotchSizeUtilClass) as Boolean &#125; catch (e: ClassNotFoundException) &#123; Log.e(TAG, "hasDisplayCutoutInEMUI ClassNotFoundException") &#125; catch (e: NoSuchMethodException) &#123; Log.e(TAG, "hasDisplayCutoutInEMUI NoSuchMethodException") &#125; catch (e: Exception) &#123; Log.e(TAG, "hasDisplayCutoutInEMUI Exception") &#125; finally &#123; return ret &#125; &#125; private fun getDisplayCutoutSizeInEMUI(context: Context): IntArray &#123; var ret = intArrayOf(0, 0) try &#123; val cl = context.classLoader val hwNotchSizeUtilClass = cl.loadClass("com.huawei.android.util.HwNotchSizeUtil") val getNotchSizeMethod = hwNotchSizeUtilClass.getMethod("getNotchSize") ret = getNotchSizeMethod.invoke(hwNotchSizeUtilClass) as IntArray &#125; catch (e: ClassNotFoundException) &#123; Log.e(TAG, "getDisplayCutoutSizeInEMUI ClassNotFoundException") &#125; catch (e: NoSuchMethodException) &#123; Log.e(TAG, "getDisplayCutoutSizeInEMUI NoSuchMethodException") &#125; catch (e: Exception) &#123; Log.e(TAG, "getDisplayCutoutSizeInEMUI Exception") &#125; finally &#123; return ret &#125; &#125; private fun getDisplayCutoutInMIUI(key: String, def: Int): Int &#123; var getIntMethod: Method? = null try &#123; if (getIntMethod == null) &#123; getIntMethod = Class.forName("android.os.SystemProperties") .getMethod("getInt", String::class.java, Int::class.javaPrimitiveType) &#125; return (getIntMethod?.invoke(null, key, def) as? Int)?.toInt() ?: 0 &#125; catch (e: Exception) &#123; Log.e(TAG, "Platform error: $e") return def &#125; &#125; private fun hasDisplayCutoutInVivo(context: Context): Boolean &#123; var ret = false try &#123; val classLoader = context.classLoader val ftFeatureClass = classLoader.loadClass("android.util.FtFeature") val isFeatureSupportMethod = ftFeatureClass.getMethod("isFeatureSupport", Int::class.javaPrimitiveType!!) ret = isFeatureSupportMethod.invoke(ftFeatureClass, 0x00000020) as Boolean &#125; catch (e: ClassNotFoundException) &#123; Log.e(TAG, "hasDisplayCutoutInVivo ClassNotFoundException") &#125; catch (e: NoSuchMethodException) &#123; Log.e(TAG, "hasDisplayCutoutInVivo NoSuchMethodException") &#125; catch (e: Exception) &#123; Log.e(TAG, "hasDisplayCutoutInVivo Exception") &#125; finally &#123; return ret &#125; &#125;&#125; å¸¦è™šæ‹Ÿå¯¼èˆªçš„ Pad è®¾å¤‡æœ‰çš„ Pad åœ¨æ¨ªå±æ—¶ï¼Œè™šæ‹Ÿå¯¼èˆªåœ¨å±å¹•å³ä¾§ï¼Œè€Œæœ‰çš„åœ¨å±å¹•ä¸‹æ–¹ã€‚æœ‰ä¸¤ç§è®¡ç®—å±å¹•å®½é«˜çš„æ–¹æ³•ï¼Œä¸€ç§åŒ…å«è™šæ‹Ÿå¯¼èˆªæ ï¼Œä¸€ç§ä¸åŒ…å«ã€‚ 123456789101112131415161718192021222324252627282930313233fun getScreenHeight() = Resources.getSystem().displayMetrics.heightPixelsfun getScreenWidth() = Resources.getSystem().displayMetrics.widthPixels/** * åŒ…å«è™šæ‹Ÿå¯¼èˆªæ  */fun getRealScreenHeight(context: Context): Int &#123; return if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) &#123; val windowManager = context.getSystemService(Context.WINDOW_SERVICE) as WindowManager val display = windowManager.defaultDisplay val metrics = DisplayMetrics() display.getRealMetrics(metrics) metrics.heightPixels &#125; else &#123; getScreenHeight() &#125;&#125;/** * åŒ…å«è™šæ‹Ÿå¯¼èˆªæ  */fun getRealScreenWidth(context: Context): Int &#123; return if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) &#123; val windowManager = context.getSystemService(Context.WINDOW_SERVICE) as WindowManager val display = windowManager.defaultDisplay val metrics = DisplayMetrics() display.getRealMetrics(metrics) metrics.widthPixels &#125; else &#123; getScreenWidth() &#125;&#125; å‚è€ƒé“¾æ¥ https://developer.android.com/guide/topics/display-cutout https://juejin.im/post/5b1930835188257d7541ba33 MIUI å¼€å‘æ–‡æ¡£ Vivo å¼€å‘æ–‡æ¡£]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>å±å¹•é€‚é…</tag>
        <tag>åˆ˜æµ·å±</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Dialog ä¸­ç›‘å¬é”®ç›˜å¼¹å‡ºä¸æ”¶èµ·äº‹ä»¶]]></title>
    <url>%2Fposts%2Fa5f0e43e.html</url>
    <content type="text"><![CDATA[æœ€è¿‘é‡åˆ°äº†ä¸€ä¸ªåœ¨ Dialog ä¸­ç›‘å¬é”®ç›˜å¼¹å‡ºä¸æ”¶èµ·äº‹ä»¶çš„éœ€æ±‚ï¼Œç»è¿‡æŸ¥è¯¢èµ„æ–™å†ä¸è‡ªå·±çš„éœ€æ±‚ç›¸ç»“åˆç„¶åæ€è€ƒï¼Œæœ€ç»ˆè§£å†³äº†é—®é¢˜ã€‚ç°å°†ä¸­é—´é‡åˆ°çš„é—®é¢˜ä¸è§£å†³åŠæ³•è®°å½•ä¸‹æ¥ã€‚ éœ€æ±‚ä¸æ•ˆæœ æ€è·¯è‡ªå®šä¹‰ Dialogï¼Œé€šè¿‡è®¾ç½® Dialog çš„ â€œwindowSoftInputModeâ€ é…åˆç›‘å¬ Dialog æ‰€åœ¨ Window çš„é«˜åº¦å˜åŒ–æ¥åˆ¤æ–­é”®ç›˜å½“å‰çš„çŠ¶æ€ã€‚ å®ç°å¸ƒå±€1234567891011121314151617181920212223242526272829303132333435&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android" android:id="@+id/rootView" android:layout_width="match_parent" android:layout_height="44dp" android:layout_gravity="bottom" android:background="@android:color/white" android:orientation="horizontal"&gt; &lt;EditText android:id="@+id/editText" android:layout_width="0dp" android:layout_height="wrap_content" android:layout_gravity="center_vertical" android:layout_weight="1" android:background="@null" android:hint="ç‚¹æ­¤å‚åŠ è®¨è®º~" android:maxLines="1" android:paddingLeft="10dp" android:paddingRight="10dp" android:singleLine="true" android:textColor="@android:color/black" android:textSize="13sp" /&gt; &lt;TextView android:id="@+id/sendButton" android:layout_width="wrap_content" android:layout_height="match_parent" android:gravity="center" android:paddingLeft="15dp" android:paddingRight="15dp" android:text="å‘é€" android:textColor="@android:color/black" android:textSize="13sp" /&gt;&lt;/LinearLayout&gt; style1234567&lt;style name="Dialog" parent="Theme.AppCompat.Dialog"&gt; &lt;item name="android:background"&gt;@android:color/transparent&lt;/item&gt; &lt;item name="android:windowBackground"&gt;@android:color/transparent&lt;/item&gt; &lt;item name="android:windowNoTitle"&gt;true&lt;/item&gt; &lt;item name="android:windowSoftInputMode"&gt;adjustPan|stateVisible&lt;/item&gt; &lt;item name="android:backgroundDimEnabled"&gt;false&lt;/item&gt;&lt;/style&gt; Dialog12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879class MyDialog(context: Context, private val callback: Callback) : Dialog(context, R.style.Dialog) &#123; companion object &#123; private const val TAG = "MyDialog" &#125; override fun onCreate(savedInstanceState: Bundle?) &#123; super.onCreate(savedInstanceState) setContentView(R.layout.mydioalog) window?.attributes = window?.attributes?.apply &#123; width = WindowManager.LayoutParams.MATCH_PARENT // å› ä¸º adjustPan åœ¨é”®ç›˜å¼¹å‡ºåå¸ƒå±€é«˜åº¦å¤§äºå±å¹•ä¸Šé™¤é”®ç›˜ä¹‹å¤–çš„å¯ç”¨åŒºåŸŸçš„é«˜åº¦æ—¶æ‰ä¼šèµ·æ•ˆï¼Œ // è€Œæˆ‘ä»¬ç›‘å¬çš„å°±æ˜¯å¸ƒå±€åœ¨é”®ç›˜å¼¹å‡ºä¸æ”¶èµ·æ—¶å¯è§åŒºåŸŸçš„é«˜åº¦çš„å˜åŒ–ï¼Œä»è€Œåˆ¤æ–­é”®ç›˜å½“å‰çš„çŠ¶æ€çš„ã€‚ // ä½†æ˜¯ä¸åŒçš„æ‰‹æœºå±å¹•é«˜åº¦ä¸åŒï¼Œæ‰€ä»¥éœ€è¦åŠ¨æ€è®¾ç½®ã€‚ // å¯ç”¨é«˜åº¦ = å±å¹•é«˜åº¦ - çŠ¶æ€æ é«˜åº¦ height = Resources.getSystem().displayMetrics.heightPixels - getStatusBarHeight() gravity = Gravity.BOTTOM &#125; rootView.viewTreeObserver.addOnGlobalLayoutListener &#123; val decorView = window.decorView val visibleDisplayRect = Rect() // æ£€æµ‹å½“å‰è§†å›¾æ‰€åœ¨çš„ Window å¯è§åŒºåŸŸçš„å¤§å° decorView.getWindowVisibleDisplayFrame(visibleDisplayRect) val visibleHeight = decorView.height Log.d(TAG, "visibleHeight $visibleHeight") when &#123; decorViewVisibleHeight == 0 -&gt; &#123; // do nothing &#125; decorViewVisibleHeight &gt; visibleDisplayRect.height() -&gt; callback.onKeyboardShow() else -&gt; callback.onKeyboardDismiss() &#125; decorViewVisibleHeight = visibleHeight &#125; &#125; /** * è·å–çŠ¶æ€æ é«˜åº¦ */ private fun getStatusBarHeight(): Int &#123; val resourceId = Resources.getSystem().getIdentifier( "status_bar_height", "dimen", "android" ) return if (resourceId &gt; 0) &#123; context.resources.getDimensionPixelSize(resourceId) &#125; else &#123; TypedValue.applyDimension( TypedValue.COMPLEX_UNIT_DIP, 25f, Resources.getSystem().displayMetrics ).toInt() &#125; &#125; private var decorViewVisibleHeight = 0 interface Callback &#123; /** * é”®ç›˜å¼¹å‡º */ fun onKeyboardShow() /** * é”®ç›˜æ”¶èµ· */ fun onKeyboardDismiss() &#125;&#125; æ·»åŠ æ˜¾ç¤º Dialog çš„ç‚¹å‡»äº‹ä»¶åœ¨ Activity ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶ä¸ºå®ƒæ·»åŠ ç‚¹å‡»äº‹ä»¶å¦‚ä¸‹ï¼š 12345678910button.setOnClickListener &#123; MyDialog(this, object : MyDialog.Callback &#123; override fun onKeyboardShow() &#123; textView.text = "é”®ç›˜æ˜¾ç¤º" &#125; override fun onKeyboardDismiss() &#123; textView.text = "é”®ç›˜éšè—" &#125; &#125;).show()&#125; æ­¤æ—¶å·²ç»å¯ä»¥ç›‘å¬åˆ°é”®ç›˜çš„å¼¹å‡ºä¸æ”¶èµ·äº‹ä»¶äº†ï¼Œä½†æ˜¯ä»”ç»†çœ‹è¾“å…¥æ¡†ä¼šå‘ç°ä¸‹åŠéƒ¨åˆ†è¢«é”®ç›˜ç›–ä½äº†ã€‚ è§£å†³é—®é¢˜ç»è¿‡ç ”ç©¶å‘ç°è¿™ä¸ EditText çš„ background å±æ€§æœ‰å…³ï¼Œå…ˆæŠŠ android:background=&quot;@null&quot; å»æ‰ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š é‚£ä¹ˆ background è®¾ç½®ä¸º null ä¸é»˜è®¤å€¼çš„å·®åˆ«åœ¨å“ªé‡Œå‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡ EditText çš„æºç æ‰¾ä¸€ä¸‹ç­”æ¡ˆã€‚ 12345678910public class EditText extends TextView &#123; public EditText(Context context) &#123; this(context, null); &#125; public EditText(Context context, AttributeSet attrs) &#123; this(context, attrs, com.android.internal.R.attr.editTextStyle); &#125;...&#125; ä»æºç ä¸­å¯ä»¥çœ‹å‡º EditText çš„é»˜è®¤ style ä¸º com.android.internal.R.attr.editTextStyleï¼Œæ¥ä¸‹æ¥å…¨å±€æœç´¢çœ‹ä¸€ä¸‹è¿™ä¸ª style çš„ç‰¹å¾ï¼š ä¸€è·¯è¿½è¸ª parentï¼Œæœ€ç»ˆå‘ç°é¡¶çº§ parent å¦‚ä¸‹ï¼š 12345&lt;style name="Widget.EditText"&gt; ... &lt;item name="background"&gt;?attr/editTextBackground&lt;/item&gt; ...&lt;/style&gt; å†å…¨å±€æœç´¢ editTextBackground å…³é”®å­—ï¼š ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæœ‰å¾ˆå¤š item çš„ name æ˜¯ editTextBackgroundï¼Œéšä¾¿æ‰“å¼€ä¸€ä¸ªï¼Œè¿™é‡Œå°±ä»¥å›¾ä¸­é€‰ä¸­çš„ä¸ºä¾‹ï¼Œæ‰“å¼€æ–‡ä»¶å¦‚ä¸‹ï¼š 1234567891011121314151617181920&lt;inset xmlns:android="http://schemas.android.com/apk/res/android" android:insetLeft="@dimen/edit_text_inset_horizontal_material" android:insetRight="@dimen/edit_text_inset_horizontal_material" android:insetTop="@dimen/edit_text_inset_top_material" android:insetBottom="@dimen/edit_text_inset_bottom_material"&gt; &lt;selector&gt; &lt;item android:state_enabled="false"&gt; &lt;nine-patch android:src="@drawable/textfield_default_mtrl_alpha" android:tint="?attr/colorControlNormal" /&gt; &lt;/item&gt; &lt;item android:state_pressed="false" android:state_focused="false"&gt; &lt;nine-patch android:src="@drawable/textfield_default_mtrl_alpha" android:tint="?attr/colorControlNormal" /&gt; &lt;/item&gt; &lt;item&gt; &lt;nine-patch android:src="@drawable/textfield_activated_mtrl_alpha" android:tint="?attr/colorControlActivated" /&gt; &lt;/item&gt; &lt;/selector&gt;&lt;/inset&gt; å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡ xml è®¾ç½®äº†ä¸€ä¸ª InsetDrawableï¼Œè¿™é‡Œæ•ˆæœå¦‚åŒç»™ EditText è®¾ç½® paddingã€‚æ‰€ä»¥æˆ‘ä»¬ç»™ EditText æ·»åŠ  paddingTop å’Œ paddingBottomï¼Œè¿è¡Œåå‘ç°æ•ˆæœ OKã€‚ ä½¿ç”¨ FragmentDialog æ³¨æ„å› ä¸º FragmentDialog æ˜¯ä¸€ä¸ª Fragmentï¼Œæ‰€ä»¥æ—¢å¯ä»¥é€šè¿‡ getActivity().getWindow() ä¹Ÿå¯ä»¥ä½¿ç”¨ dialog.getWindow()ï¼Œä½†æ˜¯è¦æ³¨æ„è¿™é‡Œåº”è¯¥ä½¿ç”¨ dialog.getWindow()ï¼Œåä¹‹å°†ä¸ä¼šæœ‰é¢„æœŸæ•ˆæœã€‚]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Dialog</tag>
        <tag>é”®ç›˜</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸ªäººåšå®¢è¿›åŒ–å²]]></title>
    <url>%2Fposts%2F61f01eb0.html</url>
    <content type="text"><![CDATA[ä¸ªäººåšå®¢æ˜¯ä¸€ä¸ªä¸æ–­è¿›åŒ–çš„è¿‡ç¨‹ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹åšå®¢ä¼˜åŒ–çš„ç‚¹ç‚¹æ»´æ»´ã€‚ 2019å¹´08æœˆ07æ—¥ ä½¿ç”¨ hexo_resize_image æ”¯æŒåœ¨ markdown ä¸­è®¾ç½®å›¾ç‰‡å¤§å°ã€‚ 2019å¹´08æœˆ05æ—¥ æ–‡ç« é“¾æ¥ä½¿ç”¨ hexo-abbrlink æ”¯æŒæ–‡ç«  Idã€‚ ä½¿ç”¨ hexo-tag-aplayer æ”¯æŒèƒŒæ™¯éŸ³ä¹ã€‚ éŸ³ä¹ç›´é“¾æœç´¢ 2019å¹´08æœˆ01æ—¥ SEO ä¼˜åŒ– å‚è€ƒæ–‡ç«  https://chenhuichao.com/2018/04/13/seo/seo-search-engine-principle/ https://www.jianshu.com/p/9c2d6db2f855 https://accelerator-blog.com/2019/07/27/%E5%8D%9A%E5%AE%A2%E5%8A%9F%E8%83%BD%E4%BC%98%E5%8C%96/ ä½¿ç”¨ hexo-generator-sitemap å’Œ hexo-generator-baidu-sitemap ç”Ÿæˆç«™ç‚¹åœ°å›¾ ä½¿ç”¨ hexo-symbols-count-time æ”¯æŒå­—æ•°ç»Ÿè®¡ ä½¿ç”¨ hexo-generator-searchdb æ”¯æŒç«™å†…æœç´¢ 2019å¹´05æœˆ28æ—¥ å¼€å§‹ä½¿ç”¨ Hexo æ­å»ºä¸ªäººåšå®¢ã€‚]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[å­—ç¬¦ç¼–ç çš„å†å²æ¼”å˜]]></title>
    <url>%2Fposts%2Fa082b9c.html</url>
    <content type="text"><![CDATA[å› ä¸ºè®¡ç®—æœºåªèƒ½å¤„ç†æ•°å­—ï¼Œå¦‚æœè¦å¤„ç†æ–‡æœ¬ï¼Œå°±å¿…é¡»å…ˆæŠŠæ–‡æœ¬è½¬æ¢ä¸ºæ•°å­—æ‰èƒ½å¤„ç†ã€‚æœ€æ—©çš„è®¡ç®—æœºåœ¨è®¾è®¡æ—¶é‡‡ç”¨8ä¸ªæ¯”ç‰¹ï¼ˆbitï¼‰ä½œä¸ºä¸€ä¸ªå­—èŠ‚ï¼ˆbyteï¼‰ï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ªå­—èŠ‚èƒ½è¡¨ç¤ºçš„æœ€å¤§çš„æ•´æ•°å°±æ˜¯255ï¼ˆäºŒè¿›åˆ¶ 11111111 = åè¿›åˆ¶255ï¼‰ï¼Œå¦‚æœè¦è¡¨ç¤ºæ›´å¤§çš„æ•´æ•°ï¼Œå°±å¿…é¡»ç”¨æ›´å¤šçš„å­—èŠ‚ã€‚æ¯”å¦‚ä¸¤ä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°æ˜¯65535ï¼Œ4ä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°æ˜¯4294967295ã€‚ ASCII ç¼–ç çš„è¯ç”Ÿç”±äºè®¡ç®—æœºæ˜¯ç¾å›½äººå‘æ˜çš„ï¼Œå› æ­¤ï¼Œæœ€æ—©åªæœ‰127ä¸ªå­—ç¬¦è¢«ç¼–ç åˆ°è®¡ç®—æœºé‡Œï¼Œä¹Ÿå°±æ˜¯å¤§å°å†™è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸€äº›ç¬¦å·ï¼Œè¿™ä¸ªç¼–ç è¡¨è¢«ç§°ä¸º ASCII ç¼–ç ï¼Œæ¯”å¦‚å¤§å†™å­—æ¯ A çš„ç¼–ç æ˜¯65ï¼Œå°å†™å­—æ¯ z çš„ç¼–ç æ˜¯122ã€‚ ä½†æ˜¯è¦å¤„ç†ä¸­æ–‡ï¼Œæ˜¾ç„¶ä¸€ä¸ªå­—èŠ‚æ˜¯ä¸å¤Ÿçš„ï¼Œè‡³å°‘éœ€è¦ä¸¤ä¸ªå­—èŠ‚ï¼Œè€Œä¸”è¿˜ä¸èƒ½å’ŒASCIIç¼–ç å†²çªï¼Œæ‰€ä»¥ï¼Œä¸­å›½åˆ¶å®šäº† GB2312 ç¼–ç ï¼Œç”¨æ¥æŠŠä¸­æ–‡ç¼–è¿›å»ã€‚ å…«ä»™è¿‡æµ·ï¼Œå„æ˜¾ç¥é€šä½†å…¨ä¸–ç•Œæœ‰ä¸Šç™¾ç§è¯­è¨€ï¼Œæ—¥æœ¬æŠŠæ—¥æ–‡ç¼–åˆ° Shift_JIS é‡Œï¼ŒéŸ©å›½æŠŠéŸ©æ–‡ç¼–åˆ°Euc-kr é‡Œï¼Œå„å›½æœ‰å„å›½çš„æ ‡å‡†ï¼Œå°±ä¼šä¸å¯é¿å…åœ°å‡ºç°å†²çªï¼Œç»“æœå°±æ˜¯ï¼Œåœ¨å¤šè¯­è¨€æ··åˆçš„æ–‡æœ¬ä¸­ï¼Œæ˜¾ç¤ºå‡ºæ¥ä¼šæœ‰ä¹±ç ã€‚ Unicode ä¸ºç»Ÿä¸€è€Œç”Ÿä¸ºäº†é¿å…å„å›½ä¹‹é—´çš„ç¼–ç å†²çªï¼ŒUnicodeåº”è¿è€Œç”Ÿã€‚UnicodeæŠŠæ‰€æœ‰è¯­è¨€éƒ½ç»Ÿä¸€åˆ°ä¸€å¥—ç¼–ç é‡Œï¼Œè¿™æ ·å°±ä¸ä¼šå†æœ‰ä¹±ç é—®é¢˜äº†ã€‚ Unicodeæ ‡å‡†ä¹Ÿåœ¨ä¸æ–­å‘å±•ï¼Œä½†æœ€å¸¸ç”¨çš„æ˜¯ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼ˆå¦‚æœè¦ç”¨åˆ°éå¸¸ååƒ»çš„å­—ç¬¦ï¼Œå°±éœ€è¦4ä¸ªå­—èŠ‚ï¼‰ã€‚ç°ä»£æ“ä½œç³»ç»Ÿå’Œå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€éƒ½ç›´æ¥æ”¯æŒUnicodeã€‚ æ–°çš„é—®é¢˜åˆå‡ºç°äº†ï¼šå¦‚æœç»Ÿä¸€æˆUnicodeç¼–ç ï¼Œä¹±ç é—®é¢˜ä»æ­¤æ¶ˆå¤±äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æœä½ å†™çš„æ–‡æœ¬åŸºæœ¬ä¸Šå…¨éƒ¨æ˜¯è‹±æ–‡çš„è¯ï¼Œç”¨Unicodeç¼–ç æ¯”ASCIIç¼–ç éœ€è¦å¤šä¸€å€çš„å­˜å‚¨ç©ºé—´ï¼Œåœ¨å­˜å‚¨å’Œä¼ è¾“ä¸Šå°±ååˆ†ä¸åˆ’ç®—ã€‚ UTF-8 æ¥ä¼˜åŒ– Unicodeæœ¬ç€èŠ‚çº¦çš„ç²¾ç¥ï¼Œåˆå‡ºç°äº†æŠŠUnicodeç¼–ç è½¬åŒ–ä¸ºâ€œå¯å˜é•¿ç¼–ç â€çš„UTF-8ç¼–ç ã€‚UTF-8ç¼–ç æŠŠä¸€ä¸ªUnicodeå­—ç¬¦æ ¹æ®ä¸åŒçš„æ•°å­—å¤§å°ç¼–ç æˆ1-6ä¸ªå­—èŠ‚ï¼Œå¸¸ç”¨çš„è‹±æ–‡å­—æ¯è¢«ç¼–ç æˆ1ä¸ªå­—èŠ‚ï¼Œæ±‰å­—é€šå¸¸æ˜¯3ä¸ªå­—èŠ‚ï¼Œåªæœ‰å¾ˆç”Ÿåƒ»çš„å­—ç¬¦æ‰ä¼šè¢«ç¼–ç æˆ4-6ä¸ªå­—èŠ‚ã€‚å¦‚æœä½ è¦ä¼ è¾“çš„æ–‡æœ¬åŒ…å«å¤§é‡è‹±æ–‡å­—ç¬¦ï¼Œç”¨UTF-8ç¼–ç å°±èƒ½èŠ‚çœç©ºé—´ï¼š å­—ç¬¦ ASCII Unicode UTF-8 A 01000001 00000000 01000001 01000001 ä¸­ x 01001110 00101101 11100100 10111000 10101101 ä»ä¸Šé¢çš„è¡¨æ ¼è¿˜å¯ä»¥å‘ç°ï¼ŒUTF-8ç¼–ç æœ‰ä¸€ä¸ªé¢å¤–çš„å¥½å¤„ï¼Œå°±æ˜¯ASCIIç¼–ç å®é™…ä¸Šå¯ä»¥è¢«çœ‹æˆæ˜¯UTF-8ç¼–ç çš„ä¸€éƒ¨åˆ†ã€‚ å¦‚æœæŠŠASCIIç¼–ç çš„Aç”¨Unicodeç¼–ç ï¼Œåªéœ€è¦åœ¨å‰é¢è¡¥0å°±å¯ä»¥ï¼Œå› æ­¤ï¼ŒAçš„Unicodeç¼–ç æ˜¯00000000 01000001ã€‚ æ€»ç»“ææ¸…æ¥šäº†ASCIIã€Unicodeå’ŒUTF-8çš„å…³ç³»ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ€»ç»“ä¸€ä¸‹ç°åœ¨è®¡ç®—æœºç³»ç»Ÿé€šç”¨çš„å­—ç¬¦ç¼–ç å·¥ä½œæ–¹å¼ï¼š åœ¨è®¡ç®—æœºå†…å­˜ä¸­ï¼Œç»Ÿä¸€ä½¿ç”¨Unicodeç¼–ç ï¼Œå½“éœ€è¦ä¿å­˜åˆ°ç¡¬ç›˜æˆ–è€…éœ€è¦ä¼ è¾“çš„æ—¶å€™ï¼Œå°±è½¬æ¢ä¸ºUTF-8ç¼–ç ã€‚ ç”¨è®°äº‹æœ¬ç¼–è¾‘çš„æ—¶å€™ï¼Œä»æ–‡ä»¶è¯»å–çš„UTF-8å­—ç¬¦è¢«è½¬æ¢ä¸ºUnicodeå­—ç¬¦åˆ°å†…å­˜é‡Œï¼Œç¼–è¾‘å®Œæˆåï¼Œä¿å­˜çš„æ—¶å€™å†æŠŠUnicodeè½¬æ¢ä¸ºUTF-8ä¿å­˜åˆ°æ–‡ä»¶ã€‚ å‚è€ƒæ–‡ç« https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001431664106267f12e9bef7ee14cf6a8776a479bdec9b9000 å¼€æºå·¥å…·æ¨å¹¿ä½ è¿˜åœ¨ä¸ºå¼€å‘ä¸­é¢‘ç¹åˆ‡æ¢ç¯å¢ƒæ‰“åŒ…è€Œçƒ¦æ¼å—ï¼Ÿå¿«æ¥è¯•è¯• Environment Switcher å§ï¼ä½¿ç”¨å®ƒå¯ä»¥åœ¨appè¿è¡Œæ—¶ä¸€é”®åˆ‡æ¢ç¯å¢ƒï¼Œè€Œä¸”è¿˜æ”¯æŒå…¶ä»–è´´å¿ƒå°åŠŸèƒ½ï¼Œæœ‰äº†å®ƒå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒé¢‘ç¹ç¯å¢ƒåˆ‡æ¢äº†ã€‚https://github.com/CodeXiaoMai/EnvironmentSwitcher]]></content>
      <categories>
        <category>åŸºç¡€çŸ¥è¯†</category>
      </categories>
      <tags>
        <tag>å­—ç¬¦ç¼–ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[EnvironmentSwitcher]]></title>
    <url>%2Fposts%2F1d56b016.html</url>
    <content type="text"><![CDATA[Environment Switcher æ˜¯ä¸€ä¸ªåœ¨ Android çš„å¼€å‘å’Œæµ‹è¯•é˜¶æ®µï¼Œè¿ç”¨ Java æ³¨è§£ã€APTã€åå°„ã€æ··æ·†ç­‰åŸç†æ¥ä¸€é”®åˆ‡æ¢ç¯å¢ƒçš„å·¥å…·ã€‚ ç›®å‰è¯¥é¡¹ç›®å·²ç»è¾¾æˆå¦‚ä¸‹æˆå°±ï¼š å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š é…ç½®ç®€å• å®‰å…¨ï¼Œä¸æ³„æ¼æµ‹è¯•ç¯å¢ƒåœ°å€ ä¸ç”¨é‡æ–°æ‰“åŒ…å³å¯ä¸€é”®åˆ‡æ¢ç¯å¢ƒ æ”¯æŒæŒ‰æ¨¡å—é…ç½®ä¸åˆ‡æ¢ç¯å¢ƒ æ”¯æŒç¯å¢ƒåˆ‡æ¢é€šçŸ¥å›è°ƒ è‡ªåŠ¨ç”Ÿæˆ åˆ‡æ¢ ä¿å­˜ è·å– ç¯å¢ƒçš„é€»è¾‘ä»£ç  ä¸é¡¹ç›®è§£è€¦ â€¦â€¦ ä¸ºä»€ä¹ˆä¸ç”¨ Gradleçœ‹åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šæƒ³ï¼Œè¿™äº›åŠŸèƒ½æˆ‘ç”¨ Gradle å°±èƒ½æå®šäº†ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ Environment Switcher å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ¯”è¾ƒä¸€ä¸‹ Environment Switcher å’Œ Gradleã€‚ æ¯”è¾ƒå†…å®¹ Environment Switcher Gradle Application Id ä¸åŒ Gradle Application Id ç›¸åŒ è¿è¡Œæ—¶åˆ‡æ¢ç¯å¢ƒ âœ”ï¸ âœ–ï¸ âœ–ï¸ åˆ‡æ¢ç¯å¢ƒå›è°ƒ âœ”ï¸ âœ–ï¸ âœ–ï¸ åˆ‡æ¢ç¯å¢ƒé€»è¾‘ è‡ªåŠ¨ç”Ÿæˆ éœ€è¦è‡ªå·±å®ç° éœ€è¦è‡ªå·±å®ç° n å¥—ç¯å¢ƒæ‰“åŒ…æ•°é‡ 1ä¸ª nä¸ª nä¸ª å¤šå¥—ç¯å¢ƒåŒæ—¶å®‰è£… âœ”ï¸ âœ”ï¸ âœ–ï¸ æ”¯ä»˜ç­‰SDKåŒ…åæ ¡éªŒ âœ”ï¸ âœ–ï¸ âœ”ï¸ å¤šæ¨¡å—ç¯å¢ƒé…ç½® âœ”ï¸ âœ”ï¸ âœ”ï¸ æµ‹è¯•ç¯å¢ƒä¸æ³„éœ² âœ”ï¸ âœ”ï¸ âœ”ï¸ â€¦â€¦ â€”â€” â€”â€” â€”â€” è¿™é‡Œå°±å…ˆåˆ—ä¸¾è¿™ä¹ˆå¤šï¼Œä»… è¿è¡Œæ—¶åˆ‡æ¢ç¯å¢ƒ ã€æ‰“åŒ…æ•°é‡ã€åˆ‡æ¢ç¯å¢ƒå›è°ƒ è¿™å‡ ä¸ªç‰¹ç‚¹å°±æ¯” Gradle æ–¹ä¾¿å¾ˆå¤šï¼Œè€Œä¸” Environment Switcher çš„æ¥å…¥æˆæœ¬ä¹Ÿå¾ˆä½ã€‚æ˜¯ä¸æ˜¯æƒ³è¯•ä¸€è¯•äº†ï¼Ÿ ä½¿ç”¨æ–¹æ³• module environmentswitcher environmentswitcher-compiler environmentswitcher-compiler-release version é…ç½®é¡¹ç›®çš„ build.gradlejava ç‰ˆ123456dependencies &#123; ... implementation &quot;com.xiaomai.environmentswitcher:environmentswitcher:$version&quot; debugAnnotationProcessor &quot;com.xiaomai.environmentswitcher:environmentswitcher-compiler:$version&quot; releaseAnnotationProcessor &quot;com.xiaomai.environmentswitcher:environmentswitcher-compiler-release:$version&quot;&#125; kotlin ç‰ˆ12345678apply plugin: &apos;kotlin-kapt&apos;...dependencies &#123; ... implementation &quot;com.xiaomai.environmentswitcher:environmentswitcher:$version&quot; kaptDebug &quot;com.xiaomai.environmentswitcher:environmentswitcher-compiler:$version&quot; kaptRelease &quot;com.xiaomai.environmentswitcher:environmentswitcher-compiler-release:$version&quot;&#125; ç¼–å†™ EnvironmentConfig æ–‡ä»¶è¿™ä¸ªç±»æ˜¯ Environment Switcher ä¾èµ–çš„æ ¸å¿ƒä»£ç ï¼Œæ‰€æœ‰è·å–ã€ä¿®æ”¹ç¯å¢ƒçš„é€»è¾‘ä»£ç éƒ½ä¼šä¾èµ–è¿™ä¸ªç±»ä¸­è¢« @Module å’Œ @Environment ä¸¤ä¸ªæ³¨è§£æ ‡è®°çš„ç±»å’Œå±æ€§è‡ªåŠ¨ç”Ÿæˆã€‚ æ³¨æ„ï¼šå¦‚æœä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨äº† Kotlinï¼Œè¯·ä½¿ç”¨ Java è¯­è¨€ç¼–å†™ EnvironmentConfigï¼Œæš‚æ—¶è¿˜ä¸æ”¯æŒä½¿ç”¨ Kotlin ç¼–å†™è¿™ä¸ªç±»ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/** * ç¯å¢ƒé…ç½®ç±»&lt;/br&gt; * * âš  å»ºè®®ä¸è¦å¼•ç”¨è¯¥ç±»ä¸­çš„ä»»ä½•å­ç±»å’Œæˆå‘˜å˜é‡ï¼Œä¸€ä½†å¼•ç”¨äº†éæ­£å¼ç¯å¢ƒçš„å±æ€§ï¼Œæ‰“åŒ…æ—¶æ··æ·†å·¥å…·å°±ä¸ä¼šç§»é™¤è¯¥ç±»ï¼Œå¯¼è‡´æµ‹è¯•åœ°å€æ³„æ¼ã€‚&lt;/br&gt; * Environment Switcher åœ¨ç¼–è¯‘ Release ç‰ˆæœ¬æ—¶ï¼Œä¼šè‡ªåŠ¨éšè—æµ‹è¯•ç¯å¢ƒåœ°å€ã€‚&lt;/br&gt;&lt;/br&gt; * * å»ºè®®å°†è¯¥ç±»ä¸­æ‰€æœ‰è¢« &#123;@link Module&#125; å’Œ &#123;@link Environment&#125; ä¿®é¥°çš„ç±»æˆ–æˆå‘˜å˜é‡ç”¨ private ä¿®é¥°ï¼Œ&lt;/br&gt; * Environment Switcher ä¼šåœ¨ç¼–è¯‘æœŸé—´è‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„ Module_XX å’Œ Environment_XX é™æ€å¸¸é‡ã€‚&lt;/br&gt; * ä¾‹å¦‚ï¼šé€šè¿‡ EnvironmentSwitcher.MODULE_APP å°±å¯ä»¥è·å–åˆ° App æ¨¡å—ä¸‹ç›¸åº”çš„æ‰€æœ‰ç¯å¢ƒ&lt;/br&gt; */public class EnvironmentConfig &#123; /** * æ•´ä¸ª App çš„ç¯å¢ƒ */ @Module private class App &#123; @Environment(url = &quot;https://gank.io/api/&quot;, isRelease = true, alias = &quot;æ­£å¼&quot;) private String online; &#125; /** * ç‰¹æ®Šæ¨¡å— Music çš„ç¯å¢ƒ */ @Module(alias = &quot;éŸ³ä¹&quot;) private class Music &#123; @Environment(url = &quot;https://www.codexiaomai.top/api/&quot;, isRelease = true, alias = &quot;æ­£å¼&quot;) private String online; @Environment(url = &quot;http://test.codexiaomai.top/api/&quot;, alias = &quot;æµ‹è¯•&quot;) private String test; &#125; /** * ç‰¹æ®Šæ¨¡å— News çš„ç¯å¢ƒ */ @Module(alias = &quot;æ–°é—»&quot;) private class News &#123; @Environment(url = &quot;http://news/release/&quot;, isRelease = true, alias = &quot;æ­£å¼&quot;) private String release; @Environment(url = &quot;http://news/test/&quot;, alias = &quot;æµ‹è¯•&quot;) private String test; @Environment(url = &quot;http://news/test1/&quot;) private String test1; @Environment(url = &quot;http://news/sandbox/&quot;, alias = &quot;æ²™ç®±&quot;) private String sandbox; &#125;&#125; @Moduleè¢«å®ƒä¿®é¥°çš„ç±»æˆ–æ¥å£è¡¨ç¤ºä¸€ä¸ªæ¨¡å—ï¼Œç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆç›¸åº”æ¨¡å—çš„ getXXEnvironment() å’Œ setXXEnvironment() æ–¹æ³•ã€‚ä¸€ä¸ªè¢« @Module ä¿®é¥°çš„ç±»ä¸­ï¼Œå¯ä»¥æœ‰ n (n&gt;0) ä¸ªè¢« @Environment ä¿®é¥°çš„å±æ€§ï¼Œè¡¨ç¤ºè¯¥æ¨¡å—ä¸­æœ‰ n ç§ç¯å¢ƒã€‚ ä¾‹å¦‚ï¼šä¸Šé¢çš„ä»£ç ä¸­ï¼Œæœ‰ä¸‰ä¸ªç±»è¢« @Module ä¿®é¥°ï¼Œæ„å‘³ç€æœ‰ä¸‰ä¸ªæ¨¡å—ï¼Œå…¶ä¸­ App æ¨¡å—ä¸­ï¼Œåªæœ‰ä¸€ä¸ªå±æ€§è¢« @Environment ä¿®é¥°ï¼Œè¡¨ç¤ºè¯¥æ¨¡å—åªæœ‰ä¸€ç§ç¯å¢ƒï¼›è€Œ Music å’Œ News æ¨¡å—åˆ†åˆ«æœ‰ 2 ç§å’Œ 4 ç§ç¯å¢ƒã€‚ æ­¤å¤– @Module è¿˜æœ‰ä¸€ä¸ªå¯é€‰å±æ€§ alias ï¼Œç”¨æ¥æŒ‡å®šè¯¥æ¨¡å—çš„åˆ«åã€‚è¯¥å€¼é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚è¿™ä¸ªå±æ€§çš„ä¸»è¦ç›®çš„æ˜¯åœ¨åˆ‡æ¢ç¯å¢ƒ UI é¡µé¢æ˜¾ç¤ºä¸­æ–‡åç§°ã€‚ä¾‹å¦‚ï¼šMusic å’Œ News æ¨¡å—åœ¨åˆ‡æ¢ç¯å¢ƒé¡µé¢ä¸­å°±ä¼šåˆ†åˆ«æ˜¾ç¤º â€œéŸ³ä¹â€ å’Œ â€œæ–°é—»â€ã€‚ æ³¨ï¼šå¦‚æœä½ çš„é¡¹ç›®ä¸­æ‰€æœ‰æ¨¡å—å…±ç”¨åŒä¸€ä¸ª Host åœ°å€ï¼Œé‚£ä¹ˆåªéœ€é…ç½®ä¸€ä¸ª Module å°±å¯ä»¥äº†ã€‚ @Environmentè¢«å®ƒä¿®é¥°çš„å±æ€§è¡¨ç¤ºä¸€ä¸ªç¯å¢ƒï¼Œå¿…é¡»æŒ‡å®š url çš„å€¼ï¼Œæ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªå¯é€‰å±æ€§ï¼šisRelease å’Œ aliasã€‚ isRelease æ˜¯ä¸€ä¸ª boolean å‹çš„å±æ€§ï¼Œé»˜è®¤ä¸º falseï¼Œå½“å€¼ä¸º true æ—¶ï¼Œå®ƒå°±æ˜¯æ‰€åœ¨ Module çš„é»˜è®¤ç¯å¢ƒï¼Œä»¥åŠ App æ­£å¼å‘å¸ƒæ—¶çš„ç¯å¢ƒã€‚ä¸€ä¸ª Module ä¸­å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€ä¸ª Environment çš„ isRelease çš„å€¼ä¸º trueï¼Œå¦åˆ™ç¼–è¯‘ä¼šå¤±è´¥ã€‚ ä¾‹å¦‚ï¼šMusic æ¨¡å—ä¸­æœ‰ä¸¤ç§ç¯å¢ƒåˆ†åˆ«æ˜¯ onlineï¼ˆæ­£å¼ï¼‰å’Œ test ï¼ˆæµ‹è¯•ï¼‰ï¼Œå› ä¸º online çš„ isRelease = trueï¼Œæ‰€ä»¥å®ƒå°±æ˜¯é»˜è®¤ç¯å¢ƒå’ŒApp æ­£å¼å‘å¸ƒæ—¶çš„ç¯å¢ƒã€‚ alias å’Œ @Module ä¸­çš„ alias ç›¸ä¼¼ï¼Œç”¨äºåœ¨åˆ‡æ¢ç¯å¢ƒçš„UIé¡µé¢å±•ç¤ºè¯¥ç¯å¢ƒçš„åå­—ï¼Œè¯¥å€¼é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå¦‚æœç»™å®ƒæŒ‡å®šéç©ºå­—ç¬¦ä¸²ï¼Œåˆ™ç¯å¢ƒçš„åå­—å°±è¢«æŒ‡å®šä¸º alias çš„å€¼ã€‚ å†æ¬¡å¼ºè°ƒï¼šä¸€ä¸ª Module ä¸­å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€ä¸ª Environment çš„ isRelease çš„å€¼ä¸º trueï¼Œå¦åˆ™ç¼–è¯‘ä¼šå¤±è´¥ã€‚ ç‚¹å‡»èœå•æ ä¸­çš„ â€œBuildâ€ -&gt; â€œRebuild Projectâ€ï¼Œç­‰å¾…ç¼–è¯‘å®Œæˆã€‚åˆ°è¿™é‡Œæ•´ä¸ªé…ç½®å°±ç®—å®Œæˆäº†ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥åœ¨é¡¹ç›®ä¸­æ„‰å¿«çš„è·å–ç›¸åº”æ¨¡å—çš„ç¯å¢ƒåœ°å€äº†ã€‚ æ·»åŠ å…¥å£æ‰‹åŠ¨åˆ‡æ¢ç¯å¢ƒå½“ç„¶è¦æœ‰ä¸€ä¸ªé¡µé¢ï¼Œè¿™ä¸ªé¡µé¢ Environment Switcher å·²ç»è‡ªåŠ¨é›†æˆäº†ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªå…¥å£è·³è½¬å³å¯ï¼ˆè¿™ä¸ªå…¥å£åªåœ¨ Debug æµ‹è¯•ç­‰å†…éƒ¨ç‰ˆæ˜¾ç¤ºï¼‰ã€‚ ä¾‹å¦‚ï¼šåœ¨â€œæˆ‘çš„â€é¡µé¢ä¸­ã€‚ 1234567891011121314151617@Overrideprotected void onCreate(@Nullable Bundle savedInstanceState) &#123; ... if (!BuildConfig.DEBUG) &#123; // only show in debug findViewById(R.id.bt_switch_environment).setVisibility(View.GONE); return; &#125; findViewById(R.id.bt_switch_environment).setOnClickListener(new View.OnClickListener() &#123; @Override public void onClick(View view) &#123; // entrance of switch environment EnvironmentSwitchActivity.launch(getContext()); &#125; &#125;);&#125; ä½ å¯ä»¥ä½¿ç”¨ Environment Switcher å·²ç»æä¾›çš„ EnvironmentSwitchActivity.launch(getContext()) æ–¹æ³•å¯åŠ¨ï¼›å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡ startActivity(new Intent(getContext(), EnvironmentSwitchActivity.class)) å¯åŠ¨ï¼Œçœ‹ä¸ªäººå–œå¥½äº†ã€‚ è·å–ç›¸åº”æ¨¡å—çš„ç¯å¢ƒåœ°å€ï¼š123String appEnvironment = EnvironmentSwitcher.getAppEnvironment(this, BuildConfig.DEBUG);String musicEnvironment = EnvironmentSwitcher.getMusicEnvironment(this, BuildConfig.DEBUG);String newsEnvironment = EnvironmentSwitcher.getNewsEnvironment(this, BuildConfig.DEBUG); è·å–ç›¸åº”æ¨¡å—çš„ç¯å¢ƒå®ä½“ç±»(since 1.4)ï¼š123EnvironmentBean appEnvironmentBean = EnvironmentSwitcher.getAppEnvironmentBean(this, BuildConfig.DEBUG);EnvironmentBean musicEnvironmentBean = EnvironmentSwitcher.getMusicEnvironmentBean(this, BuildConfig.DEBUG);EnvironmentBean newsEnvironmentBean = EnvironmentSwitcher.getNewsEnvironmentBean(this, BuildConfig.DEBUG); è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è·å–ç›¸åº”æ¨¡å—çš„åœ°å€éœ€è¦ä¸¤ä¸ªå‚æ•°ã€‚ ç¬¬ä¸€ä¸ªå°±æ˜¯ä¸€ä¸ª Context ä¸ç”¨è§£é‡Šï¼Œå› ä¸º Environment Switcher æ˜¯ç”¨ SharedPreferences è¿›è¡Œå­˜å‚¨æ•°æ®çš„ã€‚ ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª boolean å‹çš„å€¼ï¼Œå¦‚æœä¸º true è¡¨ç¤ºå½“å‰ä¸º Debug æˆ–æµ‹è¯•ç­‰å†…éƒ¨ä½¿ç”¨ç‰ˆæœ¬ï¼Œæ­¤æ—¶è·å–åˆ°çš„åœ°å€æ˜¯æˆ‘ä»¬æ‰‹åŠ¨åˆ‡æ¢ä¿å­˜çš„åœ°å€ï¼›è€Œå¦‚æœä¸º false è¡¨ç¤ºå½“å‰ä¸ºè¦å‘å¸ƒç»™ç”¨æˆ·ä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œæ­¤æ—¶è·å–åˆ°çš„åœ°å€ä¸ºæˆ‘ä»¬åœ¨ @Environment ä¸­æŒ‡å®š isRelease = true çš„åœ°å€ï¼Œæ‰‹åŠ¨åˆ‡æ¢çš„ç¯å¢ƒåœ°å€ä¸å†ç”Ÿæ•ˆã€‚ æ·»åŠ ç›‘å¬äº‹ä»¶Environment Switcher æ”¯æŒåˆ‡æ¢ç¯å¢ƒå›è°ƒï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ·»åŠ ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸è¦å¿˜è®°åœ¨ä¸éœ€è¦ç›‘å¬ç¯å¢ƒåˆ‡æ¢äº‹ä»¶æ—¶ç§»é™¤ç›‘å¬äº‹ä»¶ã€‚ 123456789101112131415161718192021222324public class MainActivity extends AppCompatActivity implements OnEnvironmentChangeListener&#123; private static final String TAG = &quot;MainActivity&quot;; @Override protected void onCreate(@Nullable Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); // æ·»åŠ ç›‘å¬äº‹ä»¶ EnvironmentSwitcher.addOnEnvironmentChangeListener(this); &#125; @Override public void onEnvironmentChanged(ModuleBean module, EnvironmentBean oldEnvironment, EnvironmentBean newEnvironment) &#123; Log.e(TAG, module.getName() + &quot;ç”±&quot; + oldEnvironment.getName() + &quot;ç¯å¢ƒï¼ŒUrl=&quot; + oldEnvironment.getUrl() + &quot;,åˆ‡æ¢ä¸º&quot; + newEnvironment.getName() + &quot;ç¯å¢ƒï¼ŒUrl=&quot; + newEnvironment.getUrl()); &#125; @Override protected void onDestroy() &#123; super.onDestroy(); // ç§»é™¤ç›‘å¬äº‹ä»¶ EnvironmentSwitcher.removeOnEnvironmentChangeListener(this); &#125;&#125; åˆ‡æ¢SDKå¼€å‘ç¯å¢ƒæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä¸€èˆ¬ä¼šä¾èµ–ç¬¬ä¸‰æ–¹æä¾›çš„SDKï¼Œè€Œä¸”è¿™äº›SDKä¹Ÿä¼šæä¾›æµ‹è¯•ç¯å¢ƒï¼Œå¦‚æœè¦åœ¨Appå†…åˆ‡æ¢ç¯å¢ƒï¼Œä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•å°±ä¸è¡Œäº†ã€‚é‚£è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ ä¾‹å¦‚æˆ‘ä»¬çš„â€œç›´æ’­â€æ¨¡å—æ˜¯å¼•ç”¨çš„SDKï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š é¦–å…ˆåœ¨ EnvironmentConfig.java ä¸­é…ç½®â€ç›´æ’­â€æ¨¡å— 12345678910public class EnvironmentConfig &#123; @Module(alias = &quot;ç›´æ’­&quot;) private class Live &#123; @Environment(url = &quot;online&quot;, isRelease = true, alias = &quot;æ­£å¼&quot;) private String online; @Environment(url = &quot;test&quot;, alias = &quot;æµ‹è¯•&quot;) private String test; &#125;&#125; url åœ¨è¿™é‡Œåªæ˜¯ç”¨æ¥åŒºåˆ†ç¯å¢ƒï¼Œä¸ç”¨ä¸ºçœŸå®çš„ urlï¼Œä½†è¦ä¿è¯åŒä¸€æ¨¡å—ä¸­æ¯ä¸ªç¯å¢ƒçš„ url ä¸åŒã€‚ åœ¨ Application ä¸­æ·»åŠ ç›‘å¬ 123456789101112EnvironmentSwitcher.addOnEnvironmentChangeListener(new OnEnvironmentChangeListener() &#123; @Override public void onEnvironmentChanged(ModuleBean module, EnvironmentBean oldEnvironment, EnvironmentBean newEnvironment) &#123; if (module.equals(EnvironmentSwitcher.MODULE_LIVE)) &#123; if (newEnvironment.equals(EnvironmentSwitcher.LIVE_ONLINE_ENVIRONMENT)) &#123; // è°ƒç”¨ SDK åˆ‡æ¢ç¯å¢ƒçš„æ–¹æ³•ï¼Œæ­£å¼ç¯å¢ƒ &#125; else if (newEnvironment.equals(EnvironmentSwitcher.LIVE_TEST_ENVIRONMENT)) &#123; // è°ƒç”¨ SDK åˆ‡æ¢ç¯å¢ƒçš„æ–¹æ³•ï¼Œæµ‹è¯•ç¯å¢ƒ &#125; &#125; &#125;&#125;); åˆ©ç”¨ Environment Switcher çš„ç¯å¢ƒåˆ‡æ¢å›è°ƒï¼Œå®ç°åˆ‡æ¢ SDK ç¯å¢ƒã€‚ å¥½äº†ï¼Œå…³äºEnvironment Switcher çš„ä»‹ç»å°±åˆ°æ­¤ä¸ºæ­¢å§ï¼Œæ›´å¤šä½¿ç”¨ä»‹ç»å¯å‚è€ƒDemoï¼ŒDemo ä¸­æœ‰ Environment Switcher ç»“åˆ Retrofit ä½¿ç”¨çš„è¯¦ç»†å®ç°è¿‡ç¨‹ã€‚]]></content>
      <categories>
        <category>å¼€æº</category>
      </categories>
      <tags>
        <tag>å¼€æº</tag>
        <tag>EnvironmentSwitcher</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ConcurrentModificationException å¼‚å¸¸åˆ†æä¸è§£å†³æ–¹æ³•]]></title>
    <url>%2Fposts%2F9041b2de.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡ä¸»è¦ä»æºç çš„è§’åº¦åˆ†æ ConcurrentModificationException å‘ç”Ÿçš„åŸå› ï¼Œä»¥åŠè§£å†³åŠæ³•ã€‚ éœ€æ±‚ä¸å®ç°éœ€æ±‚ï¼šä»ä¸€ä¸ªé›†åˆä¸­æ‰¾å‡ºæŒ‡å®šçš„å…ƒç´ å¹¶å°†å…¶åˆ é™¤ã€‚ é—®é¢˜ä»£ç ï¼š 1234567891011121314ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;list.forEach(new Consumer&lt;Integer&gt;() &#123; @Override public void accept(Integer integer) &#123; if (integer == 5) &#123; list.remove(integer); &#125; &#125;&#125;); å¼‚å¸¸å †æ ˆï¼š 12345Exception in thread "main" java.util.ConcurrentModificationException at java.util.ArrayList.forEach(ArrayList.java:1260) ...Process finished with exit code 1 åŸå› æ’æŸ¥ä»å¼‚å¸¸çš„å †æ ˆä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨ ArrayList çš„ forEach() æ–¹æ³•ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£å°±å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚ 1234567891011121314151617public void forEach(Consumer&lt;? super E&gt; action) &#123; Objects.requireNonNull(action); final int expectedModCount = modCount; @SuppressWarnings("unchecked") final E[] elementData = (E[]) this.elementData; final int size = this.size; // å¾ªç¯ä½“å†…ä»£ç æ‰§è¡Œéœ€è¦æ»¡è¶³çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š // 1. modCount == expectedModCount // 2. i &lt; size for (int i=0; modCount == expectedModCount &amp;&amp; i &lt; size; i++) &#123; action.accept(elementData[i]); &#125; if (modCount != expectedModCount) &#123; throw new ConcurrentModificationException(); &#125;&#125; ç»è¿‡å¯¹ forEach() æ–¹æ³•çš„æºç åˆ†æï¼Œå‘ç° modCount != expectedModCount ä¼šå¯¼è‡´ for å¾ªç¯é€€å‡ºï¼Œå¹¶ä¸”æŠ›å‡º ConcurrentModificationExceptionã€‚ ä»ç¬¬ 3 è¡Œä»£ç  final int expectedModCount = modCount ä¸­å¯ä»¥çŸ¥é“ï¼Œåˆå§‹çŠ¶æ€ expectedModCount å’Œ modCount çš„å€¼æ˜¯ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆæ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´å®ƒä»¬çš„å€¼ä¸ç›¸ç­‰è¿›è€ŒæŠ›å‡ºå¼‚å¸¸çš„å‘¢ï¼Ÿ åŸå› æ˜¯ ArrayList çš„ä¿®æ”¹æ“ä½œï¼ˆremove æˆ– addï¼‰ä¼šå¯¼è‡´ modCount çš„å€¼å‘ç”Ÿå˜åŒ–ã€‚è¿™é‡Œä»¥ remove æ–¹æ³•ä¸ºä¾‹è¿›è¡Œåˆ†æè¯æ˜ï¼š 12345678910111213141516public boolean remove(Object o) &#123; if (o == null) &#123; for (int index = 0; index &lt; size; index++) if (elementData[index] == null) &#123; fastRemove(index); return true; &#125; &#125; else &#123; for (int index = 0; index &lt; size; index++) if (o.equals(elementData[index])) &#123; fastRemove(index); return true; &#125; &#125; return false;&#125; è¯»å®Œä¸Šé¢çš„æºç ä¼šå‘ç° remove æ–¹æ³•å¹¶æ²¡æœ‰ä¿®æ”¹ modCount çš„å€¼å•Šã€‚åˆ«ç€æ€¥ï¼Œå†ä»”ç»†è§‚å¯Ÿä¼šå‘ç°æ— è®ºæ€æ ·ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ fastRemove æ–¹æ³•ã€‚å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°ï¼š 123456789private void fastRemove(int index) &#123; // ä¿®æ”¹ modCount modCount++; int numMoved = size - index - 1; if (numMoved &gt; 0) System.arraycopy(elementData, index+1, elementData, index, numMoved); elementData[--size] = null; // clear to let GC do its work&#125; è¿™æ¬¡æ²¡é”™äº†å§ã€‚ æ‰€ä»¥åœ¨ forEach() æ–¹æ³•ä¸­ä½¿ç”¨ ArrayList.remove() åˆ é™¤å…ƒç´ ä¼šæŠ›å‡ºå¼‚å¸¸çš„åŸå› æ˜¯ï¼šç”±äº ArrayList æ‰§è¡Œ remove æ–¹æ³•åï¼ŒmodCount çš„å€¼åŠ  1ï¼Œå½“ forEach ä¸­çš„å¾ªç¯æ£€æŸ¥ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œä¼šå›  modCount == expectedModCount ä¸æˆç«‹å¯¼è‡´ for å¾ªç¯é€€å‡ºï¼Œè¿›è€ŒæŠ›å‡º ConcurrentModificationException å¼‚å¸¸ã€‚ ç”±æ­¤å¯è§ï¼ŒforEach å¾ªç¯åªé€‚ç”¨äºå¯¹ ArrayList çš„éå†ï¼Œä½†æ˜¯ä¸å¯ä»¥å¯¹ ArrayList è¿›è¡Œæ·»åŠ æˆ–åˆ é™¤æ“ä½œï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸ã€‚ ç°åœ¨é—®é¢˜çš„åŸå› æ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æ€ä¹ˆè§£å†³å‘¢ï¼Ÿ è§£å†³åŠæ³•æ–¹æ³•ä¸€ï¼šä½¿ç”¨æ™®é€šçš„ for å¾ªç¯1234567891011ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;for (int i = 0; i &lt; list.size(); i++) &#123; if (i == 5) &#123; list.remove(i); &#125;&#125; è¿è¡Œä»£ç ï¼Œå‘ç°æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚é—®é¢˜è§£å†³ï¼ ä½†æ˜¯ï¼Œå¦‚æœéœ€æ±‚æ”¹ä¸ºåˆ é™¤æ‰€æœ‰å…ƒç´ å‘¢ï¼Ÿ 12345678910111213ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;for (int i = 0; i &lt; list.size(); i++) &#123; list.remove(i);&#125;int size = list.size();System.out.println("æ‰§è¡Œå®Œæ¯• list.size() = " + size); å…ˆçŒœä¸€ä¸‹è¿è¡Œç»“æœæ˜¯ä»€ä¹ˆï¼Œå†å¾€ä¸‹çœ‹ã€‚ â€”â€”â€“ è¿™é‡Œæ˜¯åˆ†éš”çº¿ï¼ˆè¿™é‡Œå…ˆæ’æ’­ä¸€æ¡å¹¿å‘Šï¼Œå¹¿å‘Šä¹‹åæ›´åŠ ç²¾å½©ï¼å“ˆå“ˆï¼ï¼ï¼ï¼‰â€”â€”â€”â€” ä½ è¿˜åœ¨ä¸ºå¼€å‘ä¸­é¢‘ç¹åˆ‡æ¢ç¯å¢ƒæ‰“åŒ…è€Œçƒ¦æ¼å—ï¼Ÿå¿«æ¥è¯•è¯• Environment Switcher å§ï¼ä½¿ç”¨å®ƒå¯ä»¥åœ¨appè¿è¡Œæ—¶ä¸€é”®åˆ‡æ¢ç¯å¢ƒï¼Œè€Œä¸”è¿˜æ”¯æŒå…¶ä»–è´´å¿ƒå°åŠŸèƒ½ï¼Œæœ‰äº†å®ƒå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒé¢‘ç¹ç¯å¢ƒåˆ‡æ¢äº†ã€‚https://github.com/CodeXiaoMai/EnvironmentSwitcherç›®å‰è¯¥é¡¹ç›®å·²ç»è¾¾æˆå¦‚ä¸‹æˆå°±ï¼š â€”â€”â€”â€”â€”â€”- è¿™é‡Œæ˜¯åˆ†éš”çº¿ï¼ˆå¹¿å‘Šç»“æŸï¼Œç²¾å½©ç»§ç»­ï¼ï¼ï¼ï¼‰â€”â€”â€”â€”â€”â€”â€“ å¥½äº†ï¼Œå›å½’æ­£é¢˜ä½ çŒœå‡ºç»“æœäº†å—ï¼Ÿçœ‹çœ‹ä½ çŒœçš„å¯¹ä¸‹å¯¹ã€‚ è¿è¡Œç»“æœä¸ºï¼š 1æ‰§è¡Œå®Œæ¯• list.size() = 5 å’¦ï¼Ÿæ˜æ˜æ˜¯éå† list çš„æ¯ä¸ªå…ƒç´ å¹¶æŠŠå®ƒä»¬åˆ é™¤ï¼Œä¸ºä»€ä¹ˆæœ€åè¿˜æœ‰ 5 ä¸ªå…ƒç´ å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸º ArrayList å†…éƒ¨ä½¿ç”¨æ•°ç»„å­˜å‚¨æ•°æ®ï¼Œ10 ä¸ªå…ƒç´ ä¾æ¬¡å­˜å‚¨åœ¨æ•°ç»„çš„ç¬¬ 0 ä¸ªä½ç½®å¼€å§‹åˆ°ç¬¬ 9 ä¸ªä½ç½®ï¼Œå½“ä¸­é—´æœ‰ä¸€ä¸ªå…ƒç´ åˆ é™¤æ—¶ï¼Œåé¢çš„æ‰€æœ‰å…ƒç´ ä¼šå‘å‰ç§»åŠ¨ï¼Œä¿è¯ä¸­é—´æ²¡æœ‰ç©ºä½™ã€‚æ‰€ä»¥å½“ç¬¬ 0 ä¸ªä½ç½®çš„å…ƒç´ åˆ é™¤å®Œæ¯•åï¼Œæœ¬æ¥åœ¨ç¬¬ 1 ä¸ªä½ç½®çš„å…ƒç´ å˜æˆç¬¬ 0 ä¸ªå…ƒç´ ï¼Œä½†ç”±äº i++ å i = 1ï¼Œä¸‹æ¬¡æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ä¼šåˆ é™¤æœ€æ–°çš„ç¬¬ 1 ä¸ªä½ç½®çš„å…ƒç´ ï¼Œè€Œç¬¬ 0 ä¸ªä½ç½®çš„å…ƒç´ å› è¢«è·³è¿‡è€Œä¸ä¼šè¢«åˆ é™¤ï¼ŒåŒç†å½“åé¢çš„å…ƒç´ è¢«åˆ é™¤æ—¶ä¹Ÿä¼šæœ‰è·³è¿‡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ€ç»ˆä¼šæœ‰ 5 ä¸ªå…ƒç´ çš„åŸå› ã€‚ æ‰€ä»¥å¦‚æœåªæ˜¯åœ¨éå† ArrayList çš„åŒæ—¶åˆ é™¤æŒ‡å®šçš„å…ƒç´ åå¹¶é€€å‡ºå¾ªç¯ï¼Œè¿™æ ·æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºåˆ é™¤å…ƒç´ åï¼Œä¸ä¼šè¿›è¡Œå…¶ä»–æ“ä½œã€‚ä½†æ˜¯å¦‚æœåˆ é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°±éœ€è¦åšä¸€äº›ç‰¹æ®Šçš„å¤„ç†äº†ï¼Œå…·ä½“å¤„ç†å¦‚ä¸‹ï¼š 1234for (int i = 0; i &lt; list.size(); i++) &#123; list.remove(i); i--;&#125; æ–¹æ³•äºŒï¼šä½¿ç”¨ Iterator12345678910111213ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;Iterator&lt;Integer&gt; iterator = list.iterator();while (iterator.hasNext()) &#123; if (iterator.next() == 5) &#123; iterator.remove(); &#125;&#125; å¦‚æœè¦åˆ é™¤æ‰€æœ‰å…ƒç´ å‘¢ï¼Ÿ 123456789101112ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;Iterator&lt;Integer&gt; iterator = list.iterator();while (iterator.hasNext()) &#123; iterator.next(); iterator.remove();&#125; è¿è¡Œç»“æœï¼š 1æ‰§è¡Œå®Œæ¯• list.size() = 0 ä»è¿è¡Œç»“æœå¯ä»¥çŸ¥é“ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œè€Œä¸”å®Œå…¨ç¬¦åˆé¢„æœŸã€‚ä¸ºä»€ä¹ˆä½¿ç”¨ Iterator å¯ä»¥æ­£å¸¸éå†å¹¶ä¸”åˆ é™¤æ‰€æœ‰å…ƒç´ å‘¢ï¼Ÿä¸‹é¢ä»æºç çš„è§’åº¦åˆ†æï¼š é¦–å…ˆçœ‹ï¼Œlist.iterator() çš„å®ç°ï¼š 123public Iterator&lt;E&gt; iterator() &#123; return new Itr();&#125; è¿™ä¸ªæ–¹æ³•åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ª Itr ç±»çš„å®ä¾‹ã€‚é€šè¿‡æŸ¥çœ‹æºç å¯ä»¥å‘ç° Itr å®ç°äº† Iterator æ¥å£ï¼Œè¿™ä¸æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„å—ï¼Ÿæ¥ä¸‹æ¥ä¾æ¬¡çœ‹ iterator.hasNext()ã€iterator.next() ä»¥åŠ iterator.remove() æ–¹æ³•ï¼šï¼ˆå‰æ–¹é«˜èƒ½ï¼Œè¯·æ³¨æ„å‡†å¤‡å¥½è„‘å­ï¼ï¼ï¼ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960private class Itr implements Iterator&lt;E&gt; &#123; int cursor; // index of next element to return int lastRet = -1; // index of last element returned; -1 if no such int expectedModCount = modCount; // å› ä¸º Itr æ˜¯ ArrayList çš„å†…éƒ¨ç±»ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è®¿é—® ArrayList çš„ modCountã€‚ Itr() &#123;&#125; public boolean hasNext() &#123; // å¦‚æœå½“å‰ cursor ä¸æŒ‡å‘æœ€åä¸€ä¸ªå…ƒç´ åé¢çš„ç´¢å¼•ä½ç½®ï¼Œ // è¯´æ˜å½“å‰ cursor æ‰€åœ¨ä½ç½®åé¢è¿˜æœ‰æ²¡æœ‰éå†åˆ°çš„å…ƒç´ ï¼Œè¿”å› trueã€‚ return cursor != size; // å› ä¸º Itr æ˜¯ ArrayList çš„å†…éƒ¨ç±»ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥è®¿é—® ArrayList çš„ sizeã€‚ &#125; /** * é¦–å…ˆæ£€æŸ¥ modCount == expectedModCount æ˜¯å¦æˆç«‹ï¼Œ * å¦‚æœä¸æˆç«‹ç›´æ¥æŠ›å‡º ConcurrentModificationExceptionï¼› * å¦åˆ™æŒ‰ä¸‹é¢çš„é€»è¾‘è¿è¡Œï¼š * è¿”å›å½“å‰ cursor æ‰€åœ¨ä½ç½®çš„å…ƒç´ ï¼Œ * lastRet çš„å€¼æ›´æ–°ä¸ºå½“å‰ cursor çš„å€¼ï¼Œ * cursor çš„å€¼åŠ  1ï¼Œå³æŒ‡å‘ä¸‹æ¬¡è¦è®¿é—®çš„å…ƒç´ ä½ç½®ã€‚ */ @SuppressWarnings("unchecked") public E next() &#123; checkForComodification(); int i = cursor; if (i &gt;= size) throw new NoSuchElementException(); Object[] elementData = ArrayList.this.elementData; if (i &gt;= elementData.length) throw new ConcurrentModificationException(); cursor = i + 1; return (E) elementData[lastRet = i]; &#125; final void checkForComodification() &#123; if (modCount != expectedModCount) throw new ConcurrentModificationException(); &#125; /** * ä¸ç›´æ¥ä½¿ç”¨ ArrayList çš„ remove() æ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œ * è¯¥æ–¹æ³•ä¼šæ›´æ–° expectedModCount çš„å€¼ä¸º modCountã€‚ * è¿™ä¹Ÿæ­£æ˜¯ä¸ºä»€ä¹ˆé€šè¿‡ List.iterator() éå†çš„åŒæ—¶è¿›è¡Œ * iterator().remove() æ“ä½œï¼Œä¸ä¼šå‘é€å¼‚å¸¸çš„åŸå› ã€‚ */ public void remove() &#123; if (lastRet &lt; 0) throw new IllegalStateException(); checkForComodification(); try &#123; ArrayList.this.remove(lastRet); cursor = lastRet; lastRet = -1; expectedModCount = modCount; &#125; catch (IndexOutOfBoundsException ex) &#123; throw new ConcurrentModificationException(); &#125; &#125;&#125; æ€»ç»“ï¼š ä½¿ç”¨ List.iterator() éå†é›†åˆçš„åŒæ—¶è¿›è¡Œ iterator().remove() æ“ä½œï¼Œä¸ä¼šå‘é€å¼‚å¸¸çš„åŸå› æ˜¯ï¼šIterator.remove() ä¼šåœ¨æ‰§è¡Œ ArrayList çš„ remove() åï¼Œé‡æ–°å°† expectedModCount çš„å€¼æ›´æ–°ä¸º modCount çš„å€¼ã€‚è¿™æ ·è¿è¡Œ checkForComodification() æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ­£å¸¸è¿è¡Œã€‚ æ–¹æ³•ä¸‰ï¼šä½¿ç”¨å¢å¼º for å¾ªç¯å¢å¼º for å¾ªç¯æ˜¯è¿­ä»£å™¨çš„ç®€åŒ–ä¹¦å†™æ ¼å¼ï¼Œå’Œ iterator éå†çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±è¯´å¢å¼º for å¾ªç¯çš„å†…éƒ¨ä¹Ÿå°±æ˜¯è°ƒç”¨ iterator å®ç°çš„ï¼Œåªä¸è¿‡è·å–è¿­ä»£å™¨ç”± jvm å®Œæˆï¼Œä¸éœ€è¦æˆ‘ä»¬è·å–è¿­ä»£å™¨è€Œå·²ã€‚ä½†æ˜¯å¢å¼º for å¾ªç¯æœ‰äº›ç¼ºç‚¹ï¼Œä¾‹å¦‚ä¸èƒ½åœ¨å¢å¼º for å¾ªç¯é‡ŒåŠ¨æ€çš„åˆ é™¤é›†åˆå†…å®¹ï¼ˆè™½ç„¶å†…éƒ¨ä¹Ÿä½¿ç”¨äº† Iterator ä½†åœ¨åˆ é™¤æ—¶å› ä¸ºæ‹¿ä¸åˆ° Iteratorï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡ Iterator åˆ é™¤ï¼‰ã€ä¸èƒ½è·å–ä¸‹æ ‡ç­‰ã€‚ æ‰€ä»¥è¿™ç§æ–¹å¼åªé€‚ç”¨äºåˆ é™¤ä¸€ä¸ªæŒ‡å®šå…ƒç´ åï¼Œç«‹å³é€€å‡ºå¾ªç¯çš„æƒ…å†µã€‚ 123456789101112ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;for (Integer integer : list) &#123; if (integer == 5) &#123; list.remove(integer); break; &#125;&#125; æ€»ç»“ç»è¿‡ä¸Šé¢å¯¹å¼‚å¸¸å‘ç”Ÿçš„åŸå› ä»¥åŠ 3 ç§è§£å†³åŠæ³•çš„åˆ†æï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š åªè¦æ˜¯åœ¨éå†æ—¶ç›´æ¥é€šè¿‡è°ƒç”¨ ArrayList.remove() ç§»é™¤å…ƒç´ éƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œæ™®é€šçš„ for å¾ªç¯å’Œå¢å¼º for å¾ªç¯é€‚ç”¨äºåˆ é™¤ä¸€ä¸ªå…ƒç´ åå°±é€€å‡ºå¾ªç¯ä½“ï¼›è€Œ forEach() å¾ªç¯æ˜¯åšå†³ä¸å¯ä»¥æ‰§è¡Œåˆ é™¤æ“ä½œçš„ï¼ˆå› ä¸ºå®ƒæ˜¯ç¨‹åºå‘˜æ— æ³•æ§åˆ¶é€€å‡ºå¾ªç¯çš„ï¼‰ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æœ€å®‰å…¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Iterator è¿›è¡Œéå†çš„åŒæ—¶ï¼Œå¹¶ä¸”å¿…é¡»ä½¿ç”¨ Iterator æä¾›çš„ remove() æ–¹æ³•è¿›è¡Œåˆ é™¤æ“ä½œã€‚ æ‰©å±•ä¸Šé¢åˆ†ææ˜¯ remove() æ“ä½œï¼Œé‚£ add() æ“ä½œå‘¢ï¼Ÿ æŒ‰ç…§æ€è·¯åº”è¯¥ä¹Ÿæ˜¯ä½¿ç”¨ Iterator çš„ add ä¹‹ç±»çš„æ–¹æ³•ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™ä¼šå‘ç°ï¼Œå”‰ï¼Ÿå”‰ï¼Ÿå”‰ï¼Ÿå”‰ï¼Ÿæˆ‘ iterator ç‚¹ï¼Œiterator ç‚¹â€¦â€¦ ä¸ºä»€ä¹ˆæ²¡æœ‰ç‚¹å‡ºæ¥ add ä¹‹ç±»çš„æ–¹æ³•ï¼Ÿ è¿™æ˜¯å› ä¸º Iterator æ¥å£åªæä¾›äº† remove() æ–¹æ³•ï¼ŒF***Kï¼Œè¿™å¯è®©æˆ‘å¦‚ä½•æ˜¯å¥½ï¼Ÿåˆ«æ€¥ï¼ŒList æ¥å£è¿˜æä¾›äº†ä¸€ä¸ª listIterator() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›çš„å¯¹è±¡æ˜¯å¯ä»¥è¿›è¡Œ add æ“ä½œçš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ä¸‹é¢çš„ä»£ç ï¼š 123456789101112131415161718ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();// åˆå§‹åŒ– list ä¸­çš„å€¼ä¸º 0,2,4,6,8for (int i = 0; i &lt; 10; i += 2) &#123; list.add(i);&#125;ListIterator&lt;Integer&gt; iterator = list.listIterator();// åœ¨æ¯ä¸ªå…ƒç´ åé¢è¿½åŠ ä¸€ä¸ªæ¯”è‡ªå·±å¤§ 1 çš„å…ƒç´ while (iterator.hasNext()) &#123; Integer next = iterator.next(); iterator.add(next + 1);&#125;for (Integer integer : list) &#123; System.out.print(integer);&#125; è¿è¡Œç»“æœï¼š 10123456789 é€šè¿‡æŸ¥çœ‹æºç ï¼Œå¯ä»¥å‘ç° list.listIterator() æ–¹æ³•å¦‚ä¸‹ï¼š 123public ListIterator&lt;E&gt; listIterator() &#123; return new ListItr(0);&#125; è¿™ä¸ªæ–¹æ³•è¿”å›ä¸€ä¸ª ListItr ç±»çš„å®ä¾‹ï¼Œå¹¶ä¸”è¿™ä¸ªç±»å®ç°äº† ListIterator æ¥å£ã€‚ ListIterator æ˜¯ä¸€ä¸ªåœ¨ç»§æ‰¿äº† Iterator æ¥å£çš„åŒæ—¶åˆé¢å¤–æä¾›äº† add() ã€set() ç­‰æ–¹æ³•çš„æ¥å£ï¼Œå¦‚ä¸‹å›¾ã€‚ å†çœ‹ä¸€ä¸‹ ListItr è¿™ä¸ªç±»ï¼š 12345678910111213141516171819private class ListItr extends Itr implements ListIterator&lt;E&gt; &#123; ...... /** * åŒ Itr çš„ remove æ–¹æ³•ä¸€æ ·ï¼Œå…ˆåœ¨é›†åˆä¸­æ·»åŠ å…ƒç´ ï¼Œ * æœ€åå°† modCount çš„å€¼èµ‹ç»™ expectedModCount */ public void add(E e) &#123; checkForComodification(); try &#123; int i = cursor; ArrayList.this.add(i, e); cursor = i + 1; lastRet = -1; expectedModCount = modCount; &#125; catch (IndexOutOfBoundsException ex) &#123; throw new ConcurrentModificationException(); &#125; &#125;&#125; ListItr ä¸ä½†å®ç°äº† ListIterator æ¥å£ï¼Œè€Œä¸”ç»§æ‰¿äº† Itr ç±»ï¼ˆä¸Šé¢å·²ç»åˆ†æè¿‡ï¼‰ï¼Œä»æºç ä¸­å¯ä»¥å‘ç° ListItr å†…æ²¡æœ‰å®ç° remove() æ–¹æ³•ï¼Œæ˜¾ç„¶è¿™æ˜¯ç›´æ¥å¤ç”¨å®ƒçš„çˆ¶ç±» Itr çš„ remove() æ–¹æ³•ã€‚ æ‰€ä»¥ï¼Œå¦‚æœåœ¨éå†çš„åŒæ—¶åªæ˜¯è¿›è¡Œ remove æ“ä½œï¼Œæ—¢å¯ä»¥ä½¿ç”¨ iterator ä¹Ÿå¯ä»¥ä½¿ç”¨ listIteratorï¼›è€Œè¦è¿›è¡Œ add æ“ä½œï¼Œå°±å¿…é¡»ä½¿ç”¨ listIterator äº†ã€‚ LinkedList å’Œ ArrayList ç•¥æœ‰ä¸åŒï¼Œè™½ç„¶å®ƒçš„ iterator() å’Œ listIterator() æ–¹æ³•è¿”å›çš„æ¥å£ç±»å‹ä¸åŒï¼Œä½†æ˜¯ä»”ç»†åˆ†ææºç ä¼šå‘ç°å…¶å®å†…éƒ¨éƒ½æ˜¯ ListItr å¯¹è±¡ã€‚]]></content>
      <categories>
        <category>Java</category>
        <category>é›†åˆ</category>
      </categories>
      <tags>
        <tag>é›†åˆ</tag>
        <tag>ConcurrentModificationException</tag>
        <tag>ArrayList</tag>
        <tag>LinkedList</tag>
      </tags>
  </entry>
</search>
