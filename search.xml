<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[IntentServiceæºç è§£æž]]></title>
    <url>%2Fposts%2F9e86a7ad.html</url>
    <content type="text"><![CDATA[IntentService æ˜¯ Service çš„å­ç±»ï¼Œå½“ç„¶ä¹Ÿæ˜¯ç”¨äºŽå¤„ç†è€—æ—¶æ“ä½œçš„ï¼Œé€šè¿‡ startService(Intent) å¯åŠ¨ï¼Œå¹¶ä¸”ä¼šåœ¨å·¥ä½œçº¿ç¨‹ä¸­å¤„ç†æ¯ä¸ª Intentï¼Œå¹¶åœ¨æ“ä½œç»“æŸæˆ–ä¸æ­£å¸¸æ—¶è‡ªè¡Œåœæ­¢ã€‚ è¦çœ‹æ‡‚ IntentService çš„æºç ï¼Œå¿…é¡»ç†Ÿæ‚‰ Handler æœºåˆ¶ï¼Œä¸æ˜Žç™½çš„å»ºè®®å…ˆäº†è§£ä¸€ä¸‹ Handler æœºåˆ¶ã€‚ IntentService çš„ç”¨æ³•è¦ä½¿ç”¨ IntentServiceï¼Œåªéœ€è¦åˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿ IntentService å¹¶å®žçŽ°æŠ½è±¡æ–¹æ³• onHandleIntentï¼ˆIntentï¼‰ã€‚ 12345678910111213141516171819public class InitializeService extends IntentService &#123; private static final String ACTION_INIT = "service.action.INIT"; public InitializeService() &#123; super("InitializeService"); &#125; public static void start(Application context) &#123; Intent intent = new Intent(context, InitializeService.class); intent.setAction(ACTION_INIT); context.startService(intent); &#125; @Override protected void onHandleIntent(@Nullable Intent intent) &#123; // å¤„ç†è€—æ—¶æ“ä½œ &#125;&#125; å°±è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬åªéœ€è¦æŠŠç²¾åŠ›ç”¨åœ¨é‡å†™ onHandleIntent æ–¹æ³•å¤„ç†è€—æ—¶æ“ä½œå°±å¯ä»¥äº†ï¼Œä¹Ÿä¸ç”¨å¼€å¯æ–°çš„çº¿ç¨‹ã€‚ è€Œå¦‚æžœç›´æŽ¥ä½¿ç”¨ Serviceï¼Œææ€•å°±æ²¡é‚£ä¹ˆç®€å•äº†ï¼Œæˆ‘ä»¬éœ€è¦å¤„ç†å¾ˆå¤šäº‹æƒ…ï¼Œæ¯”å¦‚è€—æ—¶æ“ä½œè¦å•ç‹¬åˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ“ä½œç»“æŸåŽè¦åœæ­¢ Service è¿è¡Œç­‰ç­‰ã€‚ é‚£ä¹ˆ IntentService æ˜¯æ€Žä¹ˆå®žçŽ°å°† Service ä¸­å¤æ‚çš„é€»è¾‘ç®€åŒ–ä¸ºåªéœ€è¦å®žçŽ°ä¸€ä¸ª onHandleIntent æ–¹æ³•å°±å¯ä»¥çš„å‘¢ï¼Ÿ å…¶å®ž IntentService æ˜¯é€šè¿‡å¯¹ Service çš„å„ä¸ªç”Ÿå‘½å‘¨æœŸè¿›è¡Œå¤„ç†ï¼Œå¹¶ç»“åˆäº† Android ä¸­å¼ºå¤§çš„ Handler æœºåˆ¶æ¥å®Œæˆçš„ã€‚ ä¸‹é¢å°±æ ¹æ® Service çš„ç”Ÿå‘½å‘¨æœŸï¼Œåˆ†æž IntentService çš„å®žçŽ°åŽŸç†ã€‚ å…ˆå€Ÿç”¨ Android å®˜ç½‘çš„ Service ç”Ÿå‘½å‘¨æœŸå›¾çœ‹ä¸€ä¸‹ï¼š ä¸‹é¢ä»¥é€šè¿‡ startService å¯åŠ¨ IntentService ä¸ºä¾‹ï¼Œè¿›è¡Œåˆ†æžã€‚ OnCreateä¸‹é¢æ˜¯ IntentService çš„ onCreate æ–¹æ³•çš„æºç ï¼š IntentService.java 1234567891011private volatile Looper mServiceLooper;private volatile ServiceHandler mServiceHandler;@Overridepublic void onCreate() &#123; super.onCreate(); HandlerThread thread = new HandlerThread("IntentService[" + mName + "]"); thread.start(); mServiceLooper = thread.getLooper(); mServiceHandler = new ServiceHandler(mServiceLooper);&#125; åˆ›å»ºä¸€ä¸ª HandlerThreadï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªå­çº¿ç¨‹ï¼Œå¹¶å¯åŠ¨è¿™ä¸ªçº¿ç¨‹ã€‚èŽ·å–è¿™ä¸ªçº¿ç¨‹ç»‘å®šçš„ Looperï¼Œå†åˆ©ç”¨è¿™ä¸ª Looper åˆ›å»ºä¸€ä¸ª Handlerï¼Œå› ä¸ºè¿™ä¸ª Looper æ˜¯ä¸Ž HandlerThreadï¼ˆä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹ï¼‰ç»‘å®šçš„ï¼Œæ‰€ä»¥ä¸Žè¿™ä¸ª Looper å…³è”çš„ Handler ä¹Ÿå°±åœ¨ HandlerThread çº¿ç¨‹ä¸­æŽ¥æ”¶ä¸Žå¤„ç†æ¶ˆæ¯ã€‚ HandlerThread å¯åŠ¨åŽï¼Œå¿…ç„¶ä¼šè¿è¡Œ run() æ–¹æ³•ï¼ŒæŽ¥ä¸‹æ¥çœ‹ä¸€ä¸‹ HandlerThread.run()ã€‚ HandlerThread.java 1234567891011121314151617181920212223242526272829303132333435363738394041/** * è¯¥æ–¹æ³•ä¸»è¦æ˜¯æ ‡å‡†çš„ Looper çš„ä½¿ç”¨æ­¥éª¤ */ @Overridepublic void run() &#123; mTid = Process.myTid(); // 1. Looper.prepare(); synchronized (this) &#123; // 2. å°†å½“å‰çº¿ç¨‹çš„ Looper èµ‹å€¼ç»™ mLooperï¼Œå¹¶é€šçŸ¥æ­£åœ¨ç­‰å¾…ä½¿ç”¨ mLooper çš„åœ°æ–¹ mLooper = Looper.myLooper(); notifyAll(); &#125; Process.setThreadPriority(mPriority); onLooperPrepared(); // 3. Looper.loop(); mTid = -1;&#125;/** * æ­¤æ–¹æ³•å°†è¿”å›žä¸Žæ­¤çº¿ç¨‹å…³è”çš„Looperã€‚ * å¦‚æžœæœªå¯åŠ¨æ­¤çº¿ç¨‹æˆ– isAlive() è¿”å›žfalseï¼Œæ­¤æ–¹æ³•å°†è¿”å›žnullã€‚ * å¦‚æžœè¯¥çº¿ç¨‹å·²ç»å¯åŠ¨ï¼Œè¯¥æ–¹æ³•å°†é˜»å¡žï¼Œç›´åˆ°looperè¢«åˆå§‹åŒ–ã€‚ */public Looper getLooper() &#123; if (!isAlive()) &#123; return null; &#125; // If the thread has been started, wait until the looper has been created. synchronized (this) &#123; while (isAlive() &amp;&amp; mLooper == null) &#123; try &#123; wait(); &#125; catch (InterruptedException e) &#123; &#125; &#125; &#125; return mLooper;&#125; å½“ HandlerThread å¯åŠ¨åŽï¼Œåœ¨ run æ–¹æ³•ä¸­ä¼šè°ƒç”¨ Looper.prepare() æ–¹æ³•åˆ›å»º Looper çš„å®žä¾‹å¹¶ä¸Ž HandlerThread çº¿ç¨‹ç›¸å…³è”ï¼Œç„¶åŽè°ƒç”¨ Looper.loop() æ–¹æ³•å¼€å§‹å¾ªçŽ¯å¤„ç†æ¶ˆæ¯ã€‚ onStartCommand/onStart123456789101112131415161718192021222324252627282930@Overridepublic void onStart(@Nullable Intent intent, int startId) &#123; Message msg = mServiceHandler.obtainMessage(); msg.arg1 = startId; msg.obj = intent; mServiceHandler.sendMessage(msg);&#125;/** * æˆ‘ä»¬ä¸åº”è¯¥åœ¨ InentService ä¸­é‡å†™æ­¤æ–¹æ³•ï¼Œè€Œåº”è¯¥é‡å†™ onHandleIntent()ï¼Œ * å½“ IntentService æ”¶åˆ°ä¸€ä¸ªè¯·æ±‚æ—¶ï¼Œç³»ç»Ÿä¼šè°ƒç”¨å®ƒã€‚ */@Overridepublic int onStartCommand(@Nullable Intent intent, int flags, int startId) &#123; onStart(intent, startId); return mRedelivery ? START_REDELIVER_INTENT : START_NOT_STICKY;&#125;/** * onBind æ–¹æ³•é»˜è®¤è¿”å›ž nullï¼Œå¹¶ä¸”é€šè¿‡ bindService() å¯åŠ¨çš„ IntentService çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ï¼š * onCreate()-&gt;onBind()-&gt;onunbind()-&gt;onDestory(); * è¿™ç§æ–¹å¼ä¸ä¼šè°ƒç”¨ onStartCommand() å’Œ onStart() æ–¹æ³•ï¼Œ * æ‰€ä»¥ä¸ä¼šå°†æ¶ˆæ¯å‘é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­åŽ»ï¼Œä¹Ÿå°±ä¸ä¼šæ‰§è¡Œ onHandleIntent() å›žè°ƒï¼Œ * å¤±åŽ»äº† IntentService çš„ä¼˜åŠ¿ã€‚æ‰€ä»¥ä¸å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ */@Override@Nullablepublic IBinder onBind(Intent intent) &#123; return null;&#125; onStartCommand æ–¹æ³•å†…éƒ¨ä¼šè°ƒç”¨ onStart æ–¹æ³•ï¼ŒonStart æ–¹æ³•ä¸­å°±æ˜¯åˆ›å»ºä¸€ä¸ª Message å¯¹è±¡ï¼Œå¹¶æŠŠ Intent å’Œ startId ä¿å­˜åˆ°è¿™ä¸ª Message å¯¹è±¡ä¸­ï¼Œæœ€åŽé€šè¿‡ mServiceHandler å‘é€æ¶ˆæ¯ã€‚ 123456789101112131415161718192021222324private final class ServiceHandler extends Handler &#123; public ServiceHandler(Looper looper) &#123; super(looper); &#125; @Override public void handleMessage(Message msg) &#123; onHandleIntent((Intent)msg.obj); stopSelf(msg.arg1); &#125;&#125;/** * è¿™ä¸ªæ–¹æ³•åœ¨å·¥ä½œçº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå¹¶å¤„ç†è€—æ—¶æ“ä½œï¼Œä¸€æ¬¡åªå¤„ç†ä¸€ä¸ª Intentã€‚ * å³è‹¥ä¸€ä¸ªä»»åŠ¡æ­£åœ¨IntentServiceä¸­æ‰§è¡Œï¼Œæ­¤æ—¶ä½ å†å‘é€1ä¸ªæ–°çš„ä»»åŠ¡è¯·æ±‚ï¼Œ * è¿™ä¸ªæ–°çš„ä»»åŠ¡ä¼šä¸€ç›´ç­‰å¾…ç›´åˆ°å‰é¢ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åŽæ‰å¼€å§‹æ‰§è¡Œã€‚ * å› ä¸ºåœ¨ Service æ²¡æœ‰è¢«é”€æ¯å‰ï¼ŒonCreate()åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼Œæ‰€ä»¥åªä¼šåˆ›å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼› * å½“å¤šæ¬¡è°ƒç”¨ startService(Intent)æ—¶ï¼ˆå³ onStartCommandï¼ˆï¼‰ä¹Ÿä¼šè°ƒç”¨å¤šæ¬¡ï¼‰ï¼Œå…¶å®žä¸ä¼šåˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œåªæ˜¯æŠŠæ¶ˆæ¯åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ä¸­å¹¶ç­‰å¾…æ‰§è¡Œã€‚ * å¤„ç†æ¶ˆæ¯çš„ Looperï¼ŒHandlerï¼Œä»¥åŠ onHandleIntent() éƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œ * æ‰€ä»¥å½“ Looper ä»Žæ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºä¸€æ¡æ¶ˆæ¯åŽï¼Œåªæœ‰åœ¨ onHandleIntent() æ‰§è¡Œå®Œæ¯•åŽï¼Œæ‰ä¼šå–ä¸‹ä¸€æ¡æ¶ˆæ¯ã€‚ * å½“æ‰€æœ‰è¯·æ±‚éƒ½è¢«å¤„ç†åŽï¼ŒIntentService å°±ä¼šåœæ­¢ï¼Œæˆ‘ä»¬ä¹Ÿä¸ç”¨æ‰‹åŠ¨åœæ­¢ã€‚ */@WorkerThreadprotected abstract void onHandleIntent(@Nullable Intent intent); å› ä¸º ServiceHandler æ˜¯åœ¨å­çº¿ç¨‹ä¸­æŽ¥æ”¶æ¶ˆæ¯ï¼Œæ‰€ä»¥handleMessage() æ–¹æ³•è‡ªç„¶ä¹Ÿå°±åœ¨å­çº¿ç¨‹ä¸­å¤„ç†ï¼ŒonHandleIntent() åŒæ ·å¦‚æ­¤ï¼Œæœ€åŽå¤„ç†ç»“æŸåŽè°ƒç”¨ stopSelf æ–¹æ³•åœæ­¢ Service è¿è¡Œã€‚ ä¸ºä»€ä¹ˆå½“æœ‰å¤šä¸ªä»»åŠ¡æ—¶ hanndleMessage ä¸­ stopSelf(msg.arg1) ä¸ä¼šç»ˆæ­¢ Serviceï¼Ÿå› ä¸ºåœ¨ onStartCommand ä¸­ä¼šä¼ å…¥ä¸€ä¸ª startIdï¼Œè¿™ä¸ª startId ä¿å­˜åœ¨ msg.arg1 ä¸­ï¼Œå› æ­¤æ¯æ¬¡è°ƒç”¨ startService() éƒ½ä¼šå›žè°ƒè¿™ä¸ªæ–¹æ³•ï¼Œæ‰€ä»¥æ¯ä¸ª startId ä¹Ÿå°±ä¸åŒï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼Œæ¯å½“æˆ‘ä»¬è°ƒç”¨startService()å¯åŠ¨ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œä¸ä½†ä¼šåœ¨å…¶å¯¹åº”çš„ ServiceRecord èŠ‚ç‚¹çš„ pendingStarts é‡Œæ’å…¥ä¸€ä¸ªæ–°çš„ StartItem èŠ‚ç‚¹ï¼Œè€Œä¸”ä¼šä¸ºè¿™ä¸ª StartItem èŠ‚ç‚¹ç”Ÿæˆä¸€ä¸ªæ–°çš„ id å·ï¼Œè¿™ä¸ª id å·å°±æ˜¯æ—¥åŽçš„ startIdï¼ˆç”Ÿæˆidå·æ—¶ï¼Œé‡‡ç”¨çš„åŠžæ³•æ˜¯æœ€ç®€å•çš„åŠ 1æ“ä½œï¼‰ã€‚ è€Œåœ¨ stopSelf() ä¸­ä¼ å…¥çš„ä¹Ÿæ˜¯è¿™ä¸ª startIdï¼Œæ‰€ä»¥åœ¨å…³é—­æ—¶ï¼Œä¼šå…³é—­è¿™ä¸ª startId æŒ‡å®šçš„ä»»åŠ¡ï¼ŒåŒæ—¶ä¼šåˆ¤æ–­æ˜¯å¦æ˜¯æœ€åŽä¸€ä¸ª startIdï¼Œå¦‚æžœæ˜¯æœ€åŽä¸€ä¸ªæ‰çœŸæ­£çš„ç»“æŸ Serviceï¼Œå¦åˆ™ä¸ç»“æŸã€‚ ä¹Ÿå°±æ˜¯æŒ‰åºä»Ž ServiceRecord çš„ deliveredStarts åˆ—è¡¨ä¸­åˆ é™¤ StartItem èŠ‚ç‚¹ï¼Œç›´åˆ°æ‰€åˆ é™¤çš„æ˜¯ startId å‚æ•°å¯¹åº”çš„ StartItem èŠ‚ç‚¹ï¼Œå¦‚æžœæ­¤æ—¶å°šæœªæŠµè¾¾ ServiceRecord å†…éƒ¨è®°å½•çš„æœ€åŽä¸€ä¸ª start Id æ—¶ï¼Œåˆ™è¯´æ˜Žæ­¤æ¬¡ stopSelf()æ“ä½œæ²¡å¿…è¦è¿›ä¸€æ­¥ç»“æŸserviceï¼Œé‚£ä¹ˆç›´æŽ¥ return false å°±å¯ä»¥äº†ã€‚åªæœ‰åœ¨æ‰€åˆ é™¤çš„ startItem èŠ‚ç‚¹çš„ç¡®æ˜¯æœ€åŽä¸€ä¸ª startItem èŠ‚ç‚¹æ—¶ï¼Œæ‰ä¼šè°ƒç”¨ bringDownServiceIfNeededLocked() åŽ»ç»“æŸ serviceã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ IntentService çš„ ServiceHandler åœ¨å¤„ç†å®Œæ¶ˆæ¯åŽï¼Œå¯ä»¥æ”¾å¿ƒè°ƒç”¨ stopSelf() çš„åŽŸå› ã€‚ å‚è€ƒæ–‡ç« https://my.oschina.net/youranhongcha/blog/785387 onDestroy1234@Overridepublic void onDestroy() &#123; mServiceLooper.quit();&#125; å½“ Service çœŸæ­£åœæ­¢æ—¶ä¼šå›žè°ƒ onDestroy() ï¼Œè¿™æ—¶ mServiceLooper ä¼šé€€å‡ºå¾ªçŽ¯ã€‚ IntentService VS Service è¿è¡Œçº¿ç¨‹ ç»“æŸ IntentService è‡ªåŠ¨åˆ›å»ºå·¥ä½œçº¿ç¨‹å¤„ç†ä»»åŠ¡ è‡ªåŠ¨ç»“æŸï¼Œä¸éœ€è¦å¤„ç†ã€‚ Service ä¸»çº¿ç¨‹ä¸èƒ½å¤„ç†è€—æ—¶æ“ä½œï¼Œéœ€ç¼–å†™ä»£ç åˆ›å»ºå­çº¿ç¨‹ã€‚ éœ€è¦ä¸»åŠ¨è°ƒç”¨stopService() IntentService VS æ™®é€šçº¿ç¨‹ çº¿ç¨‹ä¼˜å…ˆçº§ IntentService é«˜ä¸å®¹æ˜“è¢«ç³»ç»Ÿæ€æ­» æ™®é€šçº¿ç¨‹ ä½Žè‹¥è¿›ç¨‹ä¸­æ— æ´»åŠ¨çš„å››å¤§ç»„ä»¶ï¼Œåˆ™è¯¥çº¿ç¨‹çš„ä¼˜å…ˆçº§éžå¸¸ä½Žï¼Œå®¹æ˜“è¢«ç³»ç»Ÿæ€æ­»ã€‚]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>IntentService</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Handleræ¶ˆæ¯æœºåˆ¶æºç è§£æž]]></title>
    <url>%2Fposts%2Ff49e176e.html</url>
    <content type="text"><![CDATA[Handler æ¶ˆæ¯æœºåˆ¶æ˜¯ç”± Message MessageQueue Handler Looper å…±åŒå®Œæˆçš„ã€‚ Handler æ¶ˆæ¯æœºåˆ¶æ˜¯ç”¨äºŽåœ¨åŒä¸€ä¸ªè¿›ç¨‹ä¸­çš„å¤šä¸ªçº¿ç¨‹ä¹‹é—´è¿›è¡Œé€šä¿¡çš„ã€‚ç”±äºŽå·¥ä½œçº¿ç¨‹ä¸Žä¸»çº¿ç¨‹å…±äº«åœ°å€ç©ºé—´ï¼Œå³ Handler å®žä¾‹å¯¹è±¡ mHandler ä½äºŽçº¿ç¨‹é—´å…±äº«çš„å†…å­˜å †ä¸Šï¼Œæ‰€ä»¥å·¥ä½œçº¿ç¨‹ä¸Žä¸»çº¿ç¨‹éƒ½èƒ½ç›´æŽ¥ä½¿ç”¨è¯¥å¯¹è±¡ï¼Œåªéœ€è¦æ³¨æ„å¤šçº¿ç¨‹çš„åŒæ­¥é—®é¢˜ã€‚å·¥ä½œçº¿ç¨‹é€šè¿‡ mHandler å‘å…¶æˆå‘˜å˜é‡ MessageQueue ä¸­æ·»åŠ æ–° Messageï¼Œä¸»çº¿ç¨‹ä¸€ç›´å¤„äºŽ loop() æ–¹æ³•ä¸­ï¼Œå½“æ”¶åˆ°æ–°çš„ Message æ—¶æŒ‰ç…§ä¸€å®šè§„åˆ™åˆ†å‘ç»™ç›¸åº”çš„ handleMessage() æ–¹æ³•æ¥å¤„ç†ã€‚æ‰€ä»¥è¯´ï¼ŒHandler æ¶ˆæ¯æœºåˆ¶ç”¨äºŽåŒè¿›ç¨‹çš„çº¿ç¨‹é—´é€šä¿¡çš„æ ¸å¿ƒæ˜¯çº¿ç¨‹é—´å…±äº«å†…å­˜ç©ºé—´ï¼Œè€Œä¸åŒè¿›ç¨‹æ‹¥æœ‰ä¸åŒçš„åœ°å€ç©ºé—´ï¼Œä¹Ÿå°±ä¸èƒ½ç”¨ Handler æ¥å®žçŽ°è¿›ç¨‹é—´é€šä¿¡ã€‚ æ—¢ç„¶æ˜¯ç”¨æ¥é€šä¿¡çš„æ¶ˆæ¯æœºåˆ¶ï¼Œé‚£ç”¨ä»€ä¹ˆæ¥é€šä¿¡å‘¢ï¼Ÿå½“ç„¶æ˜¯ Messageï¼Œä¸‹é¢å°±å…ˆä»‹ç»ä¸€ä¸‹ Messageã€‚ MessageMessage é»˜è®¤æä¾›äº†ä¸¤ä¸ª int å±žæ€§å’Œä¸€ä¸ª object å±žæ€§ï¼Œèƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬å¤§å¤šæ•°æƒ…å†µçš„éœ€æ±‚ã€‚ å…³äºŽ Message ä¸»è¦éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ€Žæ ·æ­£ç¡®çš„åˆ›å»ºä¸€ä¸ª Message å¯¹è±¡ï¼Ÿå°½ç®¡ Message çš„æž„é€ å‡½æ•°æ˜¯å…¬å…±çš„ï¼Œä½†æ˜¯æœ€å¥½çš„æ–¹æ³•ï¼ˆæ•ˆçŽ‡é«˜ï¼Œé¿å…é‡å¤åˆ›å»ºå¯¹è±¡ï¼‰å´æ˜¯é€šè¿‡è°ƒç”¨ Message.obtain() æˆ–è€… Handler.obtainMessage() æ–¹æ³•ï¼Œä»Žæ¶ˆæ¯æ± ä¸­å›žæ”¶çš„ Message ä¸­èŽ·å–ã€‚ 1234Message next;private static Message sPool;private static int sPoolSize = 0;private static final int MAX_POOL_SIZE = 50; ä¸Šé¢å‡ ä¸ªå±žæ€§æ˜¯ Message ä¸­å£°æ˜Žçš„ï¼Œæ¯ä¸ª Message å¯¹è±¡éƒ½å¯ä»¥é€šè¿‡ä¸º next å±žæ€§èµ‹å€¼ï¼Œæ·»åŠ ä¸€ä¸ªåŽç»§å…ƒç´ ï¼Œè¿™æ ·å¤šä¸ª Message å¯¹è±¡å°±ç»„æˆäº†ä¸€ä¸ªå•é“¾è¡¨ï¼›è€Œ sPool å°±æ˜¯é“¾è¡¨çš„è¡¨å¤´ä½ç½®çš„ Message å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯å¤´æŒ‡é’ˆã€‚æ­¤å¤–æˆ‘ä»¬è¿˜å¯ä»¥äº†è§£åˆ°è¿™ä¸ªé“¾è¡¨çš„æœ€å¤§é•¿åº¦ä¸º 50ã€‚ é‚£ä¹ˆè¿™ä¸ªé“¾è¡¨æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ ç­”æ¡ˆå°±æ˜¯ç”¨æ¥ä¿å­˜å·²ç»ç”¨è¿‡çš„ Messageï¼Œè¿™ä¸ªä¿å­˜æ˜¯é€šè¿‡ recyclerUnchecked() æ–¹æ³•å®žçŽ°çš„ï¼Œè€Œä¸”è¿™ä¸ªæœºåˆ¶æ˜¯åœ¨ Looper ä¸­æ¶ˆæ¯è¢«å¤„ç†å®Œæˆä¹‹åŽè§¦å‘çš„ã€‚ 123456789101112131415161718192021222324252627282930313233public void recycle() &#123; if (isInUse()) &#123; if (gCheckRecycle) &#123; throw new IllegalStateException("This message cannot be recycled because it " + "is still in use."); &#125; return; &#125; recycleUnchecked();&#125;void recycleUnchecked() &#123; flags = FLAG_IN_USE; // å°†æ‰€æœ‰æ•°æ®æ¸…ç©º what = 0; arg1 = 0; arg2 = 0; obj = null; replyTo = null; sendingUid = -1; when = 0; target = null; callback = null; data = null; synchronized (sPoolSync) &#123; if (sPoolSize &lt; MAX_POOL_SIZE) &#123; // å¦‚æžœå½“å‰æ¶ˆæ¯æ± æœªæ»¡å°±æŠŠ Message æ’å…¥åˆ°æ¶ˆæ¯æ± çš„å¤´éƒ¨ next = sPool; sPool = this; sPoolSize++; &#125; &#125;&#125; çŽ°åœ¨æ˜Žç™½äº†æ¶ˆæ¯æ± ä¸­çš„æ¶ˆæ¯æ˜¯æ€Žä¹ˆæ¥çš„ï¼Œå†æ¥çœ‹ obtain() è¿™ä¸ªæ–¹æ³•æ˜¯æ€Žä¹ˆä»Žæ¶ˆæ¯æ± ä¸­å–å‡ºæ¶ˆæ¯çš„ã€‚ 12345678910111213141516public static Message obtain() &#123; synchronized (sPoolSync) &#123; if (sPool != null) &#123; // å¦‚æžœæ¶ˆæ¯æ± çš„ç¬¬ä¸€ä¸ªæ¶ˆæ¯ sPool ä¸ä¸ºnullï¼Œä¹Ÿå°±æ„å‘³ç€æ¶ˆæ¯æ± ä¸­æœ‰æ¶ˆæ¯ï¼Œå°±å°†å®ƒä»Žæ¶ˆæ¯æ± ä¸­å–å‡ºæ¥ã€‚ Message m = sPool; // å°† sPool æ”¹ä¸ºæ¶ˆæ¯æ± çš„ç¬¬äºŒä¸ªæ¶ˆæ¯ sPool = m.next; m.next = null; m.flags = 0; // clear in-use flag sPoolSize--; return m; &#125; &#125; // å¦‚æžœæ¶ˆæ¯æ± ä¸­æ²¡æœ‰ Messageï¼Œå°±åˆ›å»ºæ–°çš„ Messageã€‚ return new Message();&#125; çŽ°åœ¨å·²ç»é€šè¿‡æ­£ç¡®çš„æ–¹å¼å¾—åˆ°äº†ä¸€ä¸ª Message å¯¹è±¡å®žä¾‹ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‘é€çš„æ¶ˆæ¯åœ¨å“ªä¿å­˜å‘¢ï¼Ÿä¸‹é¢å°±åˆ°äº† MessageQueue å‡ºåœºäº†ã€‚ MessageQueueMessageQueue çš„æž„é€ æ–¹æ³•ï¼š 1234567// True if the message queue can be quit.private final boolean mQuitAllowed;MessageQueue(boolean quitAllowed) &#123; mQuitAllowed = quitAllowed; mPtr = nativeInit();&#125; mQuitAllowed ç”¨æ¥æ ‡è®°è¿™ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ˜¯å¦å¯ä»¥é€€å‡ºï¼Œäº‹å®žä¹Ÿè¯æ˜Žè¿™ä¸ªå˜é‡åªåœ¨ quit() æ–¹æ³•ä¸­ç”¨åˆ°äº†ï¼Œä¸»çº¿ç¨‹æ˜¯ä¸å¯ä»¥é€€å‡ºçš„ã€‚æˆ‘ä»¬åˆ›å»ºçš„ MessageQueue éƒ½æ˜¯å¯ä»¥é€€å‡ºçš„ï¼Œä¸¥æ ¼æ¥è¯´æ˜¯å¿…éœ€é€€å‡ºçš„ã€‚å› ä¸ºè¿™ä¸ª MessageQueue æ˜¯åœ¨ Looper ä¸­åˆ›å»ºçš„ï¼Œè€Œä¸”åˆ›å»ºæ—¶ä¹Ÿç¡®å®žæ˜¯ä¼ å…¥çš„ trueï¼ŒåŽé¢åœ¨ Looper ä¸­ä¼šä»‹ç»ã€‚ MessageQueue çš„ä¸¤å¤§ä¸»è¦ä½œç”¨å°±æ˜¯ï¼š ä¿å­˜æ¶ˆæ¯ï¼šboolean enqueueMessage(Message msg, log when) å–å‡ºæ¶ˆæ¯ï¼šMessage next() enqueueuMessage()12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152boolean enqueueMessage(Message msg, long when) &#123; if (msg.target == null) &#123; throw new IllegalArgumentException("Message must have a target."); &#125; if (msg.isInUse()) &#123; throw new IllegalStateException(msg + " This message is already in use."); &#125; synchronized (this) &#123; if (mQuitting) &#123; IllegalStateException e = new IllegalStateException( msg.target + " sending message to a Handler on a dead thread"); Log.w(TAG, e.getMessage(), e); msg.recycle(); return false; &#125; msg.markInUse(); msg.when = when; // mMessages ä»£è¡¨é“¾è¡¨å¤´ç»“ç‚¹çš„æ¶ˆæ¯ Message p = mMessages; boolean needWake; if (p == null || when == 0 || when &lt; p.when) &#123; // å¦‚æžœ p ä¸º null è¡¨ç¤º MessageQueue ä¸­æ²¡æœ‰æ¶ˆæ¯ï¼Œå¦‚æžœ when = 0 æˆ–è€…è§¦å‘æ—¶é—´æ¯”é“¾è¡¨å¤´ç»“ç‚¹çš„æ¶ˆæ¯æ—¶é—´è¿˜æ—©ï¼Œå°±ç›´æŽ¥æ’å…¥é“¾è¡¨å¤´éƒ¨ // New head, wake up the event queue if blocked. msg.next = p; mMessages = msg; needWake = mBlocked; &#125; else &#123; needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous(); Message prev; for (;;) &#123; // è¦æ’å…¥ msg çš„å‰é©±å…ƒç´  prev = p; // è¦æ’å…¥ msg çš„åŽç»§å…ƒç´  p = p.next; if (p == null || when &lt; p.when) &#123; // p ä¸º null è¡¨ç¤ºåˆ°è¾¾é“¾è¡¨æœ«å°¾ï¼Œwhen &lt; p.when è¡¨ç¤ºæ–° msg çš„è§¦å‘æ—¶é—´æ¯” p çš„æ—©ï¼Œæ’å…¥åˆ°å®ƒçš„å‰é¢å°±è¡Œäº†ã€‚ break; &#125; if (needWake &amp;&amp; p.isAsynchronous()) &#123; needWake = false; &#125; &#125; msg.next = p; // invariant: p == prev.next prev.next = msg; &#125; // We can assume mPtr != 0 because mQuitting is false. if (needWake) &#123; nativeWake(mPtr); &#125; &#125; return true;&#125; å¯ä»¥çœ‹å‡ºï¼ŒMessageQueue æ˜¯å°†æ¯ä¸ª Message æŒ‰ç…§ when(è§¦å‘æ—¶é—´)è¿›è¡ŒæŽ’åˆ—ï¼Œå¹¶å­˜å‚¨åˆ°é“¾è¡¨ä¸­ï¼Œå½“æœ‰æ–°çš„ Message éœ€è¦æ·»åŠ æ—¶ï¼Œä»Žé“¾è¡¨çš„ç¬¬ä¸€ä¸ª Message å¼€å§‹å¾ªçŽ¯éåŽ†ï¼Œç›´åˆ°æ–° Message çš„ when æ¯”å½“å‰éåŽ†åˆ°çš„ Message çš„ when è¦æ—©ï¼Œå°±æŠŠæ–° Message æ’å…¥åˆ°å½“å‰éåŽ†åˆ°çš„ Message ä¹‹å‰ï¼Œå¦‚æžœæ²¡æœ‰éåŽ†åˆ°ï¼Œå°±å°†æ–°çš„ Message æ’å…¥åˆ°é“¾è¡¨å°¾éƒ¨ã€‚ next()ä¸»è¦æ˜¯ä»Ž MessageQueue ä¸­å–å‡ºå¤´éƒ¨çš„æ¶ˆæ¯ï¼Œå…·ä½“ç»†èŠ‚éƒ½æ˜¯æ¶‰åŠåˆ°æ•°æ®ç»“æž„çš„æ“ä½œã€‚ removeMessages()Handler ä¸­æä¾›äº†å‡ ä¸ª removeMessages() å’Œ removeCallbacks() ä»¥åŠ removeCallbacksAndMessages() æ–¹æ³•ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨å†…éƒ¨çš„ messageQueue çš„ removeMessages() æ–¹æ³•ï¼Œå°†æ¶ˆæ¯ä»Ž MessageQueue ä¸­ç§»é™¤ã€‚ çŽ°åœ¨ Message å’Œä¿å­˜ Message çš„ MessageQueue éƒ½äº†è§£äº†ï¼Œå¯è°“æ˜¯ä¸‡äº‹å…·å¤‡åªæ¬ ä¸œé£Žäº†ï¼Œä¸‹é¢å¼€å§‹å‘å°„ã€‚ã€‚ã€‚ Handler Handler å…è®¸æˆ‘ä»¬å‘é€å’Œå¤„ç†ä¸Žå½“å‰çº¿ç¨‹å…³è”çš„ MessageQueue ä¸­çš„ Message å¯¹è±¡ã€‚æ¯ä¸ª Handler å®žä¾‹éƒ½ä¸Žå•ä¸ªçº¿ç¨‹ä»¥åŠè¯¥çº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ç›¸å…³è”ã€‚å½“åˆ›å»ºä¸€ä¸ªæ–°çš„ Handler æ—¶ï¼Œå®ƒç»‘å®šåˆ°åˆ›å»ºå®ƒçš„çº¿ç¨‹å’Œçº¿ç¨‹çš„æ¶ˆæ¯é˜Ÿåˆ—ä¸Šã€‚è¿™æ ·ï¼Œå®ƒå°±å¯ä»¥å°†æ¶ˆæ¯ä¼ é€’åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶åœ¨æ¶ˆæ¯ä»Žé˜Ÿåˆ—å‡ºæ¥æ—¶æ‰§è¡Œå®ƒä»¬ã€‚ å½“åº”ç”¨ç¨‹åºåˆ›å»ºä¸€ä¸ªè¿›ç¨‹æ—¶ï¼Œå…¶ä¸»çº¿ç¨‹å°†ä¸“é—¨è¿è¡Œä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—ï¼Œè´Ÿè´£ç®¡ç†é¡¶å±‚åº”ç”¨ç¨‹åºå¯¹è±¡ï¼ˆactivitiesï¼Œ broadcast receivers ç­‰ï¼‰ä»¥åŠå®ƒä»¬åˆ›å»ºçš„ä»»ä½•çª—å£ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºè‡ªå·±çš„çº¿ç¨‹ï¼Œå¹¶é€šè¿‡ Handler çš„ post æˆ– sendMessage æ–¹æ³•ä¸Žåº”ç”¨ç¨‹åºä¸»çº¿ç¨‹è¿›è¡Œé€šä¿¡ï¼Œç„¶åŽ Message å°†åœ¨ Handler çš„ MessageQueue ä¸­è¿›è¡Œè°ƒåº¦ï¼Œå¹¶åœ¨é€‚å½“çš„æ—¶å€™è¿›è¡Œå¤„ç†ã€‚ è¦ä½¿ç”¨ Handlerï¼Œé¦–å…ˆè¦èŽ·å–åˆ° Handler çš„å®žä¾‹ï¼Œå› ä¸ºå®ƒæ²¡æœ‰æä¾›é™æ€çš„åˆ›å»ºå®žä¾‹çš„æ–¹æ³•ï¼Œæ‰€ä»¥æˆ‘ä»¬åªèƒ½é€šè¿‡å®ƒçš„æž„é€ æ–¹æ³•åˆ›å»ºã€‚Handler æä¾›äº†å¾ˆå¤šæž„é€ æ–¹æ³•ï¼Œä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼š ç¬¬ä¸€ç±»æž„é€ æ–¹æ³•12345678910111213141516171819202122232425262728293031public Handler() &#123; this(null, false);&#125;public Handler(Callback callback) &#123; this(callback, false);&#125;public Handler(boolean async) &#123; this(null, async);&#125;public Handler(Callback callback, boolean async) &#123; if (FIND_POTENTIAL_LEAKS) &#123; // åŒ¿åç±»ã€å†…éƒ¨ç±»æˆ–æœ¬åœ°ç±»éƒ½å¿…é¡»ç”³æ˜Žä¸ºstaticï¼Œå¦åˆ™ä¼šè­¦å‘Šå¯èƒ½å‡ºçŽ°å†…å­˜æ³„éœ² final Class&lt;? extends Handler&gt; klass = getClass(); if ((klass.isAnonymousClass() || klass.isMemberClass() || klass.isLocalClass()) &amp;&amp; (klass.getModifiers() &amp; Modifier.STATIC) == 0) &#123; Log.w(TAG, "The following Handler class should be static or leaks might occur: " + klass.getCanonicalName()); &#125; &#125; mLooper = Looper.myLooper(); if (mLooper == null) &#123; throw new RuntimeException( "Can't create handler inside thread that has not called Looper.prepare()"); &#125; mQueue = mLooper.mQueue; mCallback = callback; mAsynchronous = async;&#125; ç¬¬ä¸€ç±»æž„é€ æ–¹æ³•ï¼Œéƒ½æ˜¯é»˜è®¤ä½¿ç”¨å½“å‰çº¿ç¨‹çš„ Looper ä¸Ž Handler ç›¸å…³è”ï¼Œå¹¶ä¸”å¯ä»¥è®¾ç½®å›žè°ƒå’Œæ˜¯å¦ä¸ºå¼‚æ­¥ã€‚Okï¼Œæ—¢ç„¶æœ‰äº†æž„é€ æ–¹æ³•ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å®ƒäº†ã€‚äºŽæ˜¯æˆ‘ä»¬å°±è¿™æ ·åˆ›å»ºä¸€ä¸ª Handler å¯¹è±¡ã€‚ 123456789public class SampleActivity extends Activity &#123; private Handler mHandler = new Handler() &#123; @Override public void handleMessage(Message msg) &#123; // ... &#125; &#125;&#125; æ²¡é—®é¢˜å§ï¼Œä½†æ˜¯ä¼šå‘çŽ° Android Studio ä¼šå‘å‡ºå¦‚ä¸‹è­¦å‘Šï¼š This Handler class should be static or leaks might occur (anonymous android.os.Handler).Since this Handler is declared as an inner class, it may prevent the outer class from being garbage collected. If the Handler is using a Looper or MessageQueue for a thread other than the main thread, then there is no issue. If the Handler is using the Looper or MessageQueue of the main thread, you need to fix your Handler declaration, as follows: Declare the Handler as a static class; In the outer class, instantiate a WeakReference to the outer class and pass this object to your Handler when you instantiate the Handler; Make all references to members of the outer class using the WeakReference object. å·´æ‹‰å·´æ‹‰ä¸€å¤§å †ï¼Œå…¶å®žå°±æ˜¯å‘Šè¯‰æˆ‘ä»¬è¿™æ ·åˆ›å»º Handler å¯èƒ½ä¼šå‘ç”Ÿå†…å­˜æ³„æ¼ã€‚å› ä¸ºåœ¨ Java ä¸­ï¼Œéžé™æ€å†…éƒ¨ç±»æˆ–åŒ¿åç±»ä¼šæŒæœ‰å…¶å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œå¯¼è‡´å³ä½¿å¤–éƒ¨ç±»ä¸å†ä½¿ç”¨ä¹Ÿä¸èƒ½è¢«åžƒåœ¾å›žæ”¶æœºåˆ¶å›žæ”¶ã€‚å¦‚æžœ Handler æ˜¯åœ¨éžä¸»çº¿ç¨‹ä¸­ä½¿ç”¨ Looper æˆ– MessageQueueï¼Œåˆ™æ²¡æœ‰é—®é¢˜ï¼ˆä¸æ˜Žç™½ä¸ºä»€ä¹ˆï¼Œè™½ç„¶éžä¸»çº¿ç¨‹çš„ Loop åœ¨ MessageQueue ä¸­æ²¡æœ‰æ¶ˆæ¯åŽå°±ä¼šé€€å‡º loop() æ–¹æ³•ï¼Œä½†æ¶ˆæ¯æ²¡æœ‰å¤„ç†çš„æ—¶å€™è¿˜æ˜¯ä¼šæŒæœ‰ Activity çš„å¼•ç”¨å•Šï¼‰ã€‚å¦‚æžœ Handler åœ¨ä½¿ç”¨ä¸»çº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹çš„ loop() æ–¹æ³•ä¸ä¼šé€€å‡ºï¼‰çš„ Looper æˆ– MessageQueueï¼Œåˆ™éœ€è¦å°† Handler å£°æ˜Žä¸ºé™æ€ç±»; åœ¨å¤–éƒ¨ç±»ä¸­ï¼Œå®žä¾‹åŒ– WeakReference åˆ°å¤–éƒ¨ç±»ï¼Œå¹¶åœ¨å®žä¾‹åŒ– Handler æ—¶å°†æ­¤å¯¹è±¡ä¼ é€’ç»™Handler; ä½¿ç”¨WeakReferenceå¯¹è±¡æ¥å¼•ç”¨å¤–éƒ¨ç±»çš„æ‰€æœ‰æˆå‘˜ã€‚ æˆ‘ä»¬å†æ¥æ‹ä¸€éå‘ç”Ÿå†…å­˜æ³„æ¼çš„åŽŸå› ï¼šæˆ‘ä»¬å‘é€çš„ Message å¯¹è±¡æŒæœ‰ Activity ä¸­çš„ Handler çš„å¼•ç”¨ï¼ŒHandler åˆéšå¼çš„æŒæœ‰å®ƒçš„å¤–éƒ¨ç±»(ä¹Ÿå°±æ˜¯ Activity )çš„å¼•ç”¨ã€‚è€Œè¿™ä¸ªå¼•ç”¨ä¼šä¸€ç›´å­˜åœ¨ï¼Œç›´åˆ°è¿™ä¸ªæ¶ˆæ¯è¢«å¤„ç†ï¼Œæ‰€ä»¥åžƒåœ¾å›žæ”¶æœºåˆ¶å°±æ²¡æ³•å›žæ”¶è¿™ä¸ª Activityï¼Œå†…å­˜æ³„éœ²å°±å‘ç”Ÿäº†ã€‚ å› æ­¤åˆ›å»º Handler çš„æ­£ç¡®å§¿åŠ¿å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526public class SampleActivity extends Activity &#123; private static class MyHandler extends Handler &#123; private WeakReference&lt;SampleActivity&gt; activityWeakReference; private MyHandler(SampleActivity activity) &#123; activityWeakReference = new WeakReference&lt;&gt;(activity); &#125; @Override public void handleMessage(Message msg) &#123; super.handleMessage(msg); SampleActivity sampleActivity = activityWeakReference.get(); if (sampleActivity != null) &#123; sampleActivity.handleMessage(msg); &#125; &#125; &#125; private MyHandler mHandler = new MyHandler(SampleActivity.this); private void handlerMessage(Message msg) &#123; // å¤„ç†æ¶ˆæ¯ &#125;&#125; ç¬¬äºŒç±»æž„é€ æ–¹æ³•1234567891011121314public Handler(Looper looper) &#123; this(looper, null, false);&#125;public Handler(Looper looper, Callback callback) &#123; this(looper, callback, false);&#125;public Handler(Looper looper, Callback callback, boolean async) &#123; mLooper = looper; mQueue = looper.mQueue; mCallback = callback; mAsynchronous = async;&#125; ç¬¬äºŒç±»æž„é€ æ–¹æ³•å¯ä»¥è®¾ç½®æŒ‡å®šçš„ Looper ä¸Ž Handler ç›¸å…³è”ï¼Œå½“ç„¶åŒæ ·å¯ä»¥è®¾ç½®å›žè°ƒå’Œæ˜¯å¦ä¸ºå¼‚æ­¥ã€‚ çŽ°åœ¨æˆ‘ä»¬å·²ç»åˆ›å»ºäº† Handler çš„å®žä¾‹ï¼ŒæŽ¥ä¸‹æ¥å°±å¯ä»¥ç”¨å®ƒæ¥å‘é€æ¶ˆæ¯äº†ã€‚ Handler å‘é€æ¶ˆæ¯ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼š Message ç±»åž‹çš„æ¶ˆæ¯ Runnable ç±»åž‹çš„æ¶ˆæ¯ï¼ˆæœ€ç»ˆè¿˜æ˜¯è½¬æ¢ä¸º Message ç±»åž‹çš„æ¶ˆæ¯ï¼‰ sendMessage1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public final boolean sendEmptyMessage(int what)&#123; return sendEmptyMessageDelayed(what, 0);&#125;public final boolean sendMessage(Message msg)&#123; return sendMessageDelayed(msg, 0);&#125;public final boolean sendEmptyMessageDelayed(int what, long delayMillis) &#123; Message msg = Message.obtain(); msg.what = what; return sendMessageDelayed(msg, delayMillis);&#125;public final boolean sendMessageDelayed(Message msg, long delayMillis)&#123; if (delayMillis &lt; 0) &#123; delayMillis = 0; &#125; return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);&#125;public boolean sendMessageAtTime(Message msg, long uptimeMillis) &#123; MessageQueue queue = mQueue; if (queue == null) &#123; RuntimeException e = new RuntimeException( this + " sendMessageAtTime() called with no mQueue"); Log.w("Looper", e.getMessage(), e); return false; &#125; return enqueueMessage(queue, msg, uptimeMillis);&#125;public final boolean sendMessageAtFrontOfQueue(Message msg) &#123; MessageQueue queue = mQueue; if (queue == null) &#123; RuntimeException e = new RuntimeException( this + " sendMessageAtTime() called with no mQueue"); Log.w("Looper", e.getMessage(), e); return false; &#125; return enqueueMessage(queue, msg, 0);&#125;private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) &#123; msg.target = this; if (mAsynchronous) &#123; msg.setAsynchronous(true); &#125; return queue.enqueueMessage(msg, uptimeMillis);&#125; å¯¹æ¯”ä¸Šé¢å‡ ä¸ªæ–¹æ³•åŽå¯ä»¥å‘çŽ°æ— è®ºæ˜¯ä»¥ä½•ç§æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œæœ€ç»ˆéƒ½æ˜¯è°ƒç”¨ enqueueMessage() æ–¹æ³•å°† Message ä¿å­˜åˆ°å½“å‰ Handler çš„ MessageQueue ä¸­ã€‚ é‚£ä¹ˆ post() æ–¹æ³•å‘¢ï¼Ÿ post()1234567891011121314151617181920212223242526272829303132public final boolean post(Runnable r)&#123; return sendMessageDelayed(getPostMessage(r), 0);&#125;public final boolean postAtTime(Runnable r, long uptimeMillis)&#123; return sendMessageAtTime(getPostMessage(r), uptimeMillis);&#125;public final boolean postAtTime(Runnable r, Object token, long uptimeMillis)&#123; return sendMessageAtTime(getPostMessage(r, token), uptimeMillis);&#125;public final boolean postDelayed(Runnable r, long delayMillis)&#123; return sendMessageDelayed(getPostMessage(r), delayMillis);&#125;public final boolean postAtFrontOfQueue(Runnable r)&#123; return sendMessageAtFrontOfQueue(getPostMessage(r));&#125;private static Message getPostMessage(Runnable r) &#123; Message m = Message.obtain(); m.callback = r; return m;&#125;private static Message getPostMessage(Runnable r, Object token)&#123; Message m = Message.obtain(); m.obj = token; m.callback = r; return m;&#125; æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œåªæ˜¯å°† runnable ä½œä¸º message.callbackï¼Œå…¶å®žè¿˜æ˜¯å…ˆè°ƒç”¨ä¸Žä¹‹å¯¹åº”çš„ senMessageXXX()æ–¹æ³•ï¼Œæœ€ç»ˆè°ƒç”¨ enqueueMessage() æ–¹æ³•ã€‚ dispatchMessageæ¶ˆæ¯å‘é€åŽï¼Œä¼šè¿›å…¥å½“å‰ Handler çš„ MessageQueue ä¸­ï¼Œè€Œ Handler æŒæœ‰çš„ MessageQueue å…¶å®žå°±æ˜¯ä¸Žå½“å‰çº¿ç¨‹ç›¸å…³è”çš„ Looper æŒæœ‰çš„ MessageQueueï¼ŒLooper çš„ loop() æ–¹æ³•ï¼Œä¼šä¸æ–­çš„ä»Ž MessageQueue ä¸­å–å‡ºæ¶ˆæ¯è¿›è¡Œåˆ†å‘ï¼Œè¿™ä¸ªåˆ†å‘æœºåˆ¶å°±æ˜¯é€šè¿‡è°ƒç”¨ Message ä¸­çš„ target (å…¶å®žå°±æ˜¯Handler) çš„ dispatchMessage() æ–¹æ³•å®žçŽ°çš„ã€‚ Looper.java 12345public static void loop() &#123; ... msg.target.dispatchMessage(msg); ...&#125; Message.java 1/*package*/ Handler target; Handler.java 1234private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) &#123; msg.target = this; ...&#125; é€šè¿‡ä¸Šé¢å‡ æ®µä»£ç å¯ä»¥çœ‹å‡ºï¼Œmsg.target å°±æ˜¯ä¸€ä¸ª Handler å¯¹è±¡ï¼Œè€Œè¿™ä¸ª target æ˜¯åœ¨ enqueueMessage() æ–¹æ³•ä¸­è¢«èµ‹å€¼çš„ï¼Œè€Œä¸”è¿™ä¸ªå€¼å°±æ˜¯ Handler å®žä¾‹æœ¬èº«ã€‚ä¸‹é¢å°±å¯ä»¥çœ‹ Handler çš„ dispatchMessage() æ–¹æ³•äº†ã€‚ Handler.java 12345678910111213141516public void dispatchMessage(Message msg) &#123; if (msg.callback != null) &#123; // å¦‚æžœ message è®¾ç½®äº† callbackï¼Œä¹Ÿå°±æ˜¯ runnable æ¶ˆæ¯ï¼Œè°ƒç”¨ callback.run()æ–¹æ³•ã€‚ // æºä»£ç ä¸º handleCallback(msg)ï¼›å®žé™…ä¸Š handleCallback(msg) çš„å…·ä½“å®žçŽ°å°±æ˜¯ä¸‹é¢è¿™è¡Œä»£ç ã€‚ msg.callback.run(); &#125; else &#123; // å¦‚æžœ handler è®¾ç½®äº† callbackï¼Œæ‰§è¡Œ callback å›žè°ƒã€‚ if (mCallback != null) &#123; if (mCallback.handleMessage(msg)) &#123; return; &#125; &#125; // è¿™ä¸ªæ–¹æ³•é»˜è®¤æ˜¯ç©ºçš„ï¼Œéœ€è¦é‡å†™è¯¥æ–¹æ³•æ¥å¤„ç†æ¶ˆæ¯ã€‚ handleMessage(msg); &#125;&#125; ä»Ž dispatchMessage å‘æ”¾ä¸­ï¼Œè¿˜å¯ä»¥çœ‹å‡ºæ¶ˆæ¯åˆ†å‘æ˜¯æœ‰ä¸‰ä¸ªçº§åˆ«çš„ï¼š Message çš„å›žè°ƒæ–¹æ³• callback ä¸ä¸ºç©ºæ—¶ï¼Œåˆ™å›žè°ƒæ–¹æ³• msg.callback.run() Handler çš„ mCallback æˆå‘˜å˜é‡ä¸ä¸ºç©ºæ—¶ï¼Œåˆ™å›žè°ƒæ–¹æ³• mCallback.handleMessage(msg) Handler è‡ªèº«çš„å›žè°ƒæ–¹æ³• handleMessage()ï¼Œè¯¥æ–¹æ³•é»˜è®¤ä¸ºç©ºï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡é‡å†™è¯¥æ–¹æ³•æ¥å®Œæˆå…·ä½“çš„é€»è¾‘ã€‚ çŽ°åœ¨æ¶ˆæ¯ä¹Ÿå·²ç»å‘é€äº†ï¼Œå‰©ä¸‹çš„å°±äº¤ç»™ Looper æ¥å¤„ç†äº†ã€‚ Looper Looper æ˜¯ç”¨äºŽä¸€ä¸ªçº¿ç¨‹è¿è¡Œæ¶ˆæ¯å¾ªçŽ¯çš„ç±»ã€‚æ¯ä¸ªçº¿ç¨‹é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰ä¸Žå®ƒç›¸å…³è”çš„æ¶ˆæ¯å¾ªçŽ¯ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ Looper.prepare() æ–¹æ³•åˆ›å»ºï¼Œåˆ›å»ºå®ŒæˆåŽè°ƒç”¨Lopper.loop()æ–¹æ³•å¼€å§‹å¾ªçŽ¯å¤„ç†æ¶ˆæ¯ã€‚ Looper.prepare()ä¸Šé¢å·²ç»æè¿‡äº†ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ Looper.prepare() æ–¹æ³•åˆ›å»º Looper çš„å®žä¾‹ä¸Žä¸€ä¸ªçº¿ç¨‹ç›¸å…³è”ï¼Œé‚£å°±å…ˆçœ‹çœ‹è¿™ä¸ªæ–¹æ³•ã€‚ Looperæä¾›äº†ä¸¤ä¸ªprepare()æ–¹æ³•ï¼š 12345678910public static void prepare() &#123; prepare(true);&#125;private static void prepare(boolean quitAllowed) &#123; if (sThreadLocal.get() != null) &#123; throw new RuntimeException("Only one Looper may be created per thread"); &#125; sThreadLocal.set(new Looper(quitAllowed));&#125; æˆ‘ä»¬åªèƒ½è°ƒç”¨æ— å‚çš„ prepare()æ–¹æ³•ï¼ˆæœ‰å‚çš„æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼‰ï¼Œè€Œä¸”æ— å‚çš„æ–¹æ³•å†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨æœ‰å‚çš„æ–¹æ³•ï¼Œå¹¶ä¼ å…¥å‚æ•° trueï¼Œè¡¨ç¤ºå…è®¸é€€å‡ºï¼Œfalse è¡¨ç¤ºä¸å…è®¸é€€å‡ºã€‚è€Œç›´æŽ¥è°ƒç”¨è¿™ä¸ªç§æœ‰çš„æž„é€ æ–¹æ³•ï¼Œå¹¶ä¼ å…¥ false çš„åœ°æ–¹åªæœ‰ä¸€ä¸ªï¼Œé‚£ä¸»æ˜¯ prepareMainLooper() æ–¹æ³•ï¼š 123456789101112131415/** * Initialize the current thread as a looper, marking it as an * application's main looper. The main looper for your application * is created by the Android environment, so you should never need * to call this function yourself. See also: &#123;@link #prepare()&#125; */public static void prepareMainLooper() &#123; prepare(false); synchronized (Looper.class) &#123; if (sMainLooper != null) &#123; throw new IllegalStateException("The main Looper has already been prepared."); &#125; sMainLooper = myLooper(); &#125;&#125; ä»Žæ³¨é‡Šä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯åˆ›å»º Application çš„ä¸» Looperï¼Œç”±Androidç³»ç»Ÿè°ƒç”¨ï¼ˆActivityThread.main()å’ŒSystemServer.run()ï¼‰ï¼Œæˆ‘ä»¬ä¸èƒ½è°ƒç”¨è¿™ä¸ªæ–¹æ³•ã€‚ ThreadLocalå†å›žåˆ°prepare()æ–¹æ³•ï¼Œç¬¬ä¸€è¡Œä¸­çš„ sThreadLocal æ˜¯ä»€ä¹ˆï¼Ÿ 123456789// sThreadLocal.get() will return null unless you've called prepare().static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();private static void prepare(boolean quitAllowed) &#123; if (sThreadLocal.get() != null) &#123; throw new RuntimeException("Only one Looper may be created per thread"); &#125; sThreadLocal.set(new Looper(quitAllowed));&#125; å¯ä»¥çœ‹åˆ° sThreadLocal æ˜¯ä¸€ä¸ª ThreadLocal ç±»åž‹çš„é™æ€å˜é‡ã€‚ ä»€ä¹ˆæ˜¯ ThreadLocal å‘¢? ThreadLocal æ˜¯ä¸€ä¸ªç”¨äºŽåˆ›å»ºçº¿ç¨‹å±€éƒ¨å˜é‡çš„ç±»ã€‚ çº¿ç¨‹å±€éƒ¨å˜é‡åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åˆ›å»ºçš„å˜é‡æ˜¯å¯ä»¥è¢«ä»»ä½•ä¸€ä¸ªçº¿ç¨‹è®¿é—®å¹¶ä¿®æ”¹çš„ã€‚è€Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œå…¶ä»–çº¿ç¨‹åˆ™æ— æ³•è®¿é—®å’Œä¿®æ”¹ï¼Œè¿™å°±æ˜¯çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚ ThreadLocalçš„ç‰¹ç‚¹ï¼š Globalï¼šåœ¨å½“å‰çº¿ç¨‹ä¸­ï¼Œä»»ä½•åœ°æ–¹éƒ½å¯ä»¥è®¿é—®åˆ° ThreadLocal çš„å€¼ã€‚ Localï¼šè¯¥çº¿ç¨‹çš„ ThreadLocal çš„å€¼åªèƒ½è¢«è¯¥çº¿ç¨‹è‡ªå·±è®¿é—®å’Œä¿®æ”¹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ å…¶ä»–çº¿ç¨‹è®¿é—®ä¸åˆ°ã€‚ ä¸‹é¢æ˜¯é€šè¿‡åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»º ThreadLocal å®žä¾‹å¹¶ä¸ºå…¶èµ‹å€¼ï¼Œç„¶åŽæµ‹è¯•å­çº¿ç¨‹èƒ½å¦æˆåŠŸè®¿é—®çš„ç¤ºä¾‹ï¼š 1234567891011121314public static void main(String[] args) &#123; final ThreadLocal&lt;String&gt; threadLocal = new ThreadLocal&lt;&gt;(); threadLocal.set("hello"); String s = threadLocal.get(); System.out.printf("å½“å‰çº¿ç¨‹ %s %s\n", Thread.currentThread().getName(), s); new Thread() &#123; @Override public void run() &#123; super.run(); String s = threadLocal.get(); System.out.printf("å½“å‰çº¿ç¨‹ %s %s\n", Thread.currentThread().getName(), s); &#125; &#125;.start();&#125; æ‰“å°ç»“æžœï¼š 12å½“å‰çº¿ç¨‹ main helloå½“å‰çº¿ç¨‹ Thread-0 null ä»Žä¸Šé¢çš„è¾“å‡ºå¯ä»¥è¯æ˜Žï¼šåœ¨ä¸»çº¿ç¨‹åˆ›å»ºçš„ ThreadLocal å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­èŽ·å–åˆ°å®ƒçš„å€¼ï¼Œè€Œåœ¨å­çº¿ç¨‹ä¸­ï¼Œå°±ä¸èƒ½èŽ·å–åˆ°äº†ã€‚ ä¸Šé¢è¯´ä¸€èˆ¬æƒ…å†µä¸‹ ThreadLocal çš„å€¼åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œé‚£ä¹ˆå½“ç„¶å°±å­˜åœ¨ç‰¹æ®Šæƒ…å†µäº†ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ThreadLocal çš„å­ç±» InheritableThreadLocal å®žçŽ°åœ¨å­çº¿ç¨‹ä¸­è®¿é—®ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„å€¼ã€‚ 12345678910final ThreadLocal&lt;String&gt; threadLocal = new InheritableThreadLocal&lt;&gt;();threadLocal.set("hello");System.out.printf("å½“å‰çº¿ç¨‹ %s %s\n", Thread.currentThread().getName(), threadLocal.get());new Thread() &#123; @Override public void run() &#123; super.run(); System.out.printf("å½“å‰çº¿ç¨‹ %s %s\n", Thread.currentThread().getName(), threadLocal.get()); &#125;&#125;.start(); æ‰“å°ç»“æžœï¼š 12å½“å‰çº¿ç¨‹ main helloå½“å‰çº¿ç¨‹ Thread-0 hello ç»“æžœç¡®å®žæ˜¯ä¸»çº¿ç¨‹å’Œå­çº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ã€‚ ThreadLocal æ€Žæ ·å®žçŽ°çº¿ç¨‹å±€éƒ¨å˜é‡æˆ‘ä»¬ä½¿ç”¨ ThreadLocal çš„ç›®çš„å°±æ˜¯é€šè¿‡å®ƒçš„çº¿ç¨‹å±€éƒ¨å˜é‡è¿™ä¸ªç‰¹æ€§ï¼Œä¿è¯æ•°æ®ä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ã€‚ è¿™é‡Œæ—¢ç„¶å…³ç³»åˆ°æ•°æ®çš„è®¿é—®ä¸Žä¿®æ”¹ï¼Œé‚£ä¹ˆå¿…ç„¶å°±è”ç³»åˆ°äº† ThreadLocal å†…éƒ¨çš„ set() å’Œ get() æ–¹æ³•äº†ã€‚ ThreadLocal.java 12345678910111213141516171819202122232425262728293031323334353637383940/** * Sets the current thread's copy of this thread-local variable * to the specified value. Most subclasses will have no need to * override this method, relying solely on the &#123;@link #initialValue&#125; * method to set the values of thread-locals. * * @param value the value to be stored in the current thread's copy of * this thread-local. */public void set(T value) &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) map.set(this, value); else createMap(t, value);&#125;/** * Returns the value in the current thread's copy of this * thread-local variable. If the variable has no value for the * current thread, it is first initialized to the value returned * by an invocation of the &#123;@link #initialValue&#125; method. * * @return the current thread's value of this thread-local */public T get() &#123; Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) &#123; ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) return (T)e.value; &#125; return setInitialValue();&#125;ThreadLocalMap getMap(Thread t) &#123; return t.threadLocals;&#125; Thread.java 1234/* ThreadLocal values pertaining to this thread. This map is maintained * by the ThreadLocal class. */ThreadLocal.ThreadLocalMap threadLocals = null; é€šè¿‡ set() å’Œ get() æ–¹æ³•çš„å‰ä¸¤è¡Œä»£ç ï¼Œå¯ä»¥çœ‹åˆ°å®ƒä»¬éƒ½æ˜¯é¦–å…ˆèŽ·å–å½“å‰çº¿ç¨‹çš„å®žä¾‹ï¼Œç„¶åŽå†èŽ·å–å½“å‰çº¿ç¨‹çš„ threadLocals å±žæ€§ï¼Œæœ€åŽæ‰åŽ»å¯¹è¿™ä¸ª threadLocals è¿›è¡Œèµ‹å€¼æˆ–å–å€¼æ“ä½œã€‚è¿™æ ·å°±ä¿è¯äº†æ¯ä¸ªçº¿ç¨‹æ“ä½œçš„åªæ˜¯å®ƒè‡ªå·±çš„ threadLocalsï¼Œä»Žè€Œå®žçŽ°çº¿ç¨‹å±€éƒ¨å˜é‡çš„æ•ˆæžœã€‚ Looper çš„æž„é€ æ–¹æ³•çŽ°åœ¨å·²ç»æ˜Žç™½äº† ThreadLocal çš„å®žçŽ°åŽŸç†ï¼Œå†æ¬¡å›žåˆ° prepare() æ–¹æ³•ã€‚ 123456private static void prepare(boolean quitAllowed) &#123; if (sThreadLocal.get() != null) &#123; throw new RuntimeException("Only one Looper may be created per thread"); &#125; sThreadLocal.set(new Looper(quitAllowed));&#125; å½“æˆ‘ä»¬ç¬¬ä¸€æ¬¡è°ƒç”¨ sThreadLocal.get() æ–¹æ³•æ—¶ï¼Œå¾—åˆ°çš„è‚¯å®šæ˜¯ nullï¼Œæ‰€ä»¥å°±å‘ sThreadLocal ä¸­èµ‹å€¼ä¸€ä¸ª Looper å¯¹è±¡ã€‚ ä¸‹é¢çœ‹ä¸€ä¸‹ Looper çš„æž„é€ æ–¹æ³•ï¼š 1234567final MessageQueue mQueue;final Thread mThread;private Looper(boolean quitAllowed) &#123; mQueue = new MessageQueue(quitAllowed); mThread = Thread.currentThread();&#125; åœ¨æž„é€ æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåˆ†åˆ«ä¸º mQueue å’Œ mThread èµ‹å€¼ï¼Œè€Œä¸” quitAllowed ä¹Ÿä¼ é€’ç»™ MessageQueue çš„æž„é€ æ–¹æ³•ï¼Œè¿˜è®°å¾—å‰é¢åœ¨ MessageQueue ä¸­å·²ç»ä»‹ç»è¿‡äº†å—ï¼Ÿè€Œä¸”æˆ‘ä»¬åˆ›å»ºçš„ MessageQueue éƒ½æ˜¯å¿…é¡»é€€å‡ºçš„ï¼Œåªæœ‰ä¸»çº¿ç¨‹æ‰ä¸å¯ä»¥ä¹Ÿä¸èƒ½é€€å‡ºã€‚ å…¶å®ž Looper åªæœ‰è¿™ä¸€ä¸ªç§æœ‰çš„æž„é€ æ–¹æ³•ï¼Œè¿™å†ä¸€æ¬¡è¯æ˜Žæˆ‘ä»¬ä¸èƒ½ç›´æŽ¥åˆ›å»º Looper çš„å®žä¾‹ï¼Œè€Œæ˜¯åº”è¯¥é€šè¿‡è°ƒç”¨ Looper.prepare() æ–¹æ³•åˆ›å»ºã€‚ åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨ Looper.prepare() æ–¹æ³•å·²ç»åˆ›å»ºäº†ä¸€ä¸ªä¸Žå½“å‰çº¿ç¨‹ç»‘å®šï¼Œå¹¶é€šè¿‡ ThreadLocal ä¿è¯æ¯ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªçš„ Looper å®žä¾‹ï¼ŒåŒæ—¶è¿™ä¸ª Looper å®žä¾‹æŒæœ‰ä¸€ä¸ª MessageQueue å¯¹è±¡å®žä¾‹ã€‚ Looper.loop()çŽ°åœ¨æœ‰äº† MessageQueue çš„å®žä¾‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ Looper.loop() å¾ªçŽ¯å¤„ç†æ¶ˆæ¯äº†ã€‚ ä¸‹é¢æ˜¯ç²¾ç®€è¿‡çš„ loop() æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930/** * Run the message queue in this thread. Be sure to call * &#123;@link #quit()&#125; to end the loop. */public static void loop() &#123; final Looper me = myLooper(); if (me == null) &#123; throw new RuntimeException("No Looper; Looper.prepare() wasn't called on this thread."); &#125; final MessageQueue queue = me.mQueue; for (;;) &#123; Message msg = queue.next(); // might block if (msg == null) &#123; // No message indicates that the message queue is quitting. return; &#125; try &#123; msg.target.dispatchMessage(msg); &#125; finally &#123; if (traceTag != 0) &#123; Trace.traceEnd(traceTag); &#125; &#125; msg.recycleUnchecked(); &#125;&#125;public static @Nullable Looper myLooper() &#123; return sThreadLocal.get();&#125; é¦–å…ˆä»Ž sThreadLocal ä¸­èŽ·å–å½“å‰çº¿ç¨‹å”¯ä¸€çš„ Looper å®žä¾‹ meï¼Œç„¶åŽå¾—åˆ°è¿™ä¸ª Looper å®žä¾‹çš„ MessageQueue å®žä¾‹ï¼ŒæŽ¥ç€å°±å¼€å§‹æ— é™å¾ªçŽ¯å¤„ç†æ¶ˆæ¯äº†ã€‚æ¯å½“å¾—åˆ°ä¸€ä¸ª Message å®žä¾‹ï¼Œåªè¦ä¸ä¸ºç©ºå°±è°ƒç”¨ msg.target.dispatchMessage(msg) å¼€å§‹åˆ†å‘æ¶ˆæ¯ã€‚ æ€»ç»“ åˆ›å»ºä¸€ä¸ª Message çš„æ­£ç¡®æ–¹å¼æ˜¯ï¼šMessage.obtain() æˆ– Handler.obtain() åˆ›å»º Handler æ—¶è¦æ³¨æ„é¿å…å†…å­˜æ³„æ¼ Looper çš„ prepare() æ–¹æ³•ï¼Œå°† Looper å®žä¾‹ä¸Žå½“å‰çº¿ç¨‹ç»‘å®šï¼Œé€šè¿‡ ThreadLocal ä¿è¯æ¯ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ª Looper å®žä¾‹ï¼ŒåŒæ—¶ä¸€ä¸ª Looper å®žä¾‹ä¹Ÿåªæœ‰ä¸€ä¸ª MessageQueue å®žä¾‹. Looper çš„ loop() æ–¹æ³•ï¼Œä¸æ–­ä»Ž MessageQueue ä¸­å–å‡º message å¯¹è±¡ï¼Œå¹¶è°ƒç”¨ message.target.dispatchMessage() æ–¹æ³•åˆ†å‘å¤„ç†ã€‚ é™„å¦‚æžœä¸Šé¢çš„å†…å®¹éƒ½ç†è§£äº†ï¼Œå°±é€šè¿‡ä¸‹é¢è¿™ä¸ªé—®é¢˜æ£€æµ‹ä¸€ä¸‹å§ï¼ æˆ‘ä»¬å¹³æ—¶éƒ½æ˜¯ä½¿ç”¨ Handler åœ¨å­çº¿ç¨‹å‘é€æ¶ˆæ¯ã€ä¸»çº¿ç¨‹ä¸­æŽ¥æ”¶ä¸Žå¤„ç†æ¶ˆæ¯ï¼Œé‚£ä¹ˆ Handler å¯ä»¥åœ¨ä¸»çº¿ç¨‹ä¸­å‘é€æ¶ˆæ¯ï¼Œåœ¨å­çº¿ç¨‹ä¸­æŽ¥æ”¶ä¸Žå¤„ç†æ¶ˆæ¯å—ï¼Ÿå¦‚æžœå¯ä»¥æ€Žä¹ˆå®žçŽ°å‘¢ï¼Ÿ ç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚å› ä¸ºæˆ‘ä»¬é€šè¿‡ Handler å‘é€çš„ Messageï¼Œéƒ½ä¼šä¿å­˜åˆ°ä¸Žå®ƒç›¸å…³è”çš„ Looper çš„ MessageQueue ä¸­ï¼ŒLooper çš„ loop() æ–¹æ³•ä¼šä¸æ–­å¾ªçŽ¯å–å‡º MessageQueue ä¸­çš„ Message å¹¶è°ƒç”¨ message.target.dispatchMessage() æ–¹æ³•è¿›è¡Œåˆ†å‘å¤„ç†ã€‚ è¿˜è®°å¾— Handler æ€Žä¹ˆä¸Ž Looper å…³è”ï¼ŒLooper åˆæ˜¯æ€Žæ ·ä¸Žçº¿ç¨‹å…³è”çš„å—ï¼Ÿå†æ¥å›žé¡¾ä¸€ä¸‹ã€‚ Handler é™¤äº†å¯ä»¥ä¸Žåˆ›å»ºå®ƒçš„çº¿ç¨‹ç›¸å…³è”çš„ Looper ç›¸å…³è”å¤–ï¼Œè¿˜å¯ä»¥ä¸ŽæŒ‡å®šçš„ Looper ç›¸å…³è”ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æŽ¥æŒ‡å®šå­çº¿ç¨‹çš„Looper ä¸Ž Handler å…³è”ã€‚ä½†æ˜¯ï¼Œå› ä¸ºæ¯ä¸ªçº¿ç¨‹é»˜è®¤æƒ…å†µä¸‹æ²¡æœ‰ä¸Žå®ƒç›¸å…³è”çš„ Looperï¼Œæ‰€ä»¥éœ€è¦åœ¨å­çº¿ç¨‹ä¸­å…ˆè°ƒç”¨ Looper.prepare() æ–¹æ³•å°† Looper ä¸Žå­çº¿ç¨‹å…³è”ï¼Œåˆ›å»ºå®ŒæˆåŽå°±å¯ä»¥è°ƒç”¨Lopper.loop()æ–¹æ³•å¼€å§‹å¾ªçŽ¯å¤„ç†æ¶ˆæ¯äº†ã€‚ ä¸‹é¢æ˜¯è¯¦ç»†ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273public class SampleActivity extends Activity &#123; private static class MyThread extends Thread &#123; private WeakReference&lt;SampleActivity&gt; activityWeakReference; private MyHandler mHandler; private MyThread(SampleActivity activity) &#123; activityWeakReference = new WeakReference&lt;&gt;(activity); &#125; @Override public void run() &#123; super.run(); Looper.prepare(); SampleActivity sampleActivity = activityWeakReference.get(); if (sampleActivity != null) &#123; mHandler = new MyHandler(sampleActivity); &#125; Looper.loop(); &#125; &#125; private static class MyHandler extends Handler &#123; private WeakReference&lt;SampleActivity&gt; activityWeakReference; private MyHandler(SampleActivity activity) &#123; activityWeakReference = new WeakReference&lt;&gt;(activity); &#125; @Override public void handleMessage(Message msg) &#123; super.handleMessage(msg); SampleActivity sampleActivity = activityWeakReference.get(); if (sampleActivity != null) &#123; sampleActivity.handleMessage(msg); &#125; &#125; &#125; private void handleMessage(Message message) &#123; Log.e("handlerMessage", "currentThread:" + Thread.currentThread().getName() + "message.what:" + message.what); &#125; @Override protected void onCreate(@Nullable Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); Log.e("onCreate", "currentThread:" + Thread.currentThread().getName()); // åˆ›å»ºå­çº¿ç¨‹ final MyThread myThread = new MyThread(this); // å¼€å¯å­çº¿ç¨‹æŽ¥æ”¶æ¶ˆæ¯ myThread.start(); // åˆ›å»ºä¸€ä¸ªå‘é€æ¶ˆæ¯çš„çº¿ç¨‹ new Thread() &#123; @Override public void run() &#123; super.run(); while (true) &#123; SystemClock.sleep(3000); myThread.mHandler.sendEmptyMessage(new Random().nextInt(10)); &#125; &#125; &#125;.start(); &#125;&#125; æ‰“å°ç»“æžœï¼š 1234567891011E/onCreate: currentThread:mainE/handleMessage: currentThread:Thread-9430,message.what:9E/handleMessage: currentThread:Thread-9430,message.what:2E/handleMessage: currentThread:Thread-9430,message.what:7E/handleMessage: currentThread:Thread-9430,message.what:7E/handleMessage: currentThread:Thread-9430,message.what:9E/handleMessage: currentThread:Thread-9430,message.what:3E/handleMessage: currentThread:Thread-9430,message.what:5E/handleMessage: currentThread:Thread-9430,message.what:2E/handleMessage: currentThread:Thread-9430,message.what:3E/handleMessage: currentThread:Thread-9430,message.what:6 å¾ˆæ˜Žæ˜¾å¯ä»¥çœ‹å‡ºæ¶ˆæ¯æ˜¯åœ¨å­çº¿ç¨‹ä¸­æŽ¥æ”¶ä¸Žå¤„ç†çš„ã€‚ å»¶ä¼¸å†æ¥ä¸€ä¸ªé—®é¢˜ï¼ŒAndroid ä¸­ä»€ä¹ˆæƒ…å†µä¸‹ä¼šåœ¨å­çº¿ç¨‹ä¸­å‘é€æ¶ˆæ¯å’Œå¤„ç†æ¶ˆæ¯å‘¢ï¼Ÿ å½“ç„¶æ˜¯è€—æ—¶æ“ä½œï¼Œè€Œè€—æ—¶æ“ä½œåˆä½¿ç”¨ä»€ä¹ˆæ¥å®žçŽ°å‘¢ï¼Ÿ Serviceï¼Œå…¶å®ž IntentService å°±æ˜¯åˆ©ç”¨ Handler æœºåˆ¶å®žçŽ°çš„ã€‚ æŸ¥çœ‹IntentService çš„ä½¿ç”¨ä¸Žæºç è§£æž]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Handler</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[FragmentManager is already executing transactions å¼‚å¸¸åˆ†æž]]></title>
    <url>%2Fposts%2F7b4d3187.html</url>
    <content type="text"><![CDATA[ä»Šå¤©æ˜¯ 2019å¹´09æœˆ13æ—¥ï¼Œå†œåŽ†å…«æœˆåäº”ã€‚æ²¡é”™ä»Šå¤©æ˜¯ä¸­ç§‹èŠ‚ï¼Œè€Œä¸”å¯¹æˆ‘æ¥è¯´ï¼Œä»Šå¹´çš„ä¸­ç§‹ä¸ä¸€æ ·ðŸ–•ã€‚ æ•…äº‹æ˜¯è¿™æ ·çš„ â€”â€” ä¸­ç§‹å‰ä¸€å¤©çš„æ™šä¸Šçº¿ä¸Šå‘çŽ°äº†é—®é¢˜ï¼Œåœ¨å®¶æ”¹bugåˆ°åŽåŠå¤œã€‚ä¸­ç§‹å½“å¤©ä¸Šåˆæ—©ä¸ŠåˆæŽ¥åˆ°çº¿ä¸Šçš„é—®é¢˜åé¦ˆï¼ŒäºŽæ˜¯åœ¨å®¶ä¸Žå…¶ä»–å‡ ä¸ªå°ä¼™ä¼´ä¸€èµ·è¿žçº¿æŽ’æŸ¥è§£å†³ã€‚ç»è¿‡ä¸€ä¸Šåˆçš„åŠªåŠ›ï¼Œä¿®æ”¹äº†å‡ ä¸ªé—®é¢˜ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜æ²¡æœ‰æŸ¥åˆ°åŽŸå› å’Œè§£å†³åŠžæ³•ï¼ŒäºŽæ˜¯å†³å®šä¸‹åˆåŽ»å…¬å¸è§£å†³ï¼Œè¿˜å¥½ä¸‹åˆç‹ é¡ºåˆ©çš„å°†é—®é¢˜å¤çŽ°äº†ï¼Œå¹¶æ‰¾åˆ°äº†åŽŸå› å’Œè§£å†³åŠžæ³•ã€‚å½“æŠŠé—®é¢˜éƒ½å›žå½’éªŒè¯åŽï¼Œå·²ç»æ˜¯å¿«æ™šä¸Š7ç‚¹é’Ÿäº†ã€‚å›žåˆ°å®¶ä¸åˆ° 8 ç‚¹ï¼Œåƒäº†ä¸€å¤§ç¢—å¤§å®¶ä¸‹åˆåŒ…çš„ç»™æˆ‘ä¸€ä¸ªäººç•™å¾—é¥ºå­â€¦â€¦ æ‰¯è›‹å®Œæ¯•ï¼ŒçŽ°åœ¨å›žåˆ°æ­£é¢˜ã€‚ éœ€æ±‚ç”¨æˆ·æŒ‰è¿”å›žé”®å³å°†é€€å‡ºå½“å‰é¡µé¢å‰ï¼Œéœ€è¦ç«‹å³è¯·æ±‚æŽ¥å£åˆ¤æ–­æ˜¯å¦æ˜¾ç¤ºä¸€ä¸ª Dialogï¼Œå¦‚æžœå±•ç¤º Dialog åˆ™ä¸é€€å‡ºé¡µé¢ï¼Œå¦åˆ™å†é€€å‡ºé¡µé¢ã€‚ æ¨¡æ‹Ÿä»£ç 1234567891011121314151617181920212223class MainActivity : AppCompatActivity() &#123; override fun onBackPressed() &#123; sendRequest().observe(this@MainActivity, Observer &#123; if (it == true) &#123; Toast.makeText(this@MainActivity, "å¼¹å‡ºDialog", Toast.LENGTH_SHORT).show() &#125; else &#123; super.onBackPressed() &#125; &#125;) &#125; private fun sendRequest(): LiveData&lt;Boolean&gt; &#123; val result = MutableLiveData&lt;Boolean&gt;() // è¿™é‡Œå‡è®¾è¯·æ±‚ç”¨æ—¶ 500 msã€‚ Handler().postDelayed(&#123; result.postValue(false) &#125;, 500L) return result &#125;&#125; é—®é¢˜æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚å‡ ç™¾æ¯«ç§’å†…å°±å¯ä»¥å®Œæˆï¼Œä½†æ˜¯å¦‚æžœåœ¨å¼±ç½‘çŽ¯å¢ƒä¸‹ï¼Œå½“ç”¨æˆ·ç‚¹å‡»è¿”å›žé”®åŽï¼Œç”±äºŽé•¿æ—¶é—´æ²¡æœ‰ååº”ï¼Œæ­¤æ—¶å¯èƒ½ç”¨æˆ·ç€æ€¥äº†ï¼ŒäºŽæ˜¯æŒ‰ä¸‹ Home é”®ï¼Œåº”ç”¨è¿›å…¥åŽå°ã€‚ä¸€æ®µæ—¶é—´åŽç½‘ç»œè¯·æ±‚æˆåŠŸï¼ˆè¿”å›žç»“æžœä¸ºä¸æ˜¾ç¤º Dialogï¼‰æˆ–è¯·æ±‚è¶…æ—¶ï¼Œç”¨æˆ·å†æ¬¡è¿”å›žåº”ç”¨æ—¶ï¼Œæ­¤æ—¶å‘ç”Ÿå¦‚ä¸‹å¼‚å¸¸ï¼š Android 8.0ï¼ˆä¸åŒ…å«8.0ï¼‰ ä»¥ä¸‹ ANRã€‚ Android 8.0+ æŠ¥ä»¥ä¸‹é”™è¯¯ï¼Œ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051522019-09-13 21:39:05.780 2106-2106/com.xiaomai E/AndroidRuntime: FATAL EXCEPTION: main Process: com.xiaomai, PID: 2106 java.lang.RuntimeException: Unable to resume activity &#123;com.xiaomai/com.xiaomai.MainActivity&#125;: java.lang.IllegalStateException: FragmentManager is already executing transactions at android.app.ActivityThread.performResumeActivity(ActivityThread.java:3645) at android.app.ActivityThread.handleResumeActivity(ActivityThread.java:3685) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1643) at android.os.Handler.dispatchMessage(Handler.java:105) at android.os.Looper.loop(Looper.java:164) at android.app.ActivityThread.main(ActivityThread.java:6541) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:240) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:767) Caused by: java.lang.IllegalStateException: FragmentManager is already executing transactions at android.app.FragmentManagerImpl.ensureExecReady(FragmentManager.java:1987) at android.app.FragmentManagerImpl.execPendingActions(FragmentManager.java:2043) at android.app.FragmentManagerImpl.popBackStackImmediate(FragmentManager.java:850) at android.app.FragmentManagerImpl.popBackStackImmediate(FragmentManager.java:811) at android.app.Activity.onBackPressed(Activity.java:2993) at androidx.fragment.app.FragmentActivity.onBackPressed(FragmentActivity.java:191) at com.xiaomai.MainActivity.access$onBackPressed$s1136912392(MainActivity.kt:14) at com.xiaomai.MainActivity$onBackPressed$1.onChanged(MainActivity.kt:28) at com.xiaomai.MainActivity$onBackPressed$1.onChanged(MainActivity.kt:14) at androidx.lifecycle.LiveData.considerNotify(LiveData.java:131) at androidx.lifecycle.LiveData.dispatchingValue(LiveData.java:144) at androidx.lifecycle.LiveData$ObserverWrapper.activeStateChanged(LiveData.java:442) at androidx.lifecycle.LiveData$LifecycleBoundObserver.onStateChanged(LiveData.java:394) at androidx.lifecycle.LifecycleRegistry$ObserverWithState.dispatchEvent(LifecycleRegistry.java:361) at androidx.lifecycle.LifecycleRegistry.forwardPass(LifecycleRegistry.java:300) at androidx.lifecycle.LifecycleRegistry.sync(LifecycleRegistry.java:339) at androidx.lifecycle.LifecycleRegistry.moveToState(LifecycleRegistry.java:145) at androidx.lifecycle.LifecycleRegistry.handleLifecycleEvent(LifecycleRegistry.java:131) at androidx.lifecycle.ReportFragment.dispatch(ReportFragment.java:123) at androidx.lifecycle.ReportFragment.onStart(ReportFragment.java:83) at android.app.Fragment.performStart(Fragment.java:2637) at android.app.FragmentManagerImpl.moveToState(FragmentManager.java:1312) at android.app.FragmentManagerImpl.moveFragmentToExpectedState(FragmentManager.java:1549) at android.app.FragmentManagerImpl.moveToState(FragmentManager.java:1611) at android.app.FragmentManagerImpl.dispatchMoveToState(FragmentManager.java:3039) at android.app.FragmentManagerImpl.dispatchStart(FragmentManager.java:2996) at android.app.FragmentController.dispatchStart(FragmentController.java:189) at android.app.Activity.performStart(Activity.java:6998) at android.app.Activity.performRestart(Activity.java:7066) at android.app.Activity.performResume(Activity.java:7071) at android.app.ActivityThread.performResumeActivity(ActivityThread.java:3620) at android.app.ActivityThread.handleResumeActivity(ActivityThread.java:3685) at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1643) at android.os.Handler.dispatchMessage(Handler.java:105) at android.os.Looper.loop(Looper.java:164) at android.app.ActivityThread.main(ActivityThread.java:6541) at java.lang.reflect.Method.invoke(Native Method) at com.android.internal.os.Zygote$MethodAndArgsCaller.run(Zygote.java:240) at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:767) é—®é¢˜é‡çŽ°ä¸ºäº†æ¨¡æ‹Ÿå¼±ç½‘çŽ¯å¢ƒï¼Œæ–¹ä¾¿é—®é¢˜é‡çŽ°ï¼Œè¿™é‡ŒæŠŠè¯·æ±‚æ—¶é—´æ”¹ä¸º 3sã€‚ 123Handler().postDelayed(&#123; result.postValue(false)&#125;, 3000L) å½“æŒ‰ä¸‹è¿”å›žé”®åŽï¼Œç«‹å³æŒ‰ Home é”®ï¼Œç­‰å¾… 3 ç§’åŽå†æ¬¡å›žåˆ°åº”ç”¨ï¼Œé—®é¢˜é‡çŽ°ã€‚ åŽŸå› æŽ’æŸ¥ä»Žå †æ ˆçš„å¼‚å¸¸æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼šå¼‚å¸¸å‘ç”Ÿçš„åŽŸå› ä¸Ž Fragment æœ‰å…³ï¼Œå¹¶ä¸”å¯¹ Fragment è¿›è¡Œäº†ä¸æ­£å½“çš„æ“ä½œã€‚ çœ‹ä¸€ä¸‹ä»£ç ä¸­å“ªä¸ªåœ°æ–¹ç”¨åˆ°äº† Fragment å‘¢ï¼Ÿä»”ç»†ä¸€è¡Œè¡Œçš„çœ‹è¿‡ä»£ç åŽï¼Œå‘çŽ°æ²¡æœ‰åœ°æ–¹ä½¿ç”¨ Fragmentï¼ï¼ï¼ WHAT????? è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä»£ç ä¸­æ²¡æœ‰ä»»ä½•åœ°æ–¹ä½¿ç”¨ Fragmentï¼Œé”™è¯¯å †æ ˆä¸­å´æŠ¥äº†ä¸Ž Fragment æœ‰å…³çš„ä¿¡æ¯ï¼Œå†ä»”ç»†çœ‹ä¸€ä¸‹å †æ ˆçš„å¼‚å¸¸æ—¥å¿—ï¼Œå‘çŽ°æœ‰ä¸€ä¸ªå« ReportFragment çš„ç±»ã€‚ åŽŸæ¥ï¼ŒReportFragment æ˜¯ Android ä¸ºäº†å®žçŽ° Lifecycles ç›¸å…³åŠŸèƒ½è€Œè‡ªåŠ¨æ·»åŠ çš„ã€‚ æŽ¥ä¸‹æ¥ï¼Œè°ƒè¯•ä¸€ä¸‹å½“åº”ç”¨ä»ŽåŽå°è¿”å›žæ—¶éƒ½å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ 1234567handleResumeActivity:3685, ActivityThread (android.app)performResumeActivity:3620, ActivityThread (android.app)performResume:7071, Activity (android.app)performRestart:7066, Activity (android.app)performStart:6991, Activity (android.app)execPendingActions:402, FragmentController (android.app)execPendingActions:2043, FragmentManagerImpl (android.app) =&gt; ä»£ç åˆ†æžä¸€ ä»£ç åˆ†æžä¸€ï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º Activity ä¸­çš„ FragmentManagerï¼‰ï¼š 12345678public boolean execPendingActions() &#123; ensureExecReady(true); boolean didSomething = false; ...çœç•¥éƒ¨åˆ†ä»£ç  return didSomething;&#125; ä»£ç åˆ†æžäºŒï¼ˆæ­¤æ—¶ FragmentManager ä»ä¸º Activity ä¸­çš„ï¼‰ï¼š 123456789101112131415161718private void ensureExecReady(boolean allowStateLoss) &#123; if (mExecutingActions) &#123; // è¿™æ­£æ˜¯å †æ ˆæ—¥å¿—ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ throw new IllegalStateException("FragmentManager is already executing transactions"); &#125; if (Looper.myLooper() != mHost.getHandler().getLooper()) &#123; throw new IllegalStateException("Must be called from main thread of fragment host"); &#125; ... çœç•¥éƒ¨åˆ†ä»£ç  mExecutingActions = true; try &#123; executePostponedTransaction(null, null); &#125; finally &#123; mExecutingActions = false; &#125;&#125; è™½ç„¶è¿™é‡Œæ‰¾åˆ°äº†å¼‚å¸¸ä¿¡æ¯ï¼Œä½†æ˜¯è¿™æ—¶å¹¶æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚ æŽ¥ä¸‹æ¥çš„è¿è¡Œå¦‚ä¸‹ï¼š 123dispatchStart:189, FragmentController (android.app)dispatchStart:2996, FragmentManagerImpl (android.app)dispatchMoveToState:3039, FragmentManagerImpl (android.app) =&gt; ä»£ç åˆ†æžä¸‰ ä»£ç åˆ†æžä¸‰ï¼ˆæ­¤æ—¶ FragmentManager ä»ä¸º Activity ä¸­çš„ï¼‰ï¼š 1234567891011121314private void dispatchMoveToState(int state) &#123; if (mAllowOldReentrantBehavior) &#123; moveToState(state, false); &#125; else &#123; try &#123; mExecutingActions = true; // è§ä»£ç åˆ†æžå›› moveToState(state, false); &#125; finally &#123; mExecutingActions = false; &#125; &#125; execPendingActions();&#125; è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ mExecutingActions = true;ç„¶åŽå°±è¿›å…¥äº† moveToState æ–¹æ³•ã€‚ ä»£ç åˆ†æžå››ï¼ˆæ­¤æ—¶ FragmentManager ä»ä¸º Activity ä¸­çš„ï¼‰ï¼š 12345678910111213141516void moveToState(int newState, boolean always) &#123; ... çœç•¥éƒ¨åˆ†ä»£ç  // Now iterate through all active fragments. These will include those that are removed // and detached. final int numActive = mActive.size(); for (int i = 0; i &lt; numActive; i++) &#123; // æ­¤æ—¶ mActivie ä¸­åªæœ‰ä¸€ä¸ªä¸”ä¸º ReportFragment Fragment f = mActive.valueAt(i); if (f != null &amp;&amp; (f.mRemoving || f.mDetached) &amp;&amp; !f.mIsNewlyAdded) &#123; // è§ä»£ç åˆ†æžäº” moveFragmentToExpectedState(f); ... &#125; &#125; ... çœç•¥éƒ¨åˆ†ä»£ç &#125; ä»£ç åˆ†æžäº”ï¼ˆæ­¤æ—¶ FragmentManager ä¸º Activity ä¸­çš„ï¼‰ï¼š 1234567891011121314151617181920void moveFragmentToExpectedState(final Fragment f) &#123; ... moveToState(f, nextState, f.getNextTransition(), f.getNextTransitionStyle(), false); ...&#125;@SuppressWarnings("ReferenceEquality")void moveToState(Fragment f, int newState, int transit, int transitionStyle, boolean keepActive) &#123; ... switch (f.mState) &#123; case Fragment.STOPPED: if (newState &gt; Fragment.STOPPED) &#123; // è§ä»£ç åˆ†æžå…­ f.performStart(); dispatchOnFragmentStarted(f, false); &#125; ... &#125; ...&#125; ä»£ç åˆ†æžå…­ï¼ˆæ­¤æ—¶è¿›å…¥ Fragmentï¼‰ï¼š 1234567891011public class Fragment &#123; void performStart() &#123; if (mChildFragmentManager != null) &#123; mChildFragmentManager.noteStateNotSaved(); // å†æ¬¡å›žåˆ°ä»£ç åˆ†æžä¸€ mChildFragmentManager.execPendingActions(); &#125; ... &#125;&#125; è™½ç„¶è¿™é‡Œå†æ¬¡è¿›å…¥ä»£ç åˆ†æžä¸€ï¼Œä½†è¿™æ—¶çš„ FragmentManager ä¸Žå‰é¢çš„ FragmentManager å·²ç»ä¸æ˜¯åŒä¸€ä¸ªäº†ï¼Œä¹‹å‰æ˜¯ Activity ä¸­çš„è€ŒçŽ°åœ¨æ˜¯ ReportFragment ä¸­çš„ childFragmentManagerï¼Œå¹¶ä¸” Activity çš„æ ˆå¸§ä»ç„¶å¤„åœ¨ä»£ç åˆ†æžä¸‰çš„ mo veToState() æ–¹æ³•ä¸­ï¼ŒmExecutingActions ä»ç„¶ä¸º trueã€‚ ä»£ç åˆ†æžä¸€ï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º ReportFragment ä¸­çš„ childFragmentManagerï¼‰ï¼š 12345678public boolean execPendingActions() &#123; ensureExecReady(true); boolean didSomething = false; ...çœç•¥éƒ¨åˆ†ä»£ç  return didSomething;&#125; ä»£ç åˆ†æžäºŒï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º ReportFragment ä¸­çš„ childFragmentManagerï¼‰ï¼š 123456789101112131415161718private void ensureExecReady(boolean allowStateLoss) &#123; if (mExecutingActions) &#123; // è¿™æ­£æ˜¯å †æ ˆæ—¥å¿—ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ throw new IllegalStateException("FragmentManager is already executing transactions"); &#125; if (Looper.myLooper() != mHost.getHandler().getLooper()) &#123; throw new IllegalStateException("Must be called from main thread of fragment host"); &#125; ... çœç•¥éƒ¨åˆ†ä»£ç  mExecutingActions = true; try &#123; executePostponedTransaction(null, null); &#125; finally &#123; mExecutingActions = false; &#125;&#125; è¿™æ—¶ä»ç„¶æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚ æŽ¥ä¸‹æ¥çš„è¿è¡Œä»ç„¶å¦‚ä¸‹ï¼š 123dispatchStart:189, FragmentController (android.app)dispatchStart:2996, FragmentManagerImpl (android.app)dispatchMoveToState:3039, FragmentManagerImpl (android.app) =&gt; ä»£ç åˆ†æžä¸‰ ä»£ç åˆ†æžä¸‰ï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º ReportFragment ä¸­çš„ childFragmentManagerï¼‰ï¼š 1234567891011121314private void dispatchMoveToState(int state) &#123; if (mAllowOldReentrantBehavior) &#123; moveToState(state, false); &#125; else &#123; try &#123; mExecutingActions = true; // è§ä»£ç åˆ†æžå›› moveToState(state, false); &#125; finally &#123; mExecutingActions = false; &#125; &#125; execPendingActions();&#125; è¿™é‡Œä»ç„¶è¦æ³¨æ„çš„æ˜¯ mExecutingActions = true;ç„¶åŽå°±è¿›å…¥äº† moveToState æ–¹æ³•ã€‚ ä»£ç åˆ†æžå››ï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º ReportFragment ä¸­çš„ childFragmentManagerï¼‰ï¼š 12345678910111213141516void moveToState(int newState, boolean always) &#123; ... çœç•¥éƒ¨åˆ†ä»£ç  // Now iterate through all active fragments. These will include those that are removed // and detached. final int numActive = mActive.size(); // è¿™æ—¶ numActive = 0ï¼Œæ‰€ä»¥ä¸ä¼šè¿›å…¥ for å¾ªçŽ¯ã€‚ for (int i = 0; i &lt; numActive; i++) &#123; Fragment f = mActive.valueAt(i); if (f != null &amp;&amp; (f.mRemoving || f.mDetached) &amp;&amp; !f.mIsNewlyAdded) &#123; moveFragmentToExpectedState(f); ... &#125; &#125; ... çœç•¥éƒ¨åˆ†ä»£ç &#125; å› ä¸ºè¿™é‡Œä¸ä¼šè¿›å…¥ for å¾ªçŽ¯ï¼Œæ‰€ä»¥æ–¹æ³•è¿è¡Œç»“æŸåŽï¼Œä¼šè¿›å…¥ä»£ç åˆ†æžä¸‰ä¸­ finally ä»£ç å—ä¸­ï¼Œå°† mExecutingActions èµ‹å€¼ä¸º false;è¿™æ—¶æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œå›žåˆ°ä»£ç åˆ†æžå…­ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œï¼š 12345678910111213public class Fragment &#123; void performStart() &#123; if (mChildFragmentManager != null) &#123; mChildFragmentManager.noteStateNotSaved(); mChildFragmentManager.execPendingActions(); // æ‰§è¡Œå®Œæ¯• &#125; mState = STARTED; mCalled = false; // è§ä»£ç åˆ†æžä¸ƒ onStart(); &#125;&#125; ä»£ç åˆ†æžä¸ƒï¼š 12345678public class ReportFragment extends Fragment &#123; @Override public void onStart() &#123; super.onStart(); dispatchStart(mProcessListener); dispatch(Lifecycle.Event.ON_START); &#125;&#125; åœ¨ ReportFragment çš„ onStart() æ–¹æ³•ï¼Œä¼šå¯¹ OnStart äº‹ä»¶è¿›è¡Œåˆ†å‘ï¼Œä¹‹åŽ LiveData åœ¨ MainActivity ä¸­ç­‰åˆ°å“åº”ï¼š 12345678910override fun onBackPressed() &#123; sendRequest().observe(this@MainActivity, Observer &#123; if (it == true) &#123; // å› ä¸ºè¿”å›žçš„ç»“æžœæ˜¯ trueï¼Œæ‰€ä»¥æ‰§è¡Œæ­¤æ–¹æ³•ã€‚è§ä»£ç åˆ†æžå…« super.onBackPressed() &#125; else &#123; Toast.makeText(this@MainActivity, "å¼¹å‡ºDialog", Toast.LENGTH_SHORT).show() &#125; &#125;)&#125; ä»£ç åˆ†æžå…«ï¼š 123456789101112131415161718public class FragmentActivity &#123; public void onBackPressed() &#123; // è¿™æ—¶çš„ fragmentManger åˆæ˜¯ä¸€ä¸ªæ–°çš„ FragmentMangerï¼Œå®ƒå±žäºŽ FragmentActivityã€‚ FragmentManager fragmentManager = mFragments.getSupportFragmentManager(); final boolean isStateSaved = fragmentManager.isStateSaved(); if (isStateSaved &amp;&amp; Build.VERSION.SDK_INT &lt;= Build.VERSION_CODES.N_MR1) &#123; // Older versions will throw an exception from the framework // FragmentManager.popBackStackImmediate(), so we'll just // return here. The Activity is likely already on its way out // since the fragmentManager has already been saved. return; &#125; if (isStateSaved || !fragmentManager.popBackStackImmediate()) &#123; // ä»£ç åˆ†æžä¹ super.onBackPressed(); &#125; &#125;&#125; ä»£ç åˆ†æžä¹ï¼š 123456789101112131415public class Activity &#123; public void onBackPressed() &#123; if (mActionBar != null &amp;&amp; mActionBar.collapseActionView()) &#123; return; &#125; // è¿™ä¸ª fragmentManager åˆå˜æˆäº† Activity ä¸­çš„ FragmentManagerã€‚ FragmentManager fragmentManager = mFragments.getFragmentManager(); // è§ä»£ç åˆ†æžå if (fragmentManager.isStateSaved() || !fragmentManager.popBackStackImmediate()) &#123; finishAfterTransition(); &#125; &#125;&#125; ä»£ç åˆ†æžåï¼ˆæ­¤æ—¶çš„ FragmentManager ä¸º Activity ä¸­çš„ FragmentManagerï¼‰ï¼š 1234567891011121314@Overridepublic boolean popBackStackImmediate() &#123; checkStateLoss(); return popBackStackImmediate(null, -1, 0);&#125;private boolean popBackStackImmediate(String name, int id, int flags) &#123; // å†æ¬¡è¿›å…¥ä»£ç åˆ†æžä¸€ï¼Œæ­¤æ—¶çš„ fragmentManager ä¸Žç¬¬ä¸€æ¬¡åˆ†æžä¸­çš„æ˜¯åŒä¸€ä¸ª execPendingActions(); ensureExecReady(true); ... çœç•¥éƒ¨åˆ†ä»£ç  return executePop;&#125; æˆ‘ä»¬å†æ¬¡è¿›å…¥åˆ°ä»£ç åˆ†æžäºŒä¸­: 123456private void ensureExecReady(boolean allowStateLoss) &#123; if (mExecutingActions) &#123; // è¿™æ­£æ˜¯å †æ ˆæ—¥å¿—ä¸­æŠ›å‡ºçš„å¼‚å¸¸ä¿¡æ¯ throw new IllegalStateException("FragmentManager is already executing transactions"); &#125;&#125; å› ä¸ºå‰é¢åœ¨ä»£ç åˆ†æžä¸‰ä¸­æˆ‘ä»¬å¼ºè°ƒè¿‡ï¼ŒActivity ä¸­çš„ mExecutingActions ä¸º true åŽï¼Œå°±å†ä¹Ÿæ²¡æœ‰è¢«ä¿®æ”¹ä¸º falseï¼Œæ‰€ä»¥è¿™é‡ŒæŠ›å‡ºäº†å¼‚å¸¸ã€‚ è‡³æ­¤ï¼Œé—®é¢˜çš„åŽŸå› å·²ç»æ‰¾åˆ°äº†ï¼Œæ˜¯ç”±äºŽ Activity ä¸­çš„ FragmentManager çš„ç¬¬ä¸€æ¬¡ä»»åŠ¡è¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œå…¶ä»–çš„æ“ä½œåˆå¯¼è‡´å®ƒéœ€è¦è¿›è¡Œç¬¬äºŒæ¬¡ä»»åŠ¡ï¼Œæ‰€ä»¥å‘ç”Ÿé”™è¯¯ã€‚ è§£å†³æ–¹æ¡ˆé—®é¢˜çš„åŽŸå› å·²ç»æ‰¾åˆ°äº†ï¼Œæ‰€ä»¥å½“ç¬¬ä¸€æ¬¡ä»»åŠ¡æ²¡æœ‰æ‰§è¡Œç»“æŸæ—¶ï¼Œå¦‚æžœæœ‰ç¬¬äºŒä¸ªä»»åŠ¡åˆ°æ¥ï¼Œæˆ‘ä»¬å¯ä»¥ä»Žä¸¤ä¸ªæ–¹é¢åŽ»è§£å†³é—®é¢˜ï¼š ç›´æŽ¥ä¸¢å¼ƒç¬¬äºŒä¸ªä»»åŠ¡åœ¨é¡µé¢ä¸å¯è§æ—¶ï¼Œå–æ¶ˆå¯¹ LiveData çš„ç›‘å¬ï¼Œè¿™æ ·é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œå°±ä¸ä¼šæŽ¥æ”¶åˆ°å˜åŒ–çš„é€šçŸ¥äº†ï¼Œä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132class MainActivity : AppCompatActivity() &#123; private val observer = Observer&lt;Boolean&gt; &#123; if (it == true) &#123; super.onBackPressed() &#125; else &#123; Toast.makeText(this@MainActivity, "å¼¹å‡ºDialog", Toast.LENGTH_SHORT).show() &#125; &#125; private var result: LiveData&lt;Boolean&gt;? = null override fun onBackPressed() &#123; result = sendRequest() result?.observe(this@MainActivity, observer) &#125; override fun onStop() &#123; super.onStop() result?.removeObserver(observer) &#125; private fun sendRequest(): LiveData&lt;Boolean&gt; &#123; val result = MutableLiveData&lt;Boolean&gt;() Handler().postDelayed(&#123; result.postValue(true) &#125;, 3000L) return result &#125;&#125; ç­‰å¾…ç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯•åŽå†æ‰§è¡Œç¬¬äºŒä¸ªä»»åŠ¡é€šè¿‡ Handler.post() æ–¹å¼ï¼Œå°†ä»»åŠ¡æ»žåŽå®Œæˆã€‚ 123456789101112131415161718192021222324class MainActivity : AppCompatActivity() &#123; override fun onBackPressed() &#123; sendRequest().observe(this@MainActivity, Observer &#123; if (it == true) &#123; Handler().post &#123; super.onBackPressed() &#125; &#125; else &#123; Toast.makeText(this@MainActivity, "å¼¹å‡ºDialog", Toast.LENGTH_SHORT).show() &#125; &#125;) &#125; private fun sendRequest(): LiveData&lt;Boolean&gt; &#123; val result = MutableLiveData&lt;Boolean&gt;() Handler().postDelayed(&#123; result.postValue(true) &#125;, 3000L) return result &#125;&#125;]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Fragment</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ˜æµ·å±é€‚é…]]></title>
    <url>%2Fposts%2Fdf0aa059.html</url>
    <content type="text"><![CDATA[å…³äºŽåˆ˜æµ·å±çš„é€‚é…æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼š å¯ä»¥åœ¨åˆ˜æµ·å±åŒºåŸŸå±•ç¤ºï¼Œå³ä½¿éƒ¨åˆ†å†…å®¹è¢«ã€ŽåƒæŽ‰ã€ä¹Ÿæ²¡å…³ç³»ï¼› ä¸å¯ä»¥åœ¨åˆ˜æµ·å±åŒºåŸŸå±•ç¤ºï¼Œé¿å…é‡è¦çš„ä¿¡æ¯ä¸èƒ½è¢«ç”¨æˆ·çœ‹åˆ°ï¼Œå½±å“ä½¿ç”¨ã€‚ æœ¬æ–‡é’ˆå¯¹è¿™ä¸¤ç§æƒ…å†µè¿›è¡Œåˆ†æžï¼š çŸ¥è¯†å‚¨å¤‡window.decorView.systemUiVisibility çš„å¯é€‰å€¼ï¼ˆéƒ¨åˆ†ï¼‰ View.SYSTEM_UI_FLAG_VISIBLE é»˜è®¤æ ‡è®°ã€‚æ˜¾ç¤ºçŠ¶æ€æ å’Œå¯¼èˆªæ ï¼ŒActivity æ­£å¸¸æ˜¾ç¤ºã€‚ View.INVISIBLE éšè—çŠ¶æ€æ ï¼ŒåŒæ—¶Activityä¼šä¼¸å±•å…¨å±æ˜¾ç¤ºã€‚ View.SYSTEM_UI_FLAG_LOW_PROFILE ä½Žè°ƒæ¨¡å¼, ä¼šéšè—ä¸é‡è¦çš„çŠ¶æ€æ å›¾æ ‡ View.SYSTEM_UI_FLAG_LAYOUT_STABLE ä¿æŒæ•´ä¸ªViewç¨³å®š, å¸¸å’ŒæŽ§åˆ¶System UIæ‚¬æµ®, éšè—çš„Flagså…±ç”¨, ä½¿Viewä¸ä¼šå› ä¸ºSystem UIçš„å˜åŒ–è€Œé‡æ–°layout View.SYSTEM_UI_FLAG_FULLSCREEN çŠ¶æ€æ éšè—ï¼ŒActivityå…¨å±æ˜¾ç¤ºã€‚æ•ˆæžœåŒè®¾ç½®WindowManager.LayoutParams.FLAG_FULLSCREEN View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN è§†å›¾å»¶ä¼¸è‡³çŠ¶æ€æ åŒºåŸŸï¼ŒçŠ¶æ€æ ä¸Šæµ®äºŽè§†å›¾ä¹‹ä¸Š View.SYSTEM_UI_FLAG_HIDE_NAVIGATION éšè—å¯¼èˆªæ  View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION è§†å›¾å»¶ä¼¸è‡³å¯¼èˆªæ åŒºåŸŸï¼Œå¯¼èˆªæ ä¸Šæµ®äºŽè§†å›¾ä¹‹ä¸Š View.SYSTEM_UI_FLAG_IMMERSIVE æ²‰æµ¸æ¨¡å¼, éšè—çŠ¶æ€æ å’Œå¯¼èˆªæ , å¹¶ä¸”åœ¨ç¬¬ä¸€æ¬¡ä¼šå¼¹æ³¡æé†’, å¹¶ä¸”åœ¨çŠ¶æ€æ åŒºåŸŸæ»‘åŠ¨å¯ä»¥å‘¼å‡ºçŠ¶æ€æ ï¼ˆè¿™æ ·ä¼šæ¸…é™¤ä¹‹å‰è®¾ç½®çš„View.SYSTEM_UI_FLAG_FULLSCREEN æˆ– View.SYSTEM_UI_FLAG_HIDE_NAVIGATIONæ ‡å¿—ï¼‰ã€‚ä½¿ä¹‹ç”Ÿæ•ˆï¼Œéœ€è¦å’Œ View.SYSTEM_UI_FLAG_FULLSCREENï¼ŒView.SYSTEM_UI_FLAG_HIDE_NAVIGATION ä¸­çš„ä¸€ä¸ªæˆ–ä¸¤ä¸ªåŒæ—¶è®¾ç½®ã€‚ View.SYSTEM_UI_FLAG_IMMERSIVE_STIKY ä¸Žä¸Šé¢å”¯ä¸€çš„åŒºåˆ«æ˜¯, å‘¼å‡ºéšè—çš„çŠ¶æ€æ åŽä¸ä¼šæ¸…é™¤ä¹‹å‰è®¾ç½®çš„View.SYSTEM_UI_FLAG_FULLSCREENæˆ–View.SYSTEM_UI_FLAG_HIDE_NAVIGATIONæ ‡å¿—ï¼Œåœ¨ä¸€æ®µæ—¶é—´åŽå°†å†æ¬¡éšè—ç³»ç»Ÿæ ï¼‰ã€‚ layoutInDisplayCutoutModeï¼ˆAndroid P æä¾›ï¼‰ æ¨¡å¼ æ¨¡å¼è¯´æ˜Ž LAYOUT_IN_DISPLAY_CUTOUT_MODE_DEFAULT åªæœ‰å½“DisplayCutoutå®Œå…¨åŒ…å«åœ¨ç³»ç»Ÿæ ä¸­æ—¶ï¼Œæ‰å…è®¸çª—å£å»¶ä¼¸åˆ°DisplayCutoutåŒºåŸŸã€‚ å¦åˆ™ï¼Œçª—å£å¸ƒå±€ä¸ä¸ŽDisplayCutoutåŒºåŸŸé‡å ã€‚ LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER è¯¥çª—å£å†³ä¸å…è®¸ä¸ŽDisplayCutoutåŒºåŸŸé‡å ã€‚ LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES è¯¥çª—å£å§‹ç»ˆå…è®¸å»¶ä¼¸åˆ°å±å¹•çŸ­è¾¹ä¸Šçš„DisplayCutoutåŒºåŸŸã€‚ åœ¨åˆ˜æµ·å±åŒºåŸŸå†…å±•ç¤ºå†…å®¹ï¼Œéƒ¨åˆ†å†…å®¹è¢«ã€ŽåƒæŽ‰ã€ä¸å½±å“æ•ˆæžœå¦‚ä¸‹ï¼š è¿™ç§æ–¹æ¡ˆæ¯”è¾ƒå¥½é€‚é…ï¼Œå¦‚æžœæ˜¯ Android 9.0 åŠä»¥ä¸Šç³»ç»Ÿï¼Œä½¿ç”¨å®˜æ–¹æä¾›çš„æ–¹æ¡ˆï¼Œå¦åˆ™è®¾ç½®å¸ƒå±€å»¶ä¼¸åˆ°çŠ¶æ€æ å³å¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273package com.xiaomai.demoimport android.graphics.Colorimport android.os.Buildimport android.os.Bundleimport android.support.v7.app.AppCompatActivityimport android.view.Viewimport android.view.WindowManagerimport kotlinx.android.synthetic.main.full_screen.*class FullActivity : AppCompatActivity() &#123; override fun onCreate(savedInstanceState: Bundle?) &#123; super.onCreate(savedInstanceState) setContentView(R.layout.full_screen) showTitleBar() // å¦‚æžœç³»ç»Ÿç‰ˆæœ¬å¤§äºŽç­‰äºŽ Android 9.0ï¼Œç³»ç»Ÿæ”¯æŒåˆ˜æµ·å±, å¦åˆ™éƒ¨åˆ†å›½äº§æ‰‹æœºå¯èƒ½åœ¨ Android 8.0 å°±æ”¯æŒäº†åˆ˜æµ·å±ï¼Œéœ€è¦åœ¨ manifest ä¸­é…ç½®ã€‚ if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123; window.attributes = window.attributes.apply &#123; layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_SHORT_EDGES &#125; &#125; var isShow = true touchView.setOnClickListener &#123; isShow = !isShow if (isShow) &#123; showTitleBar() &#125; else &#123; hideTitleBar() &#125; &#125; &#125; private fun showTitleBar() &#123; // è®¾ç½®çŠ¶æ€æ é€æ˜Ž if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123; window.statusBarColor = Color.TRANSPARENT &#125; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; window.decorView.systemUiVisibility = View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION or // è§†å›¾å»¶ä¼¸è‡³å¯¼èˆªæ åŒºåŸŸï¼Œå¯¼èˆªæ ä¸Šæµ®äºŽè§†å›¾ä¹‹ä¸Š View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN // è§†å›¾å»¶ä¼¸è‡³çŠ¶æ€æ åŒºåŸŸï¼ŒçŠ¶æ€æ ä¸Šæµ®äºŽè§†å›¾ä¹‹ä¸Š &#125; &#125; /** * å·²çŸ¥é—®é¢˜ï¼Œåœ¨ Vivo X21A å…¨å±é€‚é…æœ‰é—®é¢˜ */ private fun hideTitleBar() &#123; var options = View.SYSTEM_UI_FLAG_HIDE_NAVIGATION // éšè—å¯¼èˆªæ  if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; options = options or View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION or // è§†å›¾å»¶ä¼¸è‡³å¯¼èˆªæ åŒºåŸŸï¼Œå¯¼èˆªæ ä¸Šæµ®äºŽè§†å›¾ä¹‹ä¸Š View.SYSTEM_UI_FLAG_FULLSCREEN or // éšè—çŠ¶æ€æ  View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN // è§†å›¾å»¶ä¼¸è‡³çŠ¶æ€æ åŒºåŸŸï¼ŒçŠ¶æ€æ ä¸Šæµ®äºŽè§†å›¾ä¹‹ä¸Š &#125; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123; options = options or View.SYSTEM_UI_FLAG_IMMERSIVE // æ²‰æµ¸æ¨¡å¼, éšè—çŠ¶æ€æ å’Œå¯¼èˆªæ , å¹¶ä¸”åœ¨ç¬¬ä¸€æ¬¡ä¼šå¼¹æ³¡æé†’, å¹¶ä¸”åœ¨çŠ¶æ€æ åŒºåŸŸæ»‘åŠ¨å¯ä»¥å‘¼å‡ºçŠ¶æ€æ  &#125; window.decorView.systemUiVisibility = options &#125;&#125; å†…å®¹é‡è¦ï¼Œä¸èƒ½åœ¨åˆ˜æµ·å±åŒºåŸŸå±•ç¤º æ€è·¯ï¼šé¦–å…ˆæ£€æŸ¥è®¾å¤‡æ˜¯å¦æ˜¯åˆ˜æµ·å±ï¼Œå¦‚æžœæ˜¯çš„è¯åˆ™è®¾ç½®ä¸åœ¨çŠ¶æ€æ æ˜¾ç¤ºå†…å®¹ï¼Œå¦‚æžœä¸æ˜¯è¯åˆ™å¯ä»¥åœ¨çŠ¶æ€æ æ˜¾ç¤ºã€‚ æ£€æµ‹è®¾å¤‡æ˜¯å¦æ˜¯åˆ˜æµ·å±çš„æ€è·¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113class FullActivity : AppCompatActivity() &#123; private val TAG = "FullActivity" private var hasDisplayCutout = false set(value) &#123; field = value if (value) &#123; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123; window.attributes = window.attributes.apply &#123; layoutInDisplayCutoutMode = WindowManager.LayoutParams.LAYOUT_IN_DISPLAY_CUTOUT_MODE_NEVER &#125; &#125; // è®¾ç½®çŠ¶æ€æ ä¸ºé»‘è‰² if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123; window.statusBarColor = Color.BLACK &#125; &#125; else &#123; // è®¾ç½®çŠ¶æ€æ é€æ˜Ž if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123; window.statusBarColor = Color.TRANSPARENT &#125; &#125; showTitleBar() &#125; /** * ç›‘æŸ¥æ˜¯å¦æ˜¯åˆ˜æµ·å± */ private fun checkDisplayCutout() &#123; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) &#123; val decorView = window.decorView decorView.post &#123; val displayCutout = decorView.rootWindowInsets.displayCutout displayCutout?.apply &#123; Log.e(TAG, "å®‰å…¨åŒºåŸŸè·ç¦»å±å¹•å·¦è¾¹çš„è·ç¦» SafeInsetLeft:" + displayCutout.safeInsetLeft) Log.e(TAG, "å®‰å…¨åŒºåŸŸè·ç¦»å±å¹•å³éƒ¨çš„è·ç¦» SafeInsetRight:" + displayCutout.safeInsetRight) Log.e(TAG, "å®‰å…¨åŒºåŸŸè·ç¦»å±å¹•é¡¶éƒ¨çš„è·ç¦» SafeInsetTop:" + displayCutout.safeInsetTop) Log.e(TAG, "å®‰å…¨åŒºåŸŸè·ç¦»å±å¹•åº•éƒ¨çš„è·ç¦» SafeInsetBottom:" + displayCutout.safeInsetBottom) &#125; hasDisplayCutout = displayCutout?.safeInsetTop ?: 0 &gt; 0 &#125; &#125; else &#123; hasDisplayCutout = DisplayCutoutUtils.isSupportDisplayCutout(this@FullActivity) &#125; &#125; override fun onCreate(savedInstanceState: Bundle?) &#123; super.onCreate(savedInstanceState) setContentView(R.layout.full_screen) checkDisplayCutout() var isShow = true touchView.setOnClickListener &#123; isShow = !isShow if (isShow) &#123; showTitleBar() &#125; else &#123; hideTitleBar() &#125; &#125; &#125; private fun showTitleBar() &#123; var newOptions = window.decorView.systemUiVisibility if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; newOptions = View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION &#125; if (hasDisplayCutout) &#123; // do nothing &#125; else &#123; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; newOptions = newOptions or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN &#125; &#125; window.decorView.systemUiVisibility = newOptions &#125; private fun hideTitleBar() &#123; var newOptions = window.decorView.systemUiVisibility if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; newOptions = View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION or View.SYSTEM_UI_FLAG_HIDE_NAVIGATION &#125; if (hasDisplayCutout) &#123; // do nothing &#125; else &#123; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123; newOptions = (newOptions or View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN or View.SYSTEM_UI_FLAG_FULLSCREEN) &#125; if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT) &#123; newOptions = newOptions or View.SYSTEM_UI_FLAG_IMMERSIVE &#125; &#125; window.decorView.systemUiVisibility = newOptions &#125;&#125; ä»¥ä¸‹æ˜¯é€šè¿‡åå°„èŽ·å– Android P ç‰ˆæœ¬ä»¥ä¸‹çš„è®¾å¤‡æ˜¯å¦æ˜¯åˆ˜æµ·å±çš„ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146object DisplayCutoutUtils &#123; private const val TAG = "DisplayCutoutUtils" private fun Number.dp2Pixels() = TypedValue.applyDimension( TypedValue.COMPLEX_UNIT_DIP, this.toFloat(), Resources.getSystem().displayMetrics ) fun isSupportDisplayCutout(context: Context): Boolean &#123; return getDisplayCutoutHeight(context) &gt; 0 &#125; //è°ƒç”¨è¯¥æ–¹æ³•ï¼Œå¯ä»¥èŽ·å–åˆ˜æµ·å±çš„pxå€¼ï¼Œæ²¡åˆ˜æµ·å±åˆ™è¿”å›ž0 private fun getDisplayCutoutHeight(context: Context): Float &#123; var displayCutoutHeight = 0.0f //åˆ¤æ–­æ‰‹æœºåŽ‚å•†ï¼Œç›®å‰8.0åªæœ‰åŽä¸ºã€å°ç±³ã€oppoã€vivoé€‚é…äº†åˆ˜æµ·å± val phoneManufacturer = Build.BRAND.toLowerCase(Locale.CHINESE) if ("huawei" == phoneManufacturer) &#123; //huawei,é•¿åº¦ä¸ºlength,å•ä½px val haveDisplayCutoutEMUI = hasDisplayCutoutInEMUI(context) if (haveDisplayCutoutEMUI) &#123; val displayCutout: IntArray = getDisplayCutoutSizeInEMUI(context) displayCutoutHeight = displayCutout[1].toFloat() Log.e( TAG, "haveDisplayCutoutInEMUI: $haveDisplayCutoutEMUI, displayCutout: $displayCutout" ) &#125; &#125; else if ("xiaomi" == phoneManufacturer) &#123; //xiaomi,å•ä½px val haveDisplayCutoutInMIUI = getDisplayCutoutInMIUI("ro.miui.notch", 0) == 1 if (haveDisplayCutoutInMIUI) &#123; val resourceId = context.resources.getIdentifier("notch_height", "dimen", "android") var result = 0 if (resourceId &gt; 0) &#123; result = context.resources.getDimensionPixelSize(resourceId) &#125; displayCutoutHeight = result.toFloat() Log.e( TAG, "haveDisplayCutoutInMIUI: $haveDisplayCutoutInMIUI, displayCutoutHeight: $displayCutoutHeight" ) &#125; &#125; else if ("vivo" == phoneManufacturer) &#123; //vivo,å•ä½dpï¼Œé«˜åº¦27dp val haveDisplayCutoutInVIVO = hasDisplayCutoutInVivo(context) if (haveDisplayCutoutInVIVO) &#123; displayCutoutHeight = 27.dp2Pixels() Log.e( TAG, "haveDisplayCutoutInVIVO: $haveDisplayCutoutInVIVO, displayCutoutHeight: $displayCutoutHeight" ) &#125; &#125; else if ("oppo" == phoneManufacturer) &#123; //oppo val haveDisplayCutoutInOPPO = context.packageManager.hasSystemFeature("com.oppo.feature.screen.heteromorphism") if (haveDisplayCutoutInOPPO) &#123; displayCutoutHeight = 80f Log.e( TAG, "haveDisplayCutoutInOPPO: $haveDisplayCutoutInOPPO, displayCutoutHeight: $displayCutoutHeight" ) &#125; &#125; return displayCutoutHeight &#125; //huawei private fun hasDisplayCutoutInEMUI(context: Context): Boolean &#123; var ret = false try &#123; val cl = context.classLoader val hwNotchSizeUtilClass = cl.loadClass("com.huawei.android.util.HwNotchSizeUtil") val hasNotchInScreenMethod = hwNotchSizeUtilClass.getMethod("hasNotchInScreen") ret = hasNotchInScreenMethod.invoke(hwNotchSizeUtilClass) as Boolean &#125; catch (e: ClassNotFoundException) &#123; Log.e(TAG, "hasDisplayCutoutInEMUI ClassNotFoundException") &#125; catch (e: NoSuchMethodException) &#123; Log.e(TAG, "hasDisplayCutoutInEMUI NoSuchMethodException") &#125; catch (e: Exception) &#123; Log.e(TAG, "hasDisplayCutoutInEMUI Exception") &#125; finally &#123; return ret &#125; &#125; private fun getDisplayCutoutSizeInEMUI(context: Context): IntArray &#123; var ret = intArrayOf(0, 0) try &#123; val cl = context.classLoader val hwNotchSizeUtilClass = cl.loadClass("com.huawei.android.util.HwNotchSizeUtil") val getNotchSizeMethod = hwNotchSizeUtilClass.getMethod("getNotchSize") ret = getNotchSizeMethod.invoke(hwNotchSizeUtilClass) as IntArray &#125; catch (e: ClassNotFoundException) &#123; Log.e(TAG, "getDisplayCutoutSizeInEMUI ClassNotFoundException") &#125; catch (e: NoSuchMethodException) &#123; Log.e(TAG, "getDisplayCutoutSizeInEMUI NoSuchMethodException") &#125; catch (e: Exception) &#123; Log.e(TAG, "getDisplayCutoutSizeInEMUI Exception") &#125; finally &#123; return ret &#125; &#125; private fun getDisplayCutoutInMIUI(key: String, def: Int): Int &#123; var getIntMethod: Method? = null try &#123; if (getIntMethod == null) &#123; getIntMethod = Class.forName("android.os.SystemProperties") .getMethod("getInt", String::class.java, Int::class.javaPrimitiveType) &#125; return (getIntMethod?.invoke(null, key, def) as? Int)?.toInt() ?: 0 &#125; catch (e: Exception) &#123; Log.e(TAG, "Platform error: $e") return def &#125; &#125; private fun hasDisplayCutoutInVivo(context: Context): Boolean &#123; var ret = false try &#123; val classLoader = context.classLoader val ftFeatureClass = classLoader.loadClass("android.util.FtFeature") val isFeatureSupportMethod = ftFeatureClass.getMethod("isFeatureSupport", Int::class.javaPrimitiveType!!) ret = isFeatureSupportMethod.invoke(ftFeatureClass, 0x00000020) as Boolean &#125; catch (e: ClassNotFoundException) &#123; Log.e(TAG, "hasDisplayCutoutInVivo ClassNotFoundException") &#125; catch (e: NoSuchMethodException) &#123; Log.e(TAG, "hasDisplayCutoutInVivo NoSuchMethodException") &#125; catch (e: Exception) &#123; Log.e(TAG, "hasDisplayCutoutInVivo Exception") &#125; finally &#123; return ret &#125; &#125;&#125; å¸¦è™šæ‹Ÿå¯¼èˆªçš„ Pad è®¾å¤‡æœ‰çš„ Pad åœ¨æ¨ªå±æ—¶ï¼Œè™šæ‹Ÿå¯¼èˆªåœ¨å±å¹•å³ä¾§ï¼Œè€Œæœ‰çš„åœ¨å±å¹•ä¸‹æ–¹ã€‚æœ‰ä¸¤ç§è®¡ç®—å±å¹•å®½é«˜çš„æ–¹æ³•ï¼Œä¸€ç§åŒ…å«è™šæ‹Ÿå¯¼èˆªæ ï¼Œä¸€ç§ä¸åŒ…å«ã€‚ 123456789101112131415161718192021222324252627282930313233fun getScreenHeight() = Resources.getSystem().displayMetrics.heightPixelsfun getScreenWidth() = Resources.getSystem().displayMetrics.widthPixels/** * åŒ…å«è™šæ‹Ÿå¯¼èˆªæ  */fun getRealScreenHeight(context: Context): Int &#123; return if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) &#123; val windowManager = context.getSystemService(Context.WINDOW_SERVICE) as WindowManager val display = windowManager.defaultDisplay val metrics = DisplayMetrics() display.getRealMetrics(metrics) metrics.heightPixels &#125; else &#123; getScreenHeight() &#125;&#125;/** * åŒ…å«è™šæ‹Ÿå¯¼èˆªæ  */fun getRealScreenWidth(context: Context): Int &#123; return if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) &#123; val windowManager = context.getSystemService(Context.WINDOW_SERVICE) as WindowManager val display = windowManager.defaultDisplay val metrics = DisplayMetrics() display.getRealMetrics(metrics) metrics.widthPixels &#125; else &#123; getScreenWidth() &#125;&#125; å‚è€ƒé“¾æŽ¥ https://developer.android.com/guide/topics/display-cutout https://juejin.im/post/5b1930835188257d7541ba33 MIUI å¼€å‘æ–‡æ¡£ Vivo å¼€å‘æ–‡æ¡£]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>å±å¹•é€‚é…</tag>
        <tag>åˆ˜æµ·å±</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Dialog ä¸­ç›‘å¬é”®ç›˜å¼¹å‡ºä¸Žæ”¶èµ·äº‹ä»¶]]></title>
    <url>%2Fposts%2Fa5f0e43e.html</url>
    <content type="text"><![CDATA[æœ€è¿‘é‡åˆ°äº†ä¸€ä¸ªåœ¨ Dialog ä¸­ç›‘å¬é”®ç›˜å¼¹å‡ºä¸Žæ”¶èµ·äº‹ä»¶çš„éœ€æ±‚ï¼Œç»è¿‡æŸ¥è¯¢èµ„æ–™å†ä¸Žè‡ªå·±çš„éœ€æ±‚ç›¸ç»“åˆç„¶åŽæ€è€ƒï¼Œæœ€ç»ˆè§£å†³äº†é—®é¢˜ã€‚çŽ°å°†ä¸­é—´é‡åˆ°çš„é—®é¢˜ä¸Žè§£å†³åŠžæ³•è®°å½•ä¸‹æ¥ã€‚ éœ€æ±‚ä¸Žæ•ˆæžœ æ€è·¯è‡ªå®šä¹‰ Dialogï¼Œé€šè¿‡è®¾ç½® Dialog çš„ â€œwindowSoftInputModeâ€ é…åˆç›‘å¬ Dialog æ‰€åœ¨ Window çš„é«˜åº¦å˜åŒ–æ¥åˆ¤æ–­é”®ç›˜å½“å‰çš„çŠ¶æ€ã€‚ å®žçŽ°å¸ƒå±€1234567891011121314151617181920212223242526272829303132333435&lt;?xml version="1.0" encoding="utf-8"?&gt;&lt;LinearLayout xmlns:android="http://schemas.android.com/apk/res/android" android:id="@+id/rootView" android:layout_width="match_parent" android:layout_height="44dp" android:layout_gravity="bottom" android:background="@android:color/white" android:orientation="horizontal"&gt; &lt;EditText android:id="@+id/editText" android:layout_width="0dp" android:layout_height="wrap_content" android:layout_gravity="center_vertical" android:layout_weight="1" android:background="@null" android:hint="ç‚¹æ­¤å‚åŠ è®¨è®º~" android:maxLines="1" android:paddingLeft="10dp" android:paddingRight="10dp" android:singleLine="true" android:textColor="@android:color/black" android:textSize="13sp" /&gt; &lt;TextView android:id="@+id/sendButton" android:layout_width="wrap_content" android:layout_height="match_parent" android:gravity="center" android:paddingLeft="15dp" android:paddingRight="15dp" android:text="å‘é€" android:textColor="@android:color/black" android:textSize="13sp" /&gt;&lt;/LinearLayout&gt; style1234567&lt;style name="Dialog" parent="Theme.AppCompat.Dialog"&gt; &lt;item name="android:background"&gt;@android:color/transparent&lt;/item&gt; &lt;item name="android:windowBackground"&gt;@android:color/transparent&lt;/item&gt; &lt;item name="android:windowNoTitle"&gt;true&lt;/item&gt; &lt;item name="android:windowSoftInputMode"&gt;adjustPan|stateVisible&lt;/item&gt; &lt;item name="android:backgroundDimEnabled"&gt;false&lt;/item&gt;&lt;/style&gt; Dialog12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879class MyDialog(context: Context, private val callback: Callback) : Dialog(context, R.style.Dialog) &#123; companion object &#123; private const val TAG = "MyDialog" &#125; override fun onCreate(savedInstanceState: Bundle?) &#123; super.onCreate(savedInstanceState) setContentView(R.layout.mydioalog) window?.attributes = window?.attributes?.apply &#123; width = WindowManager.LayoutParams.MATCH_PARENT // å› ä¸º adjustPan åœ¨é”®ç›˜å¼¹å‡ºåŽå¸ƒå±€é«˜åº¦å¤§äºŽå±å¹•ä¸Šé™¤é”®ç›˜ä¹‹å¤–çš„å¯ç”¨åŒºåŸŸçš„é«˜åº¦æ—¶æ‰ä¼šèµ·æ•ˆï¼Œ // è€Œæˆ‘ä»¬ç›‘å¬çš„å°±æ˜¯å¸ƒå±€åœ¨é”®ç›˜å¼¹å‡ºä¸Žæ”¶èµ·æ—¶å¯è§åŒºåŸŸçš„é«˜åº¦çš„å˜åŒ–ï¼Œä»Žè€Œåˆ¤æ–­é”®ç›˜å½“å‰çš„çŠ¶æ€çš„ã€‚ // ä½†æ˜¯ä¸åŒçš„æ‰‹æœºå±å¹•é«˜åº¦ä¸åŒï¼Œæ‰€ä»¥éœ€è¦åŠ¨æ€è®¾ç½®ã€‚ // å¯ç”¨é«˜åº¦ = å±å¹•é«˜åº¦ - çŠ¶æ€æ é«˜åº¦ height = Resources.getSystem().displayMetrics.heightPixels - getStatusBarHeight() gravity = Gravity.BOTTOM &#125; rootView.viewTreeObserver.addOnGlobalLayoutListener &#123; val decorView = window.decorView val visibleDisplayRect = Rect() // æ£€æµ‹å½“å‰è§†å›¾æ‰€åœ¨çš„ Window å¯è§åŒºåŸŸçš„å¤§å° decorView.getWindowVisibleDisplayFrame(visibleDisplayRect) val visibleHeight = decorView.height Log.d(TAG, "visibleHeight $visibleHeight") when &#123; decorViewVisibleHeight == 0 -&gt; &#123; // do nothing &#125; decorViewVisibleHeight &gt; visibleDisplayRect.height() -&gt; callback.onKeyboardShow() else -&gt; callback.onKeyboardDismiss() &#125; decorViewVisibleHeight = visibleHeight &#125; &#125; /** * èŽ·å–çŠ¶æ€æ é«˜åº¦ */ private fun getStatusBarHeight(): Int &#123; val resourceId = Resources.getSystem().getIdentifier( "status_bar_height", "dimen", "android" ) return if (resourceId &gt; 0) &#123; context.resources.getDimensionPixelSize(resourceId) &#125; else &#123; TypedValue.applyDimension( TypedValue.COMPLEX_UNIT_DIP, 25f, Resources.getSystem().displayMetrics ).toInt() &#125; &#125; private var decorViewVisibleHeight = 0 interface Callback &#123; /** * é”®ç›˜å¼¹å‡º */ fun onKeyboardShow() /** * é”®ç›˜æ”¶èµ· */ fun onKeyboardDismiss() &#125;&#125; æ·»åŠ æ˜¾ç¤º Dialog çš„ç‚¹å‡»äº‹ä»¶åœ¨ Activity ä¸­æ·»åŠ ä¸€ä¸ªæŒ‰é’®ï¼Œå¹¶ä¸ºå®ƒæ·»åŠ ç‚¹å‡»äº‹ä»¶å¦‚ä¸‹ï¼š 12345678910button.setOnClickListener &#123; MyDialog(this, object : MyDialog.Callback &#123; override fun onKeyboardShow() &#123; textView.text = "é”®ç›˜æ˜¾ç¤º" &#125; override fun onKeyboardDismiss() &#123; textView.text = "é”®ç›˜éšè—" &#125; &#125;).show()&#125; æ­¤æ—¶å·²ç»å¯ä»¥ç›‘å¬åˆ°é”®ç›˜çš„å¼¹å‡ºä¸Žæ”¶èµ·äº‹ä»¶äº†ï¼Œä½†æ˜¯ä»”ç»†çœ‹è¾“å…¥æ¡†ä¼šå‘çŽ°ä¸‹åŠéƒ¨åˆ†è¢«é”®ç›˜ç›–ä½äº†ã€‚ è§£å†³é—®é¢˜ç»è¿‡ç ”ç©¶å‘çŽ°è¿™ä¸Ž EditText çš„ background å±žæ€§æœ‰å…³ï¼Œå…ˆæŠŠ android:background=&quot;@null&quot; åŽ»æŽ‰ï¼Œæ•ˆæžœå¦‚ä¸‹ï¼š é‚£ä¹ˆ background è®¾ç½®ä¸º null ä¸Žé»˜è®¤å€¼çš„å·®åˆ«åœ¨å“ªé‡Œå‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡ EditText çš„æºç æ‰¾ä¸€ä¸‹ç­”æ¡ˆã€‚ 12345678910public class EditText extends TextView &#123; public EditText(Context context) &#123; this(context, null); &#125; public EditText(Context context, AttributeSet attrs) &#123; this(context, attrs, com.android.internal.R.attr.editTextStyle); &#125;...&#125; ä»Žæºç ä¸­å¯ä»¥çœ‹å‡º EditText çš„é»˜è®¤ style ä¸º com.android.internal.R.attr.editTextStyleï¼ŒæŽ¥ä¸‹æ¥å…¨å±€æœç´¢çœ‹ä¸€ä¸‹è¿™ä¸ª style çš„ç‰¹å¾ï¼š ä¸€è·¯è¿½è¸ª parentï¼Œæœ€ç»ˆå‘çŽ°é¡¶çº§ parent å¦‚ä¸‹ï¼š 12345&lt;style name="Widget.EditText"&gt; ... &lt;item name="background"&gt;?attr/editTextBackground&lt;/item&gt; ...&lt;/style&gt; å†å…¨å±€æœç´¢ editTextBackground å…³é”®å­—ï¼š ä»Žå›¾ä¸­å¯ä»¥çœ‹å‡ºæœ‰å¾ˆå¤š item çš„ name æ˜¯ editTextBackgroundï¼Œéšä¾¿æ‰“å¼€ä¸€ä¸ªï¼Œè¿™é‡Œå°±ä»¥å›¾ä¸­é€‰ä¸­çš„ä¸ºä¾‹ï¼Œæ‰“å¼€æ–‡ä»¶å¦‚ä¸‹ï¼š 1234567891011121314151617181920&lt;inset xmlns:android="http://schemas.android.com/apk/res/android" android:insetLeft="@dimen/edit_text_inset_horizontal_material" android:insetRight="@dimen/edit_text_inset_horizontal_material" android:insetTop="@dimen/edit_text_inset_top_material" android:insetBottom="@dimen/edit_text_inset_bottom_material"&gt; &lt;selector&gt; &lt;item android:state_enabled="false"&gt; &lt;nine-patch android:src="@drawable/textfield_default_mtrl_alpha" android:tint="?attr/colorControlNormal" /&gt; &lt;/item&gt; &lt;item android:state_pressed="false" android:state_focused="false"&gt; &lt;nine-patch android:src="@drawable/textfield_default_mtrl_alpha" android:tint="?attr/colorControlNormal" /&gt; &lt;/item&gt; &lt;item&gt; &lt;nine-patch android:src="@drawable/textfield_activated_mtrl_alpha" android:tint="?attr/colorControlActivated" /&gt; &lt;/item&gt; &lt;/selector&gt;&lt;/inset&gt; å¯ä»¥çœ‹åˆ°æ˜¯é€šè¿‡ xml è®¾ç½®äº†ä¸€ä¸ª InsetDrawableï¼Œè¿™é‡Œæ•ˆæžœå¦‚åŒç»™ EditText è®¾ç½® paddingã€‚æ‰€ä»¥æˆ‘ä»¬ç»™ EditText æ·»åŠ  paddingTop å’Œ paddingBottomï¼Œè¿è¡ŒåŽå‘çŽ°æ•ˆæžœ OKã€‚ ä½¿ç”¨ FragmentDialog æ³¨æ„å› ä¸º FragmentDialog æ˜¯ä¸€ä¸ª Fragmentï¼Œæ‰€ä»¥æ—¢å¯ä»¥é€šè¿‡ getActivity().getWindow() ä¹Ÿå¯ä»¥ä½¿ç”¨ dialog.getWindow()ï¼Œä½†æ˜¯è¦æ³¨æ„è¿™é‡Œåº”è¯¥ä½¿ç”¨ dialog.getWindow()ï¼Œåä¹‹å°†ä¸ä¼šæœ‰é¢„æœŸæ•ˆæžœã€‚]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Dialog</tag>
        <tag>é”®ç›˜</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸ªäººåšå®¢è¿›åŒ–å²]]></title>
    <url>%2Fposts%2F61f01eb0.html</url>
    <content type="text"><![CDATA[ä¸ªäººåšå®¢æ˜¯ä¸€ä¸ªä¸æ–­è¿›åŒ–çš„è¿‡ç¨‹ï¼Œåœ¨è¿™é‡Œè®°å½•ä¸‹åšå®¢ä¼˜åŒ–çš„ç‚¹ç‚¹æ»´æ»´ã€‚ 2019å¹´08æœˆ07æ—¥ ä½¿ç”¨ hexo_resize_image æ”¯æŒåœ¨ markdown ä¸­è®¾ç½®å›¾ç‰‡å¤§å°ã€‚ 2019å¹´08æœˆ05æ—¥ æ–‡ç« é“¾æŽ¥ä½¿ç”¨ hexo-abbrlink æ”¯æŒæ–‡ç«  Idã€‚ ä½¿ç”¨ hexo-tag-aplayer æ”¯æŒèƒŒæ™¯éŸ³ä¹ã€‚ éŸ³ä¹ç›´é“¾æœç´¢ 2019å¹´08æœˆ01æ—¥ SEO ä¼˜åŒ– å‚è€ƒæ–‡ç«  https://chenhuichao.com/2018/04/13/seo/seo-search-engine-principle/ https://www.jianshu.com/p/9c2d6db2f855 https://accelerator-blog.com/2019/07/27/%E5%8D%9A%E5%AE%A2%E5%8A%9F%E8%83%BD%E4%BC%98%E5%8C%96/ ä½¿ç”¨ hexo-generator-sitemap å’Œ hexo-generator-baidu-sitemap ç”Ÿæˆç«™ç‚¹åœ°å›¾ ä½¿ç”¨ hexo-symbols-count-time æ”¯æŒå­—æ•°ç»Ÿè®¡ ä½¿ç”¨ hexo-generator-searchdb æ”¯æŒç«™å†…æœç´¢ 2019å¹´05æœˆ28æ—¥ å¼€å§‹ä½¿ç”¨ Hexo æ­å»ºä¸ªäººåšå®¢ã€‚]]></content>
      <categories>
        <category>å…¶ä»–</category>
      </categories>
  </entry>
  <entry>
    <title><![CDATA[å­—ç¬¦ç¼–ç çš„åŽ†å²æ¼”å˜]]></title>
    <url>%2Fposts%2Fa082b9c.html</url>
    <content type="text"><![CDATA[å› ä¸ºè®¡ç®—æœºåªèƒ½å¤„ç†æ•°å­—ï¼Œå¦‚æžœè¦å¤„ç†æ–‡æœ¬ï¼Œå°±å¿…é¡»å…ˆæŠŠæ–‡æœ¬è½¬æ¢ä¸ºæ•°å­—æ‰èƒ½å¤„ç†ã€‚æœ€æ—©çš„è®¡ç®—æœºåœ¨è®¾è®¡æ—¶é‡‡ç”¨8ä¸ªæ¯”ç‰¹ï¼ˆbitï¼‰ä½œä¸ºä¸€ä¸ªå­—èŠ‚ï¼ˆbyteï¼‰ï¼Œæ‰€ä»¥ï¼Œä¸€ä¸ªå­—èŠ‚èƒ½è¡¨ç¤ºçš„æœ€å¤§çš„æ•´æ•°å°±æ˜¯255ï¼ˆäºŒè¿›åˆ¶ 11111111 = åè¿›åˆ¶255ï¼‰ï¼Œå¦‚æžœè¦è¡¨ç¤ºæ›´å¤§çš„æ•´æ•°ï¼Œå°±å¿…é¡»ç”¨æ›´å¤šçš„å­—èŠ‚ã€‚æ¯”å¦‚ä¸¤ä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°æ˜¯65535ï¼Œ4ä¸ªå­—èŠ‚å¯ä»¥è¡¨ç¤ºçš„æœ€å¤§æ•´æ•°æ˜¯4294967295ã€‚ ASCII ç¼–ç çš„è¯žç”Ÿç”±äºŽè®¡ç®—æœºæ˜¯ç¾Žå›½äººå‘æ˜Žçš„ï¼Œå› æ­¤ï¼Œæœ€æ—©åªæœ‰127ä¸ªå­—ç¬¦è¢«ç¼–ç åˆ°è®¡ç®—æœºé‡Œï¼Œä¹Ÿå°±æ˜¯å¤§å°å†™è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸€äº›ç¬¦å·ï¼Œè¿™ä¸ªç¼–ç è¡¨è¢«ç§°ä¸º ASCII ç¼–ç ï¼Œæ¯”å¦‚å¤§å†™å­—æ¯ A çš„ç¼–ç æ˜¯65ï¼Œå°å†™å­—æ¯ z çš„ç¼–ç æ˜¯122ã€‚ ä½†æ˜¯è¦å¤„ç†ä¸­æ–‡ï¼Œæ˜¾ç„¶ä¸€ä¸ªå­—èŠ‚æ˜¯ä¸å¤Ÿçš„ï¼Œè‡³å°‘éœ€è¦ä¸¤ä¸ªå­—èŠ‚ï¼Œè€Œä¸”è¿˜ä¸èƒ½å’ŒASCIIç¼–ç å†²çªï¼Œæ‰€ä»¥ï¼Œä¸­å›½åˆ¶å®šäº† GB2312 ç¼–ç ï¼Œç”¨æ¥æŠŠä¸­æ–‡ç¼–è¿›åŽ»ã€‚ å…«ä»™è¿‡æµ·ï¼Œå„æ˜¾ç¥žé€šä½†å…¨ä¸–ç•Œæœ‰ä¸Šç™¾ç§è¯­è¨€ï¼Œæ—¥æœ¬æŠŠæ—¥æ–‡ç¼–åˆ° Shift_JIS é‡Œï¼ŒéŸ©å›½æŠŠéŸ©æ–‡ç¼–åˆ°Euc-kr é‡Œï¼Œå„å›½æœ‰å„å›½çš„æ ‡å‡†ï¼Œå°±ä¼šä¸å¯é¿å…åœ°å‡ºçŽ°å†²çªï¼Œç»“æžœå°±æ˜¯ï¼Œåœ¨å¤šè¯­è¨€æ··åˆçš„æ–‡æœ¬ä¸­ï¼Œæ˜¾ç¤ºå‡ºæ¥ä¼šæœ‰ä¹±ç ã€‚ Unicode ä¸ºç»Ÿä¸€è€Œç”Ÿä¸ºäº†é¿å…å„å›½ä¹‹é—´çš„ç¼–ç å†²çªï¼ŒUnicodeåº”è¿è€Œç”Ÿã€‚UnicodeæŠŠæ‰€æœ‰è¯­è¨€éƒ½ç»Ÿä¸€åˆ°ä¸€å¥—ç¼–ç é‡Œï¼Œè¿™æ ·å°±ä¸ä¼šå†æœ‰ä¹±ç é—®é¢˜äº†ã€‚ Unicodeæ ‡å‡†ä¹Ÿåœ¨ä¸æ–­å‘å±•ï¼Œä½†æœ€å¸¸ç”¨çš„æ˜¯ç”¨ä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ï¼ˆå¦‚æžœè¦ç”¨åˆ°éžå¸¸ååƒ»çš„å­—ç¬¦ï¼Œå°±éœ€è¦4ä¸ªå­—èŠ‚ï¼‰ã€‚çŽ°ä»£æ“ä½œç³»ç»Ÿå’Œå¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€éƒ½ç›´æŽ¥æ”¯æŒUnicodeã€‚ æ–°çš„é—®é¢˜åˆå‡ºçŽ°äº†ï¼šå¦‚æžœç»Ÿä¸€æˆUnicodeç¼–ç ï¼Œä¹±ç é—®é¢˜ä»Žæ­¤æ¶ˆå¤±äº†ã€‚ä½†æ˜¯ï¼Œå¦‚æžœä½ å†™çš„æ–‡æœ¬åŸºæœ¬ä¸Šå…¨éƒ¨æ˜¯è‹±æ–‡çš„è¯ï¼Œç”¨Unicodeç¼–ç æ¯”ASCIIç¼–ç éœ€è¦å¤šä¸€å€çš„å­˜å‚¨ç©ºé—´ï¼Œåœ¨å­˜å‚¨å’Œä¼ è¾“ä¸Šå°±ååˆ†ä¸åˆ’ç®—ã€‚ UTF-8 æ¥ä¼˜åŒ– Unicodeæœ¬ç€èŠ‚çº¦çš„ç²¾ç¥žï¼Œåˆå‡ºçŽ°äº†æŠŠUnicodeç¼–ç è½¬åŒ–ä¸ºâ€œå¯å˜é•¿ç¼–ç â€çš„UTF-8ç¼–ç ã€‚UTF-8ç¼–ç æŠŠä¸€ä¸ªUnicodeå­—ç¬¦æ ¹æ®ä¸åŒçš„æ•°å­—å¤§å°ç¼–ç æˆ1-6ä¸ªå­—èŠ‚ï¼Œå¸¸ç”¨çš„è‹±æ–‡å­—æ¯è¢«ç¼–ç æˆ1ä¸ªå­—èŠ‚ï¼Œæ±‰å­—é€šå¸¸æ˜¯3ä¸ªå­—èŠ‚ï¼Œåªæœ‰å¾ˆç”Ÿåƒ»çš„å­—ç¬¦æ‰ä¼šè¢«ç¼–ç æˆ4-6ä¸ªå­—èŠ‚ã€‚å¦‚æžœä½ è¦ä¼ è¾“çš„æ–‡æœ¬åŒ…å«å¤§é‡è‹±æ–‡å­—ç¬¦ï¼Œç”¨UTF-8ç¼–ç å°±èƒ½èŠ‚çœç©ºé—´ï¼š å­—ç¬¦ ASCII Unicode UTF-8 A 01000001 00000000 01000001 01000001 ä¸­ x 01001110 00101101 11100100 10111000 10101101 ä»Žä¸Šé¢çš„è¡¨æ ¼è¿˜å¯ä»¥å‘çŽ°ï¼ŒUTF-8ç¼–ç æœ‰ä¸€ä¸ªé¢å¤–çš„å¥½å¤„ï¼Œå°±æ˜¯ASCIIç¼–ç å®žé™…ä¸Šå¯ä»¥è¢«çœ‹æˆæ˜¯UTF-8ç¼–ç çš„ä¸€éƒ¨åˆ†ã€‚ å¦‚æžœæŠŠASCIIç¼–ç çš„Aç”¨Unicodeç¼–ç ï¼Œåªéœ€è¦åœ¨å‰é¢è¡¥0å°±å¯ä»¥ï¼Œå› æ­¤ï¼ŒAçš„Unicodeç¼–ç æ˜¯00000000 01000001ã€‚ æ€»ç»“æžæ¸…æ¥šäº†ASCIIã€Unicodeå’ŒUTF-8çš„å…³ç³»ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ€»ç»“ä¸€ä¸‹çŽ°åœ¨è®¡ç®—æœºç³»ç»Ÿé€šç”¨çš„å­—ç¬¦ç¼–ç å·¥ä½œæ–¹å¼ï¼š åœ¨è®¡ç®—æœºå†…å­˜ä¸­ï¼Œç»Ÿä¸€ä½¿ç”¨Unicodeç¼–ç ï¼Œå½“éœ€è¦ä¿å­˜åˆ°ç¡¬ç›˜æˆ–è€…éœ€è¦ä¼ è¾“çš„æ—¶å€™ï¼Œå°±è½¬æ¢ä¸ºUTF-8ç¼–ç ã€‚ ç”¨è®°äº‹æœ¬ç¼–è¾‘çš„æ—¶å€™ï¼Œä»Žæ–‡ä»¶è¯»å–çš„UTF-8å­—ç¬¦è¢«è½¬æ¢ä¸ºUnicodeå­—ç¬¦åˆ°å†…å­˜é‡Œï¼Œç¼–è¾‘å®ŒæˆåŽï¼Œä¿å­˜çš„æ—¶å€™å†æŠŠUnicodeè½¬æ¢ä¸ºUTF-8ä¿å­˜åˆ°æ–‡ä»¶ã€‚ å‚è€ƒæ–‡ç« https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000/001431664106267f12e9bef7ee14cf6a8776a479bdec9b9000 å¼€æºå·¥å…·æŽ¨å¹¿ä½ è¿˜åœ¨ä¸ºå¼€å‘ä¸­é¢‘ç¹åˆ‡æ¢çŽ¯å¢ƒæ‰“åŒ…è€Œçƒ¦æ¼å—ï¼Ÿå¿«æ¥è¯•è¯• Environment Switcher å§ï¼ä½¿ç”¨å®ƒå¯ä»¥åœ¨appè¿è¡Œæ—¶ä¸€é”®åˆ‡æ¢çŽ¯å¢ƒï¼Œè€Œä¸”è¿˜æ”¯æŒå…¶ä»–è´´å¿ƒå°åŠŸèƒ½ï¼Œæœ‰äº†å®ƒå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒé¢‘ç¹çŽ¯å¢ƒåˆ‡æ¢äº†ã€‚https://github.com/CodeXiaoMai/EnvironmentSwitcher]]></content>
      <categories>
        <category>åŸºç¡€çŸ¥è¯†</category>
      </categories>
      <tags>
        <tag>å­—ç¬¦ç¼–ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[EnvironmentSwitcher]]></title>
    <url>%2Fposts%2F1d56b016.html</url>
    <content type="text"><![CDATA[Environment Switcher æ˜¯ä¸€ä¸ªåœ¨ Android çš„å¼€å‘å’Œæµ‹è¯•é˜¶æ®µï¼Œè¿ç”¨ Java æ³¨è§£ã€APTã€åå°„ã€æ··æ·†ç­‰åŽŸç†æ¥ä¸€é”®åˆ‡æ¢çŽ¯å¢ƒçš„å·¥å…·ã€‚ ç›®å‰è¯¥é¡¹ç›®å·²ç»è¾¾æˆå¦‚ä¸‹æˆå°±ï¼š å®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š é…ç½®ç®€å• å®‰å…¨ï¼Œä¸æ³„æ¼æµ‹è¯•çŽ¯å¢ƒåœ°å€ ä¸ç”¨é‡æ–°æ‰“åŒ…å³å¯ä¸€é”®åˆ‡æ¢çŽ¯å¢ƒ æ”¯æŒæŒ‰æ¨¡å—é…ç½®ä¸Žåˆ‡æ¢çŽ¯å¢ƒ æ”¯æŒçŽ¯å¢ƒåˆ‡æ¢é€šçŸ¥å›žè°ƒ è‡ªåŠ¨ç”Ÿæˆ åˆ‡æ¢ ä¿å­˜ èŽ·å– çŽ¯å¢ƒçš„é€»è¾‘ä»£ç  ä¸Žé¡¹ç›®è§£è€¦ â€¦â€¦ ä¸ºä»€ä¹ˆä¸ç”¨ Gradleçœ‹åˆ°è¿™é‡Œä½ å¯èƒ½ä¼šæƒ³ï¼Œè¿™äº›åŠŸèƒ½æˆ‘ç”¨ Gradle å°±èƒ½æžå®šäº†ï¼Œä¸ºä»€ä¹ˆè¦ç”¨ Environment Switcher å‘¢ï¼Ÿåˆ«ç€æ€¥ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ¯”è¾ƒä¸€ä¸‹ Environment Switcher å’Œ Gradleã€‚ æ¯”è¾ƒå†…å®¹ Environment Switcher Gradle Application Id ä¸åŒ Gradle Application Id ç›¸åŒ è¿è¡Œæ—¶åˆ‡æ¢çŽ¯å¢ƒ âœ”ï¸ âœ–ï¸ âœ–ï¸ åˆ‡æ¢çŽ¯å¢ƒå›žè°ƒ âœ”ï¸ âœ–ï¸ âœ–ï¸ åˆ‡æ¢çŽ¯å¢ƒé€»è¾‘ è‡ªåŠ¨ç”Ÿæˆ éœ€è¦è‡ªå·±å®žçŽ° éœ€è¦è‡ªå·±å®žçŽ° n å¥—çŽ¯å¢ƒæ‰“åŒ…æ•°é‡ 1ä¸ª nä¸ª nä¸ª å¤šå¥—çŽ¯å¢ƒåŒæ—¶å®‰è£… âœ”ï¸ âœ”ï¸ âœ–ï¸ æ”¯ä»˜ç­‰SDKåŒ…åæ ¡éªŒ âœ”ï¸ âœ–ï¸ âœ”ï¸ å¤šæ¨¡å—çŽ¯å¢ƒé…ç½® âœ”ï¸ âœ”ï¸ âœ”ï¸ æµ‹è¯•çŽ¯å¢ƒä¸æ³„éœ² âœ”ï¸ âœ”ï¸ âœ”ï¸ â€¦â€¦ â€”â€” â€”â€” â€”â€” è¿™é‡Œå°±å…ˆåˆ—ä¸¾è¿™ä¹ˆå¤šï¼Œä»… è¿è¡Œæ—¶åˆ‡æ¢çŽ¯å¢ƒ ã€æ‰“åŒ…æ•°é‡ã€åˆ‡æ¢çŽ¯å¢ƒå›žè°ƒ è¿™å‡ ä¸ªç‰¹ç‚¹å°±æ¯” Gradle æ–¹ä¾¿å¾ˆå¤šï¼Œè€Œä¸” Environment Switcher çš„æŽ¥å…¥æˆæœ¬ä¹Ÿå¾ˆä½Žã€‚æ˜¯ä¸æ˜¯æƒ³è¯•ä¸€è¯•äº†ï¼Ÿ ä½¿ç”¨æ–¹æ³• module environmentswitcher environmentswitcher-compiler environmentswitcher-compiler-release version é…ç½®é¡¹ç›®çš„ build.gradlejava ç‰ˆ123456dependencies &#123; ... implementation &quot;com.xiaomai.environmentswitcher:environmentswitcher:$version&quot; debugAnnotationProcessor &quot;com.xiaomai.environmentswitcher:environmentswitcher-compiler:$version&quot; releaseAnnotationProcessor &quot;com.xiaomai.environmentswitcher:environmentswitcher-compiler-release:$version&quot;&#125; kotlin ç‰ˆ12345678apply plugin: &apos;kotlin-kapt&apos;...dependencies &#123; ... implementation &quot;com.xiaomai.environmentswitcher:environmentswitcher:$version&quot; kaptDebug &quot;com.xiaomai.environmentswitcher:environmentswitcher-compiler:$version&quot; kaptRelease &quot;com.xiaomai.environmentswitcher:environmentswitcher-compiler-release:$version&quot;&#125; ç¼–å†™ EnvironmentConfig æ–‡ä»¶è¿™ä¸ªç±»æ˜¯ Environment Switcher ä¾èµ–çš„æ ¸å¿ƒä»£ç ï¼Œæ‰€æœ‰èŽ·å–ã€ä¿®æ”¹çŽ¯å¢ƒçš„é€»è¾‘ä»£ç éƒ½ä¼šä¾èµ–è¿™ä¸ªç±»ä¸­è¢« @Module å’Œ @Environment ä¸¤ä¸ªæ³¨è§£æ ‡è®°çš„ç±»å’Œå±žæ€§è‡ªåŠ¨ç”Ÿæˆã€‚ æ³¨æ„ï¼šå¦‚æžœä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨äº† Kotlinï¼Œè¯·ä½¿ç”¨ Java è¯­è¨€ç¼–å†™ EnvironmentConfigï¼Œæš‚æ—¶è¿˜ä¸æ”¯æŒä½¿ç”¨ Kotlin ç¼–å†™è¿™ä¸ªç±»ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051/** * çŽ¯å¢ƒé…ç½®ç±»&lt;/br&gt; * * âš  å»ºè®®ä¸è¦å¼•ç”¨è¯¥ç±»ä¸­çš„ä»»ä½•å­ç±»å’Œæˆå‘˜å˜é‡ï¼Œä¸€ä½†å¼•ç”¨äº†éžæ­£å¼çŽ¯å¢ƒçš„å±žæ€§ï¼Œæ‰“åŒ…æ—¶æ··æ·†å·¥å…·å°±ä¸ä¼šç§»é™¤è¯¥ç±»ï¼Œå¯¼è‡´æµ‹è¯•åœ°å€æ³„æ¼ã€‚&lt;/br&gt; * Environment Switcher åœ¨ç¼–è¯‘ Release ç‰ˆæœ¬æ—¶ï¼Œä¼šè‡ªåŠ¨éšè—æµ‹è¯•çŽ¯å¢ƒåœ°å€ã€‚&lt;/br&gt;&lt;/br&gt; * * å»ºè®®å°†è¯¥ç±»ä¸­æ‰€æœ‰è¢« &#123;@link Module&#125; å’Œ &#123;@link Environment&#125; ä¿®é¥°çš„ç±»æˆ–æˆå‘˜å˜é‡ç”¨ private ä¿®é¥°ï¼Œ&lt;/br&gt; * Environment Switcher ä¼šåœ¨ç¼–è¯‘æœŸé—´è‡ªåŠ¨ç”Ÿæˆç›¸åº”çš„ Module_XX å’Œ Environment_XX é™æ€å¸¸é‡ã€‚&lt;/br&gt; * ä¾‹å¦‚ï¼šé€šè¿‡ EnvironmentSwitcher.MODULE_APP å°±å¯ä»¥èŽ·å–åˆ° App æ¨¡å—ä¸‹ç›¸åº”çš„æ‰€æœ‰çŽ¯å¢ƒ&lt;/br&gt; */public class EnvironmentConfig &#123; /** * æ•´ä¸ª App çš„çŽ¯å¢ƒ */ @Module private class App &#123; @Environment(url = &quot;https://gank.io/api/&quot;, isRelease = true, alias = &quot;æ­£å¼&quot;) private String online; &#125; /** * ç‰¹æ®Šæ¨¡å— Music çš„çŽ¯å¢ƒ */ @Module(alias = &quot;éŸ³ä¹&quot;) private class Music &#123; @Environment(url = &quot;https://www.codexiaomai.top/api/&quot;, isRelease = true, alias = &quot;æ­£å¼&quot;) private String online; @Environment(url = &quot;http://test.codexiaomai.top/api/&quot;, alias = &quot;æµ‹è¯•&quot;) private String test; &#125; /** * ç‰¹æ®Šæ¨¡å— News çš„çŽ¯å¢ƒ */ @Module(alias = &quot;æ–°é—»&quot;) private class News &#123; @Environment(url = &quot;http://news/release/&quot;, isRelease = true, alias = &quot;æ­£å¼&quot;) private String release; @Environment(url = &quot;http://news/test/&quot;, alias = &quot;æµ‹è¯•&quot;) private String test; @Environment(url = &quot;http://news/test1/&quot;) private String test1; @Environment(url = &quot;http://news/sandbox/&quot;, alias = &quot;æ²™ç®±&quot;) private String sandbox; &#125;&#125; @Moduleè¢«å®ƒä¿®é¥°çš„ç±»æˆ–æŽ¥å£è¡¨ç¤ºä¸€ä¸ªæ¨¡å—ï¼Œç¼–è¯‘æ—¶ä¼šè‡ªåŠ¨ç”Ÿæˆç›¸åº”æ¨¡å—çš„ getXXEnvironment() å’Œ setXXEnvironment() æ–¹æ³•ã€‚ä¸€ä¸ªè¢« @Module ä¿®é¥°çš„ç±»ä¸­ï¼Œå¯ä»¥æœ‰ n (n&gt;0) ä¸ªè¢« @Environment ä¿®é¥°çš„å±žæ€§ï¼Œè¡¨ç¤ºè¯¥æ¨¡å—ä¸­æœ‰ n ç§çŽ¯å¢ƒã€‚ ä¾‹å¦‚ï¼šä¸Šé¢çš„ä»£ç ä¸­ï¼Œæœ‰ä¸‰ä¸ªç±»è¢« @Module ä¿®é¥°ï¼Œæ„å‘³ç€æœ‰ä¸‰ä¸ªæ¨¡å—ï¼Œå…¶ä¸­ App æ¨¡å—ä¸­ï¼Œåªæœ‰ä¸€ä¸ªå±žæ€§è¢« @Environment ä¿®é¥°ï¼Œè¡¨ç¤ºè¯¥æ¨¡å—åªæœ‰ä¸€ç§çŽ¯å¢ƒï¼›è€Œ Music å’Œ News æ¨¡å—åˆ†åˆ«æœ‰ 2 ç§å’Œ 4 ç§çŽ¯å¢ƒã€‚ æ­¤å¤– @Module è¿˜æœ‰ä¸€ä¸ªå¯é€‰å±žæ€§ alias ï¼Œç”¨æ¥æŒ‡å®šè¯¥æ¨¡å—çš„åˆ«åã€‚è¯¥å€¼é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ã€‚è¿™ä¸ªå±žæ€§çš„ä¸»è¦ç›®çš„æ˜¯åœ¨åˆ‡æ¢çŽ¯å¢ƒ UI é¡µé¢æ˜¾ç¤ºä¸­æ–‡åç§°ã€‚ä¾‹å¦‚ï¼šMusic å’Œ News æ¨¡å—åœ¨åˆ‡æ¢çŽ¯å¢ƒé¡µé¢ä¸­å°±ä¼šåˆ†åˆ«æ˜¾ç¤º â€œéŸ³ä¹â€ å’Œ â€œæ–°é—»â€ã€‚ æ³¨ï¼šå¦‚æžœä½ çš„é¡¹ç›®ä¸­æ‰€æœ‰æ¨¡å—å…±ç”¨åŒä¸€ä¸ª Host åœ°å€ï¼Œé‚£ä¹ˆåªéœ€é…ç½®ä¸€ä¸ª Module å°±å¯ä»¥äº†ã€‚ @Environmentè¢«å®ƒä¿®é¥°çš„å±žæ€§è¡¨ç¤ºä¸€ä¸ªçŽ¯å¢ƒï¼Œå¿…é¡»æŒ‡å®š url çš„å€¼ï¼Œæ­¤å¤–è¿˜æœ‰ä¸¤ä¸ªå¯é€‰å±žæ€§ï¼šisRelease å’Œ aliasã€‚ isRelease æ˜¯ä¸€ä¸ª boolean åž‹çš„å±žæ€§ï¼Œé»˜è®¤ä¸º falseï¼Œå½“å€¼ä¸º true æ—¶ï¼Œå®ƒå°±æ˜¯æ‰€åœ¨ Module çš„é»˜è®¤çŽ¯å¢ƒï¼Œä»¥åŠ App æ­£å¼å‘å¸ƒæ—¶çš„çŽ¯å¢ƒã€‚ä¸€ä¸ª Module ä¸­å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€ä¸ª Environment çš„ isRelease çš„å€¼ä¸º trueï¼Œå¦åˆ™ç¼–è¯‘ä¼šå¤±è´¥ã€‚ ä¾‹å¦‚ï¼šMusic æ¨¡å—ä¸­æœ‰ä¸¤ç§çŽ¯å¢ƒåˆ†åˆ«æ˜¯ onlineï¼ˆæ­£å¼ï¼‰å’Œ test ï¼ˆæµ‹è¯•ï¼‰ï¼Œå› ä¸º online çš„ isRelease = trueï¼Œæ‰€ä»¥å®ƒå°±æ˜¯é»˜è®¤çŽ¯å¢ƒå’ŒApp æ­£å¼å‘å¸ƒæ—¶çš„çŽ¯å¢ƒã€‚ alias å’Œ @Module ä¸­çš„ alias ç›¸ä¼¼ï¼Œç”¨äºŽåœ¨åˆ‡æ¢çŽ¯å¢ƒçš„UIé¡µé¢å±•ç¤ºè¯¥çŽ¯å¢ƒçš„åå­—ï¼Œè¯¥å€¼é»˜è®¤ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œå¦‚æžœç»™å®ƒæŒ‡å®šéžç©ºå­—ç¬¦ä¸²ï¼Œåˆ™çŽ¯å¢ƒçš„åå­—å°±è¢«æŒ‡å®šä¸º alias çš„å€¼ã€‚ å†æ¬¡å¼ºè°ƒï¼šä¸€ä¸ª Module ä¸­å¿…é¡»æœ‰ä¸”åªæœ‰ä¸€ä¸ª Environment çš„ isRelease çš„å€¼ä¸º trueï¼Œå¦åˆ™ç¼–è¯‘ä¼šå¤±è´¥ã€‚ ç‚¹å‡»èœå•æ ä¸­çš„ â€œBuildâ€ -&gt; â€œRebuild Projectâ€ï¼Œç­‰å¾…ç¼–è¯‘å®Œæˆã€‚åˆ°è¿™é‡Œæ•´ä¸ªé…ç½®å°±ç®—å®Œæˆäº†ï¼ŒæŽ¥ä¸‹æ¥å°±å¯ä»¥åœ¨é¡¹ç›®ä¸­æ„‰å¿«çš„èŽ·å–ç›¸åº”æ¨¡å—çš„çŽ¯å¢ƒåœ°å€äº†ã€‚ æ·»åŠ å…¥å£æ‰‹åŠ¨åˆ‡æ¢çŽ¯å¢ƒå½“ç„¶è¦æœ‰ä¸€ä¸ªé¡µé¢ï¼Œè¿™ä¸ªé¡µé¢ Environment Switcher å·²ç»è‡ªåŠ¨é›†æˆäº†ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ªå…¥å£è·³è½¬å³å¯ï¼ˆè¿™ä¸ªå…¥å£åªåœ¨ Debug æµ‹è¯•ç­‰å†…éƒ¨ç‰ˆæ˜¾ç¤ºï¼‰ã€‚ ä¾‹å¦‚ï¼šåœ¨â€œæˆ‘çš„â€é¡µé¢ä¸­ã€‚ 1234567891011121314151617@Overrideprotected void onCreate(@Nullable Bundle savedInstanceState) &#123; ... if (!BuildConfig.DEBUG) &#123; // only show in debug findViewById(R.id.bt_switch_environment).setVisibility(View.GONE); return; &#125; findViewById(R.id.bt_switch_environment).setOnClickListener(new View.OnClickListener() &#123; @Override public void onClick(View view) &#123; // entrance of switch environment EnvironmentSwitchActivity.launch(getContext()); &#125; &#125;);&#125; ä½ å¯ä»¥ä½¿ç”¨ Environment Switcher å·²ç»æä¾›çš„ EnvironmentSwitchActivity.launch(getContext()) æ–¹æ³•å¯åŠ¨ï¼›å½“ç„¶ä½ ä¹Ÿå¯ä»¥é€šè¿‡ startActivity(new Intent(getContext(), EnvironmentSwitchActivity.class)) å¯åŠ¨ï¼Œçœ‹ä¸ªäººå–œå¥½äº†ã€‚ èŽ·å–ç›¸åº”æ¨¡å—çš„çŽ¯å¢ƒåœ°å€ï¼š123String appEnvironment = EnvironmentSwitcher.getAppEnvironment(this, BuildConfig.DEBUG);String musicEnvironment = EnvironmentSwitcher.getMusicEnvironment(this, BuildConfig.DEBUG);String newsEnvironment = EnvironmentSwitcher.getNewsEnvironment(this, BuildConfig.DEBUG); èŽ·å–ç›¸åº”æ¨¡å—çš„çŽ¯å¢ƒå®žä½“ç±»(since 1.4)ï¼š123EnvironmentBean appEnvironmentBean = EnvironmentSwitcher.getAppEnvironmentBean(this, BuildConfig.DEBUG);EnvironmentBean musicEnvironmentBean = EnvironmentSwitcher.getMusicEnvironmentBean(this, BuildConfig.DEBUG);EnvironmentBean newsEnvironmentBean = EnvironmentSwitcher.getNewsEnvironmentBean(this, BuildConfig.DEBUG); è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯èŽ·å–ç›¸åº”æ¨¡å—çš„åœ°å€éœ€è¦ä¸¤ä¸ªå‚æ•°ã€‚ ç¬¬ä¸€ä¸ªå°±æ˜¯ä¸€ä¸ª Context ä¸ç”¨è§£é‡Šï¼Œå› ä¸º Environment Switcher æ˜¯ç”¨ SharedPreferences è¿›è¡Œå­˜å‚¨æ•°æ®çš„ã€‚ ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸€ä¸ª boolean åž‹çš„å€¼ï¼Œå¦‚æžœä¸º true è¡¨ç¤ºå½“å‰ä¸º Debug æˆ–æµ‹è¯•ç­‰å†…éƒ¨ä½¿ç”¨ç‰ˆæœ¬ï¼Œæ­¤æ—¶èŽ·å–åˆ°çš„åœ°å€æ˜¯æˆ‘ä»¬æ‰‹åŠ¨åˆ‡æ¢ä¿å­˜çš„åœ°å€ï¼›è€Œå¦‚æžœä¸º false è¡¨ç¤ºå½“å‰ä¸ºè¦å‘å¸ƒç»™ç”¨æˆ·ä½¿ç”¨çš„ç‰ˆæœ¬ï¼Œæ­¤æ—¶èŽ·å–åˆ°çš„åœ°å€ä¸ºæˆ‘ä»¬åœ¨ @Environment ä¸­æŒ‡å®š isRelease = true çš„åœ°å€ï¼Œæ‰‹åŠ¨åˆ‡æ¢çš„çŽ¯å¢ƒåœ°å€ä¸å†ç”Ÿæ•ˆã€‚ æ·»åŠ ç›‘å¬äº‹ä»¶Environment Switcher æ”¯æŒåˆ‡æ¢çŽ¯å¢ƒå›žè°ƒï¼Œä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹æ³•æ·»åŠ ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸è¦å¿˜è®°åœ¨ä¸éœ€è¦ç›‘å¬çŽ¯å¢ƒåˆ‡æ¢äº‹ä»¶æ—¶ç§»é™¤ç›‘å¬äº‹ä»¶ã€‚ 123456789101112131415161718192021222324public class MainActivity extends AppCompatActivity implements OnEnvironmentChangeListener&#123; private static final String TAG = &quot;MainActivity&quot;; @Override protected void onCreate(@Nullable Bundle savedInstanceState) &#123; super.onCreate(savedInstanceState); // æ·»åŠ ç›‘å¬äº‹ä»¶ EnvironmentSwitcher.addOnEnvironmentChangeListener(this); &#125; @Override public void onEnvironmentChanged(ModuleBean module, EnvironmentBean oldEnvironment, EnvironmentBean newEnvironment) &#123; Log.e(TAG, module.getName() + &quot;ç”±&quot; + oldEnvironment.getName() + &quot;çŽ¯å¢ƒï¼ŒUrl=&quot; + oldEnvironment.getUrl() + &quot;,åˆ‡æ¢ä¸º&quot; + newEnvironment.getName() + &quot;çŽ¯å¢ƒï¼ŒUrl=&quot; + newEnvironment.getUrl()); &#125; @Override protected void onDestroy() &#123; super.onDestroy(); // ç§»é™¤ç›‘å¬äº‹ä»¶ EnvironmentSwitcher.removeOnEnvironmentChangeListener(this); &#125;&#125; åˆ‡æ¢SDKå¼€å‘çŽ¯å¢ƒæˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä¸€èˆ¬ä¼šä¾èµ–ç¬¬ä¸‰æ–¹æä¾›çš„SDKï¼Œè€Œä¸”è¿™äº›SDKä¹Ÿä¼šæä¾›æµ‹è¯•çŽ¯å¢ƒï¼Œå¦‚æžœè¦åœ¨Appå†…åˆ‡æ¢çŽ¯å¢ƒï¼Œä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•å°±ä¸è¡Œäº†ã€‚é‚£è¯¥æ€Žä¹ˆåŠžå‘¢ï¼Ÿ ä¾‹å¦‚æˆ‘ä»¬çš„â€œç›´æ’­â€æ¨¡å—æ˜¯å¼•ç”¨çš„SDKï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š é¦–å…ˆåœ¨ EnvironmentConfig.java ä¸­é…ç½®â€ç›´æ’­â€æ¨¡å— 12345678910public class EnvironmentConfig &#123; @Module(alias = &quot;ç›´æ’­&quot;) private class Live &#123; @Environment(url = &quot;online&quot;, isRelease = true, alias = &quot;æ­£å¼&quot;) private String online; @Environment(url = &quot;test&quot;, alias = &quot;æµ‹è¯•&quot;) private String test; &#125;&#125; url åœ¨è¿™é‡Œåªæ˜¯ç”¨æ¥åŒºåˆ†çŽ¯å¢ƒï¼Œä¸ç”¨ä¸ºçœŸå®žçš„ urlï¼Œä½†è¦ä¿è¯åŒä¸€æ¨¡å—ä¸­æ¯ä¸ªçŽ¯å¢ƒçš„ url ä¸åŒã€‚ åœ¨ Application ä¸­æ·»åŠ ç›‘å¬ 123456789101112EnvironmentSwitcher.addOnEnvironmentChangeListener(new OnEnvironmentChangeListener() &#123; @Override public void onEnvironmentChanged(ModuleBean module, EnvironmentBean oldEnvironment, EnvironmentBean newEnvironment) &#123; if (module.equals(EnvironmentSwitcher.MODULE_LIVE)) &#123; if (newEnvironment.equals(EnvironmentSwitcher.LIVE_ONLINE_ENVIRONMENT)) &#123; // è°ƒç”¨ SDK åˆ‡æ¢çŽ¯å¢ƒçš„æ–¹æ³•ï¼Œæ­£å¼çŽ¯å¢ƒ &#125; else if (newEnvironment.equals(EnvironmentSwitcher.LIVE_TEST_ENVIRONMENT)) &#123; // è°ƒç”¨ SDK åˆ‡æ¢çŽ¯å¢ƒçš„æ–¹æ³•ï¼Œæµ‹è¯•çŽ¯å¢ƒ &#125; &#125; &#125;&#125;); åˆ©ç”¨ Environment Switcher çš„çŽ¯å¢ƒåˆ‡æ¢å›žè°ƒï¼Œå®žçŽ°åˆ‡æ¢ SDK çŽ¯å¢ƒã€‚ å¥½äº†ï¼Œå…³äºŽEnvironment Switcher çš„ä»‹ç»å°±åˆ°æ­¤ä¸ºæ­¢å§ï¼Œæ›´å¤šä½¿ç”¨ä»‹ç»å¯å‚è€ƒDemoï¼ŒDemo ä¸­æœ‰ Environment Switcher ç»“åˆ Retrofit ä½¿ç”¨çš„è¯¦ç»†å®žçŽ°è¿‡ç¨‹ã€‚]]></content>
      <categories>
        <category>å¼€æº</category>
      </categories>
      <tags>
        <tag>å¼€æº</tag>
        <tag>EnvironmentSwitcher</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ConcurrentModificationException å¼‚å¸¸åˆ†æžä¸Žè§£å†³æ–¹æ³•]]></title>
    <url>%2Fposts%2F9041b2de.html</url>
    <content type="text"><![CDATA[æœ¬æ–‡ä¸»è¦ä»Žæºç çš„è§’åº¦åˆ†æž ConcurrentModificationException å‘ç”Ÿçš„åŽŸå› ï¼Œä»¥åŠè§£å†³åŠžæ³•ã€‚ éœ€æ±‚ä¸Žå®žçŽ°éœ€æ±‚ï¼šä»Žä¸€ä¸ªé›†åˆä¸­æ‰¾å‡ºæŒ‡å®šçš„å…ƒç´ å¹¶å°†å…¶åˆ é™¤ã€‚ é—®é¢˜ä»£ç ï¼š 1234567891011121314ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;list.forEach(new Consumer&lt;Integer&gt;() &#123; @Override public void accept(Integer integer) &#123; if (integer == 5) &#123; list.remove(integer); &#125; &#125;&#125;); å¼‚å¸¸å †æ ˆï¼š 12345Exception in thread "main" java.util.ConcurrentModificationException at java.util.ArrayList.forEach(ArrayList.java:1260) ...Process finished with exit code 1 åŽŸå› æŽ’æŸ¥ä»Žå¼‚å¸¸çš„å †æ ˆä¿¡æ¯ä¸­å¯ä»¥çœ‹å‡ºï¼Œåœ¨ ArrayList çš„ forEach() æ–¹æ³•ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œé‚£å°±å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•ã€‚ 1234567891011121314151617public void forEach(Consumer&lt;? super E&gt; action) &#123; Objects.requireNonNull(action); final int expectedModCount = modCount; @SuppressWarnings("unchecked") final E[] elementData = (E[]) this.elementData; final int size = this.size; // å¾ªçŽ¯ä½“å†…ä»£ç æ‰§è¡Œéœ€è¦æ»¡è¶³çš„æ¡ä»¶æœ‰ä¸¤ä¸ªï¼š // 1. modCount == expectedModCount // 2. i &lt; size for (int i=0; modCount == expectedModCount &amp;&amp; i &lt; size; i++) &#123; action.accept(elementData[i]); &#125; if (modCount != expectedModCount) &#123; throw new ConcurrentModificationException(); &#125;&#125; ç»è¿‡å¯¹ forEach() æ–¹æ³•çš„æºç åˆ†æžï¼Œå‘çŽ° modCount != expectedModCount ä¼šå¯¼è‡´ for å¾ªçŽ¯é€€å‡ºï¼Œå¹¶ä¸”æŠ›å‡º ConcurrentModificationExceptionã€‚ ä»Žç¬¬ 3 è¡Œä»£ç  final int expectedModCount = modCount ä¸­å¯ä»¥çŸ¥é“ï¼Œåˆå§‹çŠ¶æ€ expectedModCount å’Œ modCount çš„å€¼æ˜¯ç›¸ç­‰çš„ï¼Œé‚£ä¹ˆæ˜¯ä»€ä¹ˆåŽŸå› å¯¼è‡´å®ƒä»¬çš„å€¼ä¸ç›¸ç­‰è¿›è€ŒæŠ›å‡ºå¼‚å¸¸çš„å‘¢ï¼Ÿ åŽŸå› æ˜¯ ArrayList çš„ä¿®æ”¹æ“ä½œï¼ˆremove æˆ– addï¼‰ä¼šå¯¼è‡´ modCount çš„å€¼å‘ç”Ÿå˜åŒ–ã€‚è¿™é‡Œä»¥ remove æ–¹æ³•ä¸ºä¾‹è¿›è¡Œåˆ†æžè¯æ˜Žï¼š 12345678910111213141516public boolean remove(Object o) &#123; if (o == null) &#123; for (int index = 0; index &lt; size; index++) if (elementData[index] == null) &#123; fastRemove(index); return true; &#125; &#125; else &#123; for (int index = 0; index &lt; size; index++) if (o.equals(elementData[index])) &#123; fastRemove(index); return true; &#125; &#125; return false;&#125; è¯»å®Œä¸Šé¢çš„æºç ä¼šå‘çŽ° remove æ–¹æ³•å¹¶æ²¡æœ‰ä¿®æ”¹ modCount çš„å€¼å•Šã€‚åˆ«ç€æ€¥ï¼Œå†ä»”ç»†è§‚å¯Ÿä¼šå‘çŽ°æ— è®ºæ€Žæ ·ï¼Œæœ€ç»ˆä¼šæ‰§è¡Œ fastRemove æ–¹æ³•ã€‚å†æ¥çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®žçŽ°ï¼š 123456789private void fastRemove(int index) &#123; // ä¿®æ”¹ modCount modCount++; int numMoved = size - index - 1; if (numMoved &gt; 0) System.arraycopy(elementData, index+1, elementData, index, numMoved); elementData[--size] = null; // clear to let GC do its work&#125; è¿™æ¬¡æ²¡é”™äº†å§ã€‚ æ‰€ä»¥åœ¨ forEach() æ–¹æ³•ä¸­ä½¿ç”¨ ArrayList.remove() åˆ é™¤å…ƒç´ ä¼šæŠ›å‡ºå¼‚å¸¸çš„åŽŸå› æ˜¯ï¼šç”±äºŽ ArrayList æ‰§è¡Œ remove æ–¹æ³•åŽï¼ŒmodCount çš„å€¼åŠ  1ï¼Œå½“ forEach ä¸­çš„å¾ªçŽ¯æ£€æŸ¥ä¸¤ä¸ªæ¡ä»¶æ—¶ï¼Œä¼šå›  modCount == expectedModCount ä¸æˆç«‹å¯¼è‡´ for å¾ªçŽ¯é€€å‡ºï¼Œè¿›è€ŒæŠ›å‡º ConcurrentModificationException å¼‚å¸¸ã€‚ ç”±æ­¤å¯è§ï¼ŒforEach å¾ªçŽ¯åªé€‚ç”¨äºŽå¯¹ ArrayList çš„éåŽ†ï¼Œä½†æ˜¯ä¸å¯ä»¥å¯¹ ArrayList è¿›è¡Œæ·»åŠ æˆ–åˆ é™¤æ“ä½œï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸ã€‚ çŽ°åœ¨é—®é¢˜çš„åŽŸå› æ‰¾åˆ°äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬åº”è¯¥æ€Žä¹ˆè§£å†³å‘¢ï¼Ÿ è§£å†³åŠžæ³•æ–¹æ³•ä¸€ï¼šä½¿ç”¨æ™®é€šçš„ for å¾ªçŽ¯1234567891011ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;for (int i = 0; i &lt; list.size(); i++) &#123; if (i == 5) &#123; list.remove(i); &#125;&#125; è¿è¡Œä»£ç ï¼Œå‘çŽ°æ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ã€‚é—®é¢˜è§£å†³ï¼ ä½†æ˜¯ï¼Œå¦‚æžœéœ€æ±‚æ”¹ä¸ºåˆ é™¤æ‰€æœ‰å…ƒç´ å‘¢ï¼Ÿ 12345678910111213ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;for (int i = 0; i &lt; list.size(); i++) &#123; list.remove(i);&#125;int size = list.size();System.out.println("æ‰§è¡Œå®Œæ¯• list.size() = " + size); å…ˆçŒœä¸€ä¸‹è¿è¡Œç»“æžœæ˜¯ä»€ä¹ˆï¼Œå†å¾€ä¸‹çœ‹ã€‚ â€”â€”â€“ è¿™é‡Œæ˜¯åˆ†éš”çº¿ï¼ˆè¿™é‡Œå…ˆæ’æ’­ä¸€æ¡å¹¿å‘Šï¼Œå¹¿å‘Šä¹‹åŽæ›´åŠ ç²¾å½©ï¼å“ˆå“ˆï¼ï¼ï¼ï¼‰â€”â€”â€”â€” ä½ è¿˜åœ¨ä¸ºå¼€å‘ä¸­é¢‘ç¹åˆ‡æ¢çŽ¯å¢ƒæ‰“åŒ…è€Œçƒ¦æ¼å—ï¼Ÿå¿«æ¥è¯•è¯• Environment Switcher å§ï¼ä½¿ç”¨å®ƒå¯ä»¥åœ¨appè¿è¡Œæ—¶ä¸€é”®åˆ‡æ¢çŽ¯å¢ƒï¼Œè€Œä¸”è¿˜æ”¯æŒå…¶ä»–è´´å¿ƒå°åŠŸèƒ½ï¼Œæœ‰äº†å®ƒå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒé¢‘ç¹çŽ¯å¢ƒåˆ‡æ¢äº†ã€‚https://github.com/CodeXiaoMai/EnvironmentSwitcherç›®å‰è¯¥é¡¹ç›®å·²ç»è¾¾æˆå¦‚ä¸‹æˆå°±ï¼š â€”â€”â€”â€”â€”â€”- è¿™é‡Œæ˜¯åˆ†éš”çº¿ï¼ˆå¹¿å‘Šç»“æŸï¼Œç²¾å½©ç»§ç»­ï¼ï¼ï¼ï¼‰â€”â€”â€”â€”â€”â€”â€“ å¥½äº†ï¼Œå›žå½’æ­£é¢˜ä½ çŒœå‡ºç»“æžœäº†å—ï¼Ÿçœ‹çœ‹ä½ çŒœçš„å¯¹ä¸‹å¯¹ã€‚ è¿è¡Œç»“æžœä¸ºï¼š 1æ‰§è¡Œå®Œæ¯• list.size() = 5 å’¦ï¼Ÿæ˜Žæ˜Žæ˜¯éåŽ† list çš„æ¯ä¸ªå…ƒç´ å¹¶æŠŠå®ƒä»¬åˆ é™¤ï¼Œä¸ºä»€ä¹ˆæœ€åŽè¿˜æœ‰ 5 ä¸ªå…ƒç´ å‘¢ï¼Ÿ è¿™æ˜¯å› ä¸º ArrayList å†…éƒ¨ä½¿ç”¨æ•°ç»„å­˜å‚¨æ•°æ®ï¼Œ10 ä¸ªå…ƒç´ ä¾æ¬¡å­˜å‚¨åœ¨æ•°ç»„çš„ç¬¬ 0 ä¸ªä½ç½®å¼€å§‹åˆ°ç¬¬ 9 ä¸ªä½ç½®ï¼Œå½“ä¸­é—´æœ‰ä¸€ä¸ªå…ƒç´ åˆ é™¤æ—¶ï¼ŒåŽé¢çš„æ‰€æœ‰å…ƒç´ ä¼šå‘å‰ç§»åŠ¨ï¼Œä¿è¯ä¸­é—´æ²¡æœ‰ç©ºä½™ã€‚æ‰€ä»¥å½“ç¬¬ 0 ä¸ªä½ç½®çš„å…ƒç´ åˆ é™¤å®Œæ¯•åŽï¼Œæœ¬æ¥åœ¨ç¬¬ 1 ä¸ªä½ç½®çš„å…ƒç´ å˜æˆç¬¬ 0 ä¸ªå…ƒç´ ï¼Œä½†ç”±äºŽ i++ åŽ i = 1ï¼Œä¸‹æ¬¡æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ä¼šåˆ é™¤æœ€æ–°çš„ç¬¬ 1 ä¸ªä½ç½®çš„å…ƒç´ ï¼Œè€Œç¬¬ 0 ä¸ªä½ç½®çš„å…ƒç´ å› è¢«è·³è¿‡è€Œä¸ä¼šè¢«åˆ é™¤ï¼ŒåŒç†å½“åŽé¢çš„å…ƒç´ è¢«åˆ é™¤æ—¶ä¹Ÿä¼šæœ‰è·³è¿‡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆæœ€ç»ˆä¼šæœ‰ 5 ä¸ªå…ƒç´ çš„åŽŸå› ã€‚ æ‰€ä»¥å¦‚æžœåªæ˜¯åœ¨éåŽ† ArrayList çš„åŒæ—¶åˆ é™¤æŒ‡å®šçš„å…ƒç´ åŽå¹¶é€€å‡ºå¾ªçŽ¯ï¼Œè¿™æ ·æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºåˆ é™¤å…ƒç´ åŽï¼Œä¸ä¼šè¿›è¡Œå…¶ä»–æ“ä½œã€‚ä½†æ˜¯å¦‚æžœåˆ é™¤æ‰€æœ‰å…ƒç´ ï¼Œå°±éœ€è¦åšä¸€äº›ç‰¹æ®Šçš„å¤„ç†äº†ï¼Œå…·ä½“å¤„ç†å¦‚ä¸‹ï¼š 1234for (int i = 0; i &lt; list.size(); i++) &#123; list.remove(i); i--;&#125; æ–¹æ³•äºŒï¼šä½¿ç”¨ Iterator12345678910111213ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;Iterator&lt;Integer&gt; iterator = list.iterator();while (iterator.hasNext()) &#123; if (iterator.next() == 5) &#123; iterator.remove(); &#125;&#125; å¦‚æžœè¦åˆ é™¤æ‰€æœ‰å…ƒç´ å‘¢ï¼Ÿ 123456789101112ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;Iterator&lt;Integer&gt; iterator = list.iterator();while (iterator.hasNext()) &#123; iterator.next(); iterator.remove();&#125; è¿è¡Œç»“æžœï¼š 1æ‰§è¡Œå®Œæ¯• list.size() = 0 ä»Žè¿è¡Œç»“æžœå¯ä»¥çŸ¥é“ï¼Œç¨‹åºæ­£å¸¸è¿è¡Œè€Œä¸”å®Œå…¨ç¬¦åˆé¢„æœŸã€‚ä¸ºä»€ä¹ˆä½¿ç”¨ Iterator å¯ä»¥æ­£å¸¸éåŽ†å¹¶ä¸”åˆ é™¤æ‰€æœ‰å…ƒç´ å‘¢ï¼Ÿä¸‹é¢ä»Žæºç çš„è§’åº¦åˆ†æžï¼š é¦–å…ˆçœ‹ï¼Œlist.iterator() çš„å®žçŽ°ï¼š 123public Iterator&lt;E&gt; iterator() &#123; return new Itr();&#125; è¿™ä¸ªæ–¹æ³•åˆ›å»ºå¹¶è¿”å›žä¸€ä¸ª Itr ç±»çš„å®žä¾‹ã€‚é€šè¿‡æŸ¥çœ‹æºç å¯ä»¥å‘çŽ° Itr å®žçŽ°äº† Iterator æŽ¥å£ï¼Œè¿™ä¸æ­£æ˜¯æˆ‘ä»¬éœ€è¦çš„å—ï¼ŸæŽ¥ä¸‹æ¥ä¾æ¬¡çœ‹ iterator.hasNext()ã€iterator.next() ä»¥åŠ iterator.remove() æ–¹æ³•ï¼šï¼ˆå‰æ–¹é«˜èƒ½ï¼Œè¯·æ³¨æ„å‡†å¤‡å¥½è„‘å­ï¼ï¼ï¼ï¼‰ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960private class Itr implements Iterator&lt;E&gt; &#123; int cursor; // index of next element to return int lastRet = -1; // index of last element returned; -1 if no such int expectedModCount = modCount; // å› ä¸º Itr æ˜¯ ArrayList çš„å†…éƒ¨ç±»ï¼Œæ‰€ä»¥å¯ä»¥ç›´æŽ¥è®¿é—® ArrayList çš„ modCountã€‚ Itr() &#123;&#125; public boolean hasNext() &#123; // å¦‚æžœå½“å‰ cursor ä¸æŒ‡å‘æœ€åŽä¸€ä¸ªå…ƒç´ åŽé¢çš„ç´¢å¼•ä½ç½®ï¼Œ // è¯´æ˜Žå½“å‰ cursor æ‰€åœ¨ä½ç½®åŽé¢è¿˜æœ‰æ²¡æœ‰éåŽ†åˆ°çš„å…ƒç´ ï¼Œè¿”å›ž trueã€‚ return cursor != size; // å› ä¸º Itr æ˜¯ ArrayList çš„å†…éƒ¨ç±»ï¼Œæ‰€ä»¥å¯ä»¥ç›´æŽ¥è®¿é—® ArrayList çš„ sizeã€‚ &#125; /** * é¦–å…ˆæ£€æŸ¥ modCount == expectedModCount æ˜¯å¦æˆç«‹ï¼Œ * å¦‚æžœä¸æˆç«‹ç›´æŽ¥æŠ›å‡º ConcurrentModificationExceptionï¼› * å¦åˆ™æŒ‰ä¸‹é¢çš„é€»è¾‘è¿è¡Œï¼š * è¿”å›žå½“å‰ cursor æ‰€åœ¨ä½ç½®çš„å…ƒç´ ï¼Œ * lastRet çš„å€¼æ›´æ–°ä¸ºå½“å‰ cursor çš„å€¼ï¼Œ * cursor çš„å€¼åŠ  1ï¼Œå³æŒ‡å‘ä¸‹æ¬¡è¦è®¿é—®çš„å…ƒç´ ä½ç½®ã€‚ */ @SuppressWarnings("unchecked") public E next() &#123; checkForComodification(); int i = cursor; if (i &gt;= size) throw new NoSuchElementException(); Object[] elementData = ArrayList.this.elementData; if (i &gt;= elementData.length) throw new ConcurrentModificationException(); cursor = i + 1; return (E) elementData[lastRet = i]; &#125; final void checkForComodification() &#123; if (modCount != expectedModCount) throw new ConcurrentModificationException(); &#125; /** * ä¸Žç›´æŽ¥ä½¿ç”¨ ArrayList çš„ remove() æ–¹æ³•ä¸åŒçš„æ˜¯ï¼Œ * è¯¥æ–¹æ³•ä¼šæ›´æ–° expectedModCount çš„å€¼ä¸º modCountã€‚ * è¿™ä¹Ÿæ­£æ˜¯ä¸ºä»€ä¹ˆé€šè¿‡ List.iterator() éåŽ†çš„åŒæ—¶è¿›è¡Œ * iterator().remove() æ“ä½œï¼Œä¸ä¼šå‘é€å¼‚å¸¸çš„åŽŸå› ã€‚ */ public void remove() &#123; if (lastRet &lt; 0) throw new IllegalStateException(); checkForComodification(); try &#123; ArrayList.this.remove(lastRet); cursor = lastRet; lastRet = -1; expectedModCount = modCount; &#125; catch (IndexOutOfBoundsException ex) &#123; throw new ConcurrentModificationException(); &#125; &#125;&#125; æ€»ç»“ï¼š ä½¿ç”¨ List.iterator() éåŽ†é›†åˆçš„åŒæ—¶è¿›è¡Œ iterator().remove() æ“ä½œï¼Œä¸ä¼šå‘é€å¼‚å¸¸çš„åŽŸå› æ˜¯ï¼šIterator.remove() ä¼šåœ¨æ‰§è¡Œ ArrayList çš„ remove() åŽï¼Œé‡æ–°å°† expectedModCount çš„å€¼æ›´æ–°ä¸º modCount çš„å€¼ã€‚è¿™æ ·è¿è¡Œ checkForComodification() æ–¹æ³•æ—¶ï¼Œæ‰ä¼šæ­£å¸¸è¿è¡Œã€‚ æ–¹æ³•ä¸‰ï¼šä½¿ç”¨å¢žå¼º for å¾ªçŽ¯å¢žå¼º for å¾ªçŽ¯æ˜¯è¿­ä»£å™¨çš„ç®€åŒ–ä¹¦å†™æ ¼å¼ï¼Œå’Œ iterator éåŽ†çš„æ•ˆæžœæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±è¯´å¢žå¼º for å¾ªçŽ¯çš„å†…éƒ¨ä¹Ÿå°±æ˜¯è°ƒç”¨ iterator å®žçŽ°çš„ï¼Œåªä¸è¿‡èŽ·å–è¿­ä»£å™¨ç”± jvm å®Œæˆï¼Œä¸éœ€è¦æˆ‘ä»¬èŽ·å–è¿­ä»£å™¨è€Œå·²ã€‚ä½†æ˜¯å¢žå¼º for å¾ªçŽ¯æœ‰äº›ç¼ºç‚¹ï¼Œä¾‹å¦‚ä¸èƒ½åœ¨å¢žå¼º for å¾ªçŽ¯é‡ŒåŠ¨æ€çš„åˆ é™¤é›†åˆå†…å®¹ï¼ˆè™½ç„¶å†…éƒ¨ä¹Ÿä½¿ç”¨äº† Iterator ä½†åœ¨åˆ é™¤æ—¶å› ä¸ºæ‹¿ä¸åˆ° Iteratorï¼Œæ‰€ä»¥ä¸èƒ½é€šè¿‡ Iterator åˆ é™¤ï¼‰ã€ä¸èƒ½èŽ·å–ä¸‹æ ‡ç­‰ã€‚ æ‰€ä»¥è¿™ç§æ–¹å¼åªé€‚ç”¨äºŽåˆ é™¤ä¸€ä¸ªæŒ‡å®šå…ƒç´ åŽï¼Œç«‹å³é€€å‡ºå¾ªçŽ¯çš„æƒ…å†µã€‚ 123456789101112ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();for (int i = 0; i &lt; 10; i++) &#123; list.add(i);&#125;for (Integer integer : list) &#123; if (integer == 5) &#123; list.remove(integer); break; &#125;&#125; æ€»ç»“ç»è¿‡ä¸Šé¢å¯¹å¼‚å¸¸å‘ç”Ÿçš„åŽŸå› ä»¥åŠ 3 ç§è§£å†³åŠžæ³•çš„åˆ†æžï¼Œå¯ä»¥å¾—å‡ºä»¥ä¸‹ç»“è®ºï¼š åªè¦æ˜¯åœ¨éåŽ†æ—¶ç›´æŽ¥é€šè¿‡è°ƒç”¨ ArrayList.remove() ç§»é™¤å…ƒç´ éƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œæ™®é€šçš„ for å¾ªçŽ¯å’Œå¢žå¼º for å¾ªçŽ¯é€‚ç”¨äºŽåˆ é™¤ä¸€ä¸ªå…ƒç´ åŽå°±é€€å‡ºå¾ªçŽ¯ä½“ï¼›è€Œ forEach() å¾ªçŽ¯æ˜¯åšå†³ä¸å¯ä»¥æ‰§è¡Œåˆ é™¤æ“ä½œçš„ï¼ˆå› ä¸ºå®ƒæ˜¯ç¨‹åºå‘˜æ— æ³•æŽ§åˆ¶é€€å‡ºå¾ªçŽ¯çš„ï¼‰ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æœ€å®‰å…¨çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Iterator è¿›è¡ŒéåŽ†çš„åŒæ—¶ï¼Œå¹¶ä¸”å¿…é¡»ä½¿ç”¨ Iterator æä¾›çš„ remove() æ–¹æ³•è¿›è¡Œåˆ é™¤æ“ä½œã€‚ æ‰©å±•ä¸Šé¢åˆ†æžæ˜¯ remove() æ“ä½œï¼Œé‚£ add() æ“ä½œå‘¢ï¼Ÿ æŒ‰ç…§æ€è·¯åº”è¯¥ä¹Ÿæ˜¯ä½¿ç”¨ Iterator çš„ add ä¹‹ç±»çš„æ–¹æ³•ï¼Œä½†æ˜¯å½“æˆ‘ä»¬å†™ä»£ç çš„æ—¶å€™ä¼šå‘çŽ°ï¼Œå”‰ï¼Ÿå”‰ï¼Ÿå”‰ï¼Ÿå”‰ï¼Ÿæˆ‘ iterator ç‚¹ï¼Œiterator ç‚¹â€¦â€¦ ä¸ºä»€ä¹ˆæ²¡æœ‰ç‚¹å‡ºæ¥ add ä¹‹ç±»çš„æ–¹æ³•ï¼Ÿ è¿™æ˜¯å› ä¸º Iterator æŽ¥å£åªæä¾›äº† remove() æ–¹æ³•ï¼ŒF***Kï¼Œè¿™å¯è®©æˆ‘å¦‚ä½•æ˜¯å¥½ï¼Ÿåˆ«æ€¥ï¼ŒList æŽ¥å£è¿˜æä¾›äº†ä¸€ä¸ª listIterator() æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›žçš„å¯¹è±¡æ˜¯å¯ä»¥è¿›è¡Œ add æ“ä½œçš„ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€çœ‹ä¸‹é¢çš„ä»£ç ï¼š 123456789101112131415161718ArrayList&lt;Integer&gt; list = new ArrayList&lt;&gt;();// åˆå§‹åŒ– list ä¸­çš„å€¼ä¸º 0,2,4,6,8for (int i = 0; i &lt; 10; i += 2) &#123; list.add(i);&#125;ListIterator&lt;Integer&gt; iterator = list.listIterator();// åœ¨æ¯ä¸ªå…ƒç´ åŽé¢è¿½åŠ ä¸€ä¸ªæ¯”è‡ªå·±å¤§ 1 çš„å…ƒç´ while (iterator.hasNext()) &#123; Integer next = iterator.next(); iterator.add(next + 1);&#125;for (Integer integer : list) &#123; System.out.print(integer);&#125; è¿è¡Œç»“æžœï¼š 10123456789 é€šè¿‡æŸ¥çœ‹æºç ï¼Œå¯ä»¥å‘çŽ° list.listIterator() æ–¹æ³•å¦‚ä¸‹ï¼š 123public ListIterator&lt;E&gt; listIterator() &#123; return new ListItr(0);&#125; è¿™ä¸ªæ–¹æ³•è¿”å›žä¸€ä¸ª ListItr ç±»çš„å®žä¾‹ï¼Œå¹¶ä¸”è¿™ä¸ªç±»å®žçŽ°äº† ListIterator æŽ¥å£ã€‚ ListIterator æ˜¯ä¸€ä¸ªåœ¨ç»§æ‰¿äº† Iterator æŽ¥å£çš„åŒæ—¶åˆé¢å¤–æä¾›äº† add() ã€set() ç­‰æ–¹æ³•çš„æŽ¥å£ï¼Œå¦‚ä¸‹å›¾ã€‚ å†çœ‹ä¸€ä¸‹ ListItr è¿™ä¸ªç±»ï¼š 12345678910111213141516171819private class ListItr extends Itr implements ListIterator&lt;E&gt; &#123; ...... /** * åŒ Itr çš„ remove æ–¹æ³•ä¸€æ ·ï¼Œå…ˆåœ¨é›†åˆä¸­æ·»åŠ å…ƒç´ ï¼Œ * æœ€åŽå°† modCount çš„å€¼èµ‹ç»™ expectedModCount */ public void add(E e) &#123; checkForComodification(); try &#123; int i = cursor; ArrayList.this.add(i, e); cursor = i + 1; lastRet = -1; expectedModCount = modCount; &#125; catch (IndexOutOfBoundsException ex) &#123; throw new ConcurrentModificationException(); &#125; &#125;&#125; ListItr ä¸ä½†å®žçŽ°äº† ListIterator æŽ¥å£ï¼Œè€Œä¸”ç»§æ‰¿äº† Itr ç±»ï¼ˆä¸Šé¢å·²ç»åˆ†æžè¿‡ï¼‰ï¼Œä»Žæºç ä¸­å¯ä»¥å‘çŽ° ListItr å†…æ²¡æœ‰å®žçŽ° remove() æ–¹æ³•ï¼Œæ˜¾ç„¶è¿™æ˜¯ç›´æŽ¥å¤ç”¨å®ƒçš„çˆ¶ç±» Itr çš„ remove() æ–¹æ³•ã€‚ æ‰€ä»¥ï¼Œå¦‚æžœåœ¨éåŽ†çš„åŒæ—¶åªæ˜¯è¿›è¡Œ remove æ“ä½œï¼Œæ—¢å¯ä»¥ä½¿ç”¨ iterator ä¹Ÿå¯ä»¥ä½¿ç”¨ listIteratorï¼›è€Œè¦è¿›è¡Œ add æ“ä½œï¼Œå°±å¿…é¡»ä½¿ç”¨ listIterator äº†ã€‚ LinkedList å’Œ ArrayList ç•¥æœ‰ä¸åŒï¼Œè™½ç„¶å®ƒçš„ iterator() å’Œ listIterator() æ–¹æ³•è¿”å›žçš„æŽ¥å£ç±»åž‹ä¸åŒï¼Œä½†æ˜¯ä»”ç»†åˆ†æžæºç ä¼šå‘çŽ°å…¶å®žå†…éƒ¨éƒ½æ˜¯ ListItr å¯¹è±¡ã€‚]]></content>
      <categories>
        <category>Java</category>
        <category>é›†åˆ</category>
      </categories>
      <tags>
        <tag>é›†åˆ</tag>
        <tag>ConcurrentModificationException</tag>
        <tag>ArrayList</tag>
        <tag>LinkedList</tag>
      </tags>
  </entry>
</search>
